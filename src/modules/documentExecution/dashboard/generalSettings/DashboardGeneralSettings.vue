<template>
    <div class="dashboardEditor">
        <Toolbar class="kn-toolbar kn-toolbar--primary">
            <template #start> {{ $t('dashboard.generalSettings.title') }} </template>
            <template #end>
                <Button icon="pi pi-save" class="p-button-text p-button-rounded p-button-plain" @click="saveGeneralSettings" />
                <Button icon="pi pi-times" class="p-button-text p-button-rounded p-button-plain" @click="$emit('closeGeneralSettings')" />
            </template>
        </Toolbar>

        <div class="datasetEditor-container kn-overflow">
            <DashboardGeneralSettingsList :dashboard-model-prop="dashboardModel" @selected-option="setSelectedOption"></DashboardGeneralSettingsList>
            <DashboardVariables v-if="selectedOption === 'Variables'" :dashboard-id="dashboardId" :prop-variables="variables" :selected-datasets="selectedDatasets" :selected-datasets-columns-map="selectedDatasetColumnsMap" :profile-attributes="profileAttributes" />
            <DashboardInformation v-if="selectedOption === 'Information'" :dashboard-model-prop="dashboardModel" />
            <DashboardBackground v-if="selectedOption === 'Background'" :dashboard-model-prop="dashboardModel" />
            <MenuWidgets v-if="selectedOption === 'MenuWidgets'" :menu-widgets-config-prop="menuWidgetsConfig" />
            <CssEditor v-if="selectedOption === 'CSS'" :dashboard-model-prop="dashboardModel" />
            <DashboardThemes v-if="selectedOption === 'Themes'" :dashboard-model-prop="dashboardModel" />
            <WidgetEditor
                v-if="selectedOption === 'Custom Header' && customHeaderWidgetEditorVisible && customHeaderWidget"
                :dashboard-id="dashboardId"
                :datasets="datasets"
                :variables="variables"
                :prop-widget="customHeaderWidget"
                @widgetSaved="onCustomHeaderSaved"
                @close="onCustomHeaderCancel"
            ></WidgetEditor>
        </div>
    </div>
</template>
<script lang="ts">
import { defineComponent, PropType } from 'vue'
import { IVariable, IDataset, IWidget } from '@/modules/documentExecution/dashboard/Dashboard'
import { mapActions } from 'pinia'
import { emitter } from '@/modules/documentExecution/dashboard/DashboardHelpers'
import DashboardGeneralSettingsList from './DashboardGeneralSettingsList.vue'
import DashboardInformation from './information/DashboardInformation.vue'
import DashboardBackground from './background/DashboardBackground.vue'
import CssEditor from './cssEditor/DashboardCssEditor.vue'
import MenuWidgets from './menu&widgets/Menu&Widgets.vue'
import DashboardVariables from './DashboardVariables.vue'
import DashboardThemes from './themes/DashboardThemes.vue'
import store from '@/modules/documentExecution/dashboard/Dashboard.store'
import mainStore from '@/App.store'
import deepcopy from 'deepcopy'
import { setVariableValueFromDataset } from './VariablesHelper'
import { applySelectedThemeToWidgets } from './themes/ThemesHelper'
import WidgetEditor from '@/modules/documentExecution/dashboard/widget/WidgetEditor/WidgetEditor.vue'
import { createCustomHeaderWidget } from './DashboardGeneralSettingsHelper'
import { IMenuAndWidgets } from '../Dashboard'
import { addMissingMenuWidgetsConfiguration } from '../DashboardHelpers'

export default defineComponent({
    name: 'dashboard-general-settings',
    components: { DashboardGeneralSettingsList, DashboardVariables, DashboardInformation, DashboardBackground, MenuWidgets, CssEditor, DashboardThemes, WidgetEditor },
    props: {
        dashboardId: { type: String, required: true },
        datasets: { type: Array as PropType<IDataset[]>, required: true },
        profileAttributes: { type: Array as PropType<{ name: string; value: string }[]>, required: true },
        generalSettingsMode: { type: String, default: 'General' }
    },
    emits: ['closeGeneralSettings'],
    data() {
        return {
            selectedOption: '' as string,
            dashboardModel: null as any,
            variables: [] as IVariable[],
            selectedDatasets: [] as IDataset[],
            selectedDatasetColumnsMap: {},
            customHeaderWidget: null as IWidget | null,
            customHeaderWidgetEditorVisible: false,
            menuWidgetsConfig: {} as IMenuAndWidgets
        }
    },
    computed: {},
    watch: {},
    created() {
        this.setSelectedOption(this.generalSettingsMode)
        this.loadDashboardModel()
        this.loadVariables()
        this.loadSelectedDatasets()
        this.loadSelectedDatasetColumnNames()
        this.loadMenuAndWidgetConfiguration()
    },
    methods: {
        ...mapActions(store, ['getDashboard']),
        ...mapActions(mainStore, ['getUser']),
        loadDashboardModel() {
            this.dashboardModel = this.getDashboard(this.dashboardId)
            this.customHeaderWidget = deepcopy(this.dashboardModel.configuration.customHeader)
        },
        loadVariables() {
            if (this.dashboardModel && this.dashboardModel.configuration) this.variables = deepcopy(this.dashboardModel.configuration.variables)
        },
        loadSelectedDatasets() {
            this.selectedDatasets = [] as IDataset[]
            if (this.dashboardModel && this.dashboardModel.configuration) {
                const tempModelDatasets = deepcopy(this.dashboardModel.configuration.datasets)
                for (let i = 0; i < tempModelDatasets.length; i++) {
                    const tempDataset = tempModelDatasets[i]
                    const index = this.datasets.findIndex((dataset: any) => dataset.id.dsId === tempDataset.id)
                    if (index !== -1)
                        this.selectedDatasets.push({
                            ...this.datasets[index],
                            cache: tempDataset.cache,
                            indexes: tempDataset.indexes ?? [],
                            parameters: tempDataset.parameters as any[],
                            drivers: tempDataset.drivers ?? []
                        })
                }
            }
        },
        loadSelectedDatasetColumnNames() {
            if (!this.selectedDatasets || this.selectedDatasets.length === 0) return
            this.selectedDatasets.forEach((dataset: IDataset) => this.loadSelectedDatasetColumnName(dataset))
        },
        loadSelectedDatasetColumnName(dataset: IDataset) {
            this.selectedDatasetColumnsMap[dataset.id.dsId] = { name: dataset.name, columns: [] }
            for (let i = 0; i < dataset.metadata.fieldsMeta.length; i++) {
                this.selectedDatasetColumnsMap[dataset.id.dsId].columns.push(dataset.metadata.fieldsMeta[i].name)
            }
        },
        setSelectedOption(option: string) {
            if (option === 'Custom Header') {
                if (!this.customHeaderWidget) this.customHeaderWidget = createCustomHeaderWidget()
                this.customHeaderWidgetEditorVisible = true
            }
            this.selectedOption = option
        },
        loadMenuAndWidgetConfiguration() {
            addMissingMenuWidgetsConfiguration(this.dashboardModel)
            this.menuWidgetsConfig = deepcopy(this.dashboardModel.configuration.menuWidgets) as IMenuAndWidgets
        },
        async saveGeneralSettings() {
            let refreshWidgets = false
            for (let i = 0; i < this.variables.length; i++) {
                if (this.variables[i].type === 'dataset') {
                    await setVariableValueFromDataset(this.variables[i], this.datasets, this.$http)
                    refreshWidgets = true
                }
            }

            this.dashboardModel.configuration.variables = this.variables
            if (this.dashboardModel.configuration.theme) applySelectedThemeToWidgets(this.dashboardModel.widgets, this.dashboardModel.configuration.theme)
            this.updateWidgetMenuSettings()

            if (refreshWidgets) emitter.emit('refreshAfterGeneralSettingsChange')
            this.$emit('closeGeneralSettings')
        },
        onCustomHeaderSaved(customHeader: IWidget) {
            this.dashboardModel.configuration.customHeader = deepcopy(customHeader)
            this.customHeaderWidgetEditorVisible = false
        },
        onCustomHeaderCancel() {
            this.customHeaderWidgetEditorVisible = false
        },
        updateWidgetMenuSettings() {
            this.dashboardModel.configuration.menuWidgets = this.menuWidgetsConfig
        }
    }
})
</script>
