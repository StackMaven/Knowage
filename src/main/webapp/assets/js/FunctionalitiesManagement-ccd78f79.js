import{d as B,ad as K,n as S,l as E,s as U,_ as T,r as d,o as m,c as V,f as n,w as o,g as M,t as b,a as l,D as f,G as D,h as p,A as u,B as H,X as A,y as O,z as R,Y as L,V as w}from"./index-1e676509.js";import{K as j,u as q,c as z}from"./KnValidatonMessages-ebe48c72.js";import{s as G}from"./checkbox.esm-fa6c8259.js";import{K as X}from"./KnHint-6d455703.js";import{s as Y}from"./tree.esm-837306a6.js";const J={style:{width:"100px"}},Q={style:{"margin-bottom":"40px"}},W={biObjects:[],codType:"LOW_FUNCT",code:"Functionalities",createRoles:[{id:1,name:"dev"},{id:2,name:"test"},{id:3,name:"user"},{id:4,name:"admin"},{id:5,name:"modeladmin"},{id:6,name:"demo"}],description:"workspace",devRoles:[{id:1,name:"dev"},{id:2,name:"test"},{id:3,name:"user"},{id:4,name:"admin"},{id:5,name:"modeladmin"},{id:6,name:"demo"}],execRoles:[{id:1,name:"dev"},{id:2,name:"test"},{id:3,name:"user"},{id:4,name:"admin"},{id:5,name:"modeladmin"},{id:6,name:"demo"}],id:1,name:"Marco",parentId:1,path:"/Functionalities/Marco",prog:1,testRoles:[{id:1,name:"dev"},{id:2,name:"test"},{id:3,name:"user"},{id:4,name:"admin"},{id:5,name:"modeladmin"},{id:6,name:"demo"}]};var Z={checkboxColumns:J,pField:Q,selectedFolder:W};const x={selectedFolder:[{fieldName:"code",validators:[{key:"required"}]},{fieldName:"name",validators:[{key:"required"}]}]};var I={validations:x};const _=B({emits:["touched","close","inserted"],props:{functionality:Object,rolesShort:Array,parentId:Number},components:{Card:K,DataTable:S,Column:E,Checkbox:G,KnValidationMessages:j},data(){return{v$:q(),detailDescriptor:Z,validationDescriptor:I,formVisible:!1,selectedFolder:{},parentFolder:null,roles:[],checked:[],loading:!1,dirty:!1}},computed:{buttonDisabled(){return this.v$.$invalid}},validations(){return{selectedFolder:z("selectedFolder",I.validations.selectedFolder)}},setup(){return{store:U()}},async created(){this.loading=!0,this.selectedFolder={...this.functionality},await this.loadParentFolder(),this.loadRoles(),this.loading=!1},watch:{async functionality(){this.loading=!0,this.v$.$reset(),this.selectedFolder={...this.functionality},await this.loadParentFolder(),this.loadRoles(),this.loading=!1},rolesShort(){this.loadRoles()}},methods:{closeTemplate(){this.$emit("close")},loadRoles(){this.roles=[];const e=this.selectedFolder.id?this.selectedFolder:this.parentFolder;this.rolesShort.forEach(t=>{const s={id:t.id,name:t.name,development:!1,test:!1,execution:!1,creation:!1,isButtonDisabled:!1};this.roleIsChecked(s,e.devRoles,"development"),this.roleIsChecked(s,e.testRoles,"test"),this.roleIsChecked(s,e.execRoles,"execution"),this.roleIsChecked(s,e.createRoles,"creation");for(let i of["devRoles","testRoles","execRoles","createRoles"])this.isCheckable(s,i);s.devRoles.checkable==!1&&s.testRoles.checkable==!1&&s.execRoles.checkable==!1&&s.createRoles.checkable==!1&&(s.isButtonDisabled=!0),this.roles.push(s)})},async loadParentFolder(){this.parentId&&await this.$http.get(`/knowage/restful-services/2.0/functionalities/getParent/${this.parentId}`).then(e=>this.parentFolder=e.data)},roleIsChecked(e,t,s){t&&t.findIndex(c=>e.id===c.id)>-1&&(e[s]=!0)},isCheckable(e,t){e[t]={checkable:!1},this.parentFolder.path==="/Functionalities"?e[t].checkable=!0:this.parentFolder[t]&&this.parentFolder[t].length>0&&this.parentFolder[t].forEach(s=>{e.name===s.name&&(e[t].checkable=!0)})},prepareFunctionalityToSend(e){var t=[...this.roles];e.codeType=e.codType,delete e.codType,delete e.biObjects,this.emptyFunctionalityRoles(e),t.forEach(s=>{s.development&&e.devRoles.push(s),s.test&&e.testRoles.push(s),s.execution&&e.execRoles.push(s),s.creation&&e.createRoles.push(s)}),e.id||this.prepareNewFunctionality(e)},prepareNewFunctionality(e){e.codeType=this.parentFolder.codType,e.parentId=this.parentFolder.id,e.path=this.parentFolder.path+"/"+e.name,e.description||(e.description="")},emptyFunctionalityRoles(e){e.devRoles=[],e.testRoles=[],e.execRoles=[],e.createRoles=[]},async createOrUpdate(e){return this.selectedFolder.id?this.$http.put(`/knowage/restful-services/2.0/functionalities/${e.id}`,e):this.$http.post("/knowage/restful-services/2.0/functionalities/",e)},async handleSubmit(){if(this.v$.$invalid)return;let e={...this.selectedFolder};this.prepareFunctionalityToSend(e),await this.createOrUpdate(e).then(t=>{t.data.errors?this.store.setError({title:"Error",msg:t.data.error}):(this.$emit("inserted",t.data.id),this.store.setInfo({title:this.$t("common.toast.success")}))}),this.dirty=!1},checkSingleRole(e,t,s,i){e[t].checkable&&(e[s]=i)},checkAll(e){this.checkSingleRole(e,"createRoles","creation",!0),this.checkSingleRole(e,"devRoles","development",!0),this.checkSingleRole(e,"execRoles","execution",!0),this.checkSingleRole(e,"testRoles","test",!0)},uncheckAll(e){this.checkSingleRole(e,"createRoles","creation",!1),this.checkSingleRole(e,"devRoles","development",!1),this.checkSingleRole(e,"execRoles","execution",!1),this.checkSingleRole(e,"testRoles","test",!1)}}}),P={key:0,class:"kn-detail"},ee={class:"p-fluid p-m-3"},te={class:"p-float-label"},ae={for:"label",class:"kn-material-input-label"},se={class:"p-float-label"},ne={for:"name",class:"kn-material-input-label"},ie={class:"p-float-label"},le={for:"description",class:"kn-material-input-label"},oe={class:"p-d-flex p-jc-end"};function de(e,t,s,i,c,N){const v=d("Button"),F=d("Toolbar"),g=d("InputText"),k=d("KnValidationMessages"),C=d("Card"),h=d("Column"),$=d("Checkbox"),y=d("DataTable");return m(),V(H,null,[n(F,{class:"kn-toolbar kn-toolbar--secondary p-m-0"},{start:o(()=>[M(b(e.selectedFolder.name),1)]),end:o(()=>[n(v,{icon:"pi pi-save",class:"p-button-text p-button-rounded p-button-plain",disabled:e.buttonDisabled,onClick:e.handleSubmit,"data-test":"submit-button"},null,8,["disabled","onClick"]),n(v,{icon:"pi pi-times",class:"p-button-text p-button-rounded p-button-plain",onClick:e.closeTemplate},null,8,["onClick"])]),_:1}),!e.selectedFolder.id||e.selectedFolder.parentId?(m(),V("div",P,[n(C,{class:"p-m-3"},{content:o(()=>[l("form",ee,[l("div",{class:"p-field",style:f(e.detailDescriptor.pField.style)},[l("span",te,[n(g,{id:"label",class:D(["kn-material-input",{"p-invalid":e.v$.selectedFolder.code.$invalid&&e.v$.selectedFolder.code.$dirty}]),type:"text",modelValue:e.v$.selectedFolder.code.$model,"onUpdate:modelValue":t[0]||(t[0]=a=>e.v$.selectedFolder.code.$model=a),modelModifiers:{trim:!0},maxLength:"100",onBlur:t[1]||(t[1]=a=>e.v$.selectedFolder.code.$touch()),onInput:t[2]||(t[2]=a=>e.$emit("touched")),"data-test":"code-input"},null,8,["modelValue","class"]),l("label",ae,b(e.$t("common.label"))+" * ",1)]),n(k,{vComp:e.v$.selectedFolder.code,additionalTranslateParams:{fieldName:e.$t("common.label")}},null,8,["vComp","additionalTranslateParams"])],4),l("div",{class:"p-field",style:f(e.detailDescriptor.pField.style)},[l("span",se,[n(g,{id:"name",class:D(["kn-material-input",{"p-invalid":e.v$.selectedFolder.name.$invalid&&e.v$.selectedFolder.name.$dirty}]),type:"text",modelValue:e.v$.selectedFolder.name.$model,"onUpdate:modelValue":t[3]||(t[3]=a=>e.v$.selectedFolder.name.$model=a),modelModifiers:{trim:!0},maxLength:"255",onBlur:t[4]||(t[4]=a=>e.v$.selectedFolder.name.$touch()),onInput:t[5]||(t[5]=a=>e.$emit("touched")),"data-test":"name-input"},null,8,["modelValue","class"]),l("label",ne,b(e.$t("common.name"))+" * ",1)]),n(k,{vComp:e.v$.selectedFolder.name,additionalTranslateParams:{fieldName:e.$t("common.name")}},null,8,["vComp","additionalTranslateParams"])],4),l("div",{class:"p-field",style:f(e.detailDescriptor.pField.style)},[l("span",ie,[n(g,{id:"description",class:"kn-material-input",type:"text",modelValue:e.selectedFolder.description,"onUpdate:modelValue":t[6]||(t[6]=a=>e.selectedFolder.description=a),modelModifiers:{trim:!0},maxLength:"255",onInput:t[7]||(t[7]=a=>e.$emit("touched")),"data-test":"description-input"},null,8,["modelValue"]),l("label",le,b(e.$t("common.description")),1)])],4)])]),_:1}),n(C,{class:"p-m-3"},{header:o(()=>[n(F,{class:"kn-toolbar kn-toolbar--secondary"},{start:o(()=>[M(b(e.$t("managers.menuManagement.roles")),1)]),_:1})]),content:o(()=>[e.loading?u("",!0):(m(),p(y,{key:0,value:e.roles,dataKey:"id",class:"p-datatable-sm kn-table",responsiveLayout:"scroll","data-test":"roles-table"},{default:o(()=>[n(h,{field:"name",header:e.$t("managers.functionalitiesManagement.roles"),sortable:!0},null,8,["header"]),n(h,{header:e.$t("managers.functionalitiesManagement.development"),style:f(e.detailDescriptor.checkboxColumns.style)},{body:o(a=>[n($,{modelValue:a.data.development,"onUpdate:modelValue":r=>a.data.development=r,binary:!0,disabled:!a.data.devRoles.checkable},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:1},8,["header","style"]),n(h,{header:e.$t("common.test"),style:f(e.detailDescriptor.checkboxColumns.style)},{body:o(a=>[n($,{modelValue:a.data.test,"onUpdate:modelValue":r=>a.data.test=r,binary:!0,disabled:!a.data.testRoles.checkable},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:1},8,["header","style"]),n(h,{header:e.$t("managers.functionalitiesManagement.execution"),style:f(e.detailDescriptor.checkboxColumns.style)},{body:o(a=>[n($,{modelValue:a.data.execution,"onUpdate:modelValue":r=>a.data.execution=r,binary:!0,disabled:!a.data.execRoles.checkable},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:1},8,["header","style"]),n(h,{header:e.$t("managers.functionalitiesManagement.creation"),style:f(e.detailDescriptor.checkboxColumns.style)},{body:o(a=>[n($,{modelValue:a.data.creation,"onUpdate:modelValue":r=>a.data.creation=r,binary:!0,disabled:!a.data.createRoles.checkable},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:1},8,["header","style"]),n(h,{onRowClick:a=>!1},{body:o(a=>[l("div",oe,[n(v,{icon:"pi pi-check",class:"p-button-link",onClick:r=>e.checkAll(a.data),disabled:a.data.isButtonDisabled,"data-test":"check-all-"+a.data.id},null,8,["onClick","disabled","data-test"]),n(v,{icon:"pi pi-times",class:"p-button-link",onClick:r=>e.uncheckAll(a.data),disabled:a.data.isButtonDisabled,"data-test":"uncheck-all-"+a.data.id},null,8,["onClick","disabled","data-test"])])]),_:1})]),_:1},8,["value"]))]),_:1})])):u("",!0)],64)}var re=T(_,[["render",de]]);const ce={style:{padding:"0"}};var me={node:ce};const ue=B({name:"functionalities-management",components:{FunctionalitiesManagementDetail:re,FabButton:A,KnHint:X,Tree:Y},data(){return{functionalitiesManagementDescriptor:me,functionalities:[],rolesShort:[],nodes:[],selectedFunctionality:null,functionalityParentId:null,expandedKeys:{},showHint:!0,touched:!1,loading:!1,buttonsVisible:[],formVisible:!1}},setup(){return{store:U()}},async created(){await this.loadPage(null)},methods:{async loadFunctionalities(){await this.$http.get("/knowage/restful-services/2.0/functionalities/").then(e=>this.functionalities=e.data)},async loadRolesShort(){this.rolesShort=[],await this.$http.get("/knowage/restful-services/2.0/roles/short/").then(e=>this.rolesShort=e.data)},createNodeTree(){this.nodes=[];const e=[];this.functionalities.forEach(t=>{if(t.codType!=="USER_FUNCT"){const s={key:t.id,id:t.id,parentId:t.parentId,label:t.name,children:[],data:t,style:this.functionalitiesManagementDescriptor.node.style};s.children=e.filter(i=>s.id===i.parentId),this.attachFolderToTree(s,e)}})},attachFolderToTree(e,t){var s;if(e.parentId){let i=null;for(let c=0;c<t.length;c++)if(e.parentId===t[c].id){t[c].children.push(e);break}for(let c=0;c<this.nodes.length;c++)if(i=this.findParentFolder(e,this.nodes[c]),i){(s=i.children)==null||s.push(e);break}i||t.push(e)}else this.nodes.push(e)},findParentFolder(e,t){if(e.parentId===t.id)return t;{let s=null;if(t.children)for(let i=0;i<t.children.length&&(s=this.findParentFolder(e,t.children[i]),!s);i++);return s}},expandAll(){for(let e of this.nodes)this.expandNode(e);this.expandedKeys={...this.expandedKeys}},expandNode(e){if(e.children&&e.children.length){this.expandedKeys[e.key]=!0;for(let t of e.children)this.expandNode(t)}},showForm(e,t){this.showHint=!1,this.functionalityParentId=t,this.touched?this.$confirm.require({message:this.$t("common.toast.unsavedChangesMessage"),header:this.$t("common.toast.unsavedChangesHeader"),icon:"pi pi-exclamation-triangle",accept:()=>{this.touched=!1,this.setSelected(e)}}):this.setSelected(e)},onClose(){this.touched=!1,this.formVisible=!1,this.showHint=!0},setSelected(e){this.selectedFunctionality=e,this.formVisible=!0},canBeMovedUp(e){return e.prog!==1},moveUp(e){this.$http.get(`/knowage/restful-services/2.0/functionalities/moveUp/${e}`).then(()=>this.loadPage(null))},canBeMovedDown(e){let t=!1;return this.functionalities.forEach(s=>{e.parentId===s.parentId&&e.prog<s.prog&&(t=!0)}),t},moveDown(e){this.$http.get(`/knowage/restful-services/2.0/functionalities/moveDown/${e}`).then(()=>this.loadPage(null))},canBeDeleted(e){return e.parentId&&e.codType!=="LOW_FUNCT"},deleteFunctionalityConfirm(e){this.$confirm.require({message:this.$t("common.toast.deleteMessage"),header:this.$t("common.toast.deleteTitle"),icon:"pi pi-exclamation-triangle",accept:()=>{this.touched=!1,this.deleteFunctionality(e)}})},async deleteFunctionality(e){await this.$http.delete(`/knowage/restful-services/2.0/functionalities/${e}`).then(()=>{this.store.setInfo({title:this.$t("common.toast.deleteTitle"),msg:this.$t("common.toast.deleteSuccess")}),this.selectedFunctionality=null,this.formVisible=!1,this.showHint=!0,this.loadPage(null)}).catch(t=>{this.store.setError({title:this.$t("common.toast.deleteTitle"),msg:t.message})})},async loadPage(e){var s;this.loading=!0,await this.loadFunctionalities(),await this.loadRolesShort(),this.createNodeTree(),this.expandAll();const t=e||((s=this.selectedFunctionality)==null?void 0:s.id);this.selectedFunctionality=this.functionalities.find(i=>i.id===t),this.touched=!1,this.loading=!1}}}),he={class:"kn-page"},pe={class:"p-grid p-m-0"},fe={class:"p-col-4 p-sm-4 p-md-3 p-p-0 p-d-flex p-flex-column"},be=["onMouseover","onMouseleave","data-test"],ve={class:"p-ml-2"},ke={class:"p-col-8 p-sm-8 p-md-9 p-p-0 p-m-0 kn-height-full-vertical"};function $e(e,t,s,i,c,N){const v=d("FabButton"),F=d("Toolbar"),g=d("ProgressBar"),k=d("Button"),C=d("Tree"),h=d("KnHint"),$=d("FunctionalitiesManagementDetail"),y=O("tooltip");return m(),V("div",he,[l("div",pe,[l("div",fe,[n(F,{class:"kn-toolbar kn-toolbar--primary"},{start:o(()=>[M(b(e.$t("managers.functionalitiesManagement.title")),1)]),end:o(()=>[e.selectedFunctionality?(m(),p(v,{key:0,icon:"fas fa-plus",onClick:t[0]||(t[0]=a=>e.showForm(null,e.selectedFunctionality.id)),"data-test":"new-button"})):u("",!0)]),_:1}),e.loading?(m(),p(g,{key:0,mode:"indeterminate",class:"kn-progress-bar","data-test":"progress-bar"})):u("",!0),n(C,{id:"document-tree",scrollHeight:"calc(100vh - 91px)",maximizable:"",value:e.nodes,selectionMode:"single",expandedKeys:e.expandedKeys,filter:!0,filterMode:"lenient",onNodeSelect:t[1]||(t[1]=a=>e.showForm(a.data,a.data.parentId)),"data-test":"functionality-tree",class:"kn-tree kn-column-tree kn-flex p-p-0"},{default:o(a=>[l("div",{class:"p-d-flex p-flex-row p-ai-center",onMouseover:r=>e.buttonsVisible[a.node.id]=!0,onMouseleave:r=>e.buttonsVisible[a.node.id]=!1,"data-test":"tree-item-"+a.node.id},[l("span",null,b(a.node.label),1),R(l("div",ve,[e.canBeMovedUp(a.node.data)?R((m(),p(k,{key:0,icon:"fa fa-arrow-up",class:"p-button-link p-button-sm p-p-0",onClick:w(r=>e.moveUp(a.node.id),["stop"]),"data-test":"move-up-button-"+a.node.id},null,8,["onClick","data-test"])),[[y,e.$t("managers.functionalitiesManagement.moveUp"),void 0,{top:!0}]]):u("",!0),e.canBeMovedDown(a.node.data)?R((m(),p(k,{key:1,icon:"fa fa-arrow-down",class:"p-button-link p-button-sm p-p-0",onClick:w(r=>e.moveDown(a.node.id),["stop"]),"data-test":"move-down-button-"+a.node.id},null,8,["onClick","data-test"])),[[y,e.$t("managers.functionalitiesManagement.moveDown "),void 0,{top:!0}]]):u("",!0),e.canBeDeleted(a.node)?R((m(),p(k,{key:2,icon:"far fa-trash-alt",class:"p-button-link p-button-sm p-p-0",onClick:w(r=>e.deleteFunctionalityConfirm(a.node.id),["stop"]),"data-test":"delete-button-"+a.node.id},null,8,["onClick","data-test"])),[[y,e.$t("common.delete"),void 0,{top:!0}]]):u("",!0)],512),[[L,e.buttonsVisible[a.node.id]]])],40,be)]),_:1},8,["value","expandedKeys"])]),l("div",ke,[e.showHint?(m(),p(h,{key:0,title:"managers.functionalitiesManagement.title",hint:"managers.functionalitiesManagement.hint","data-test":"functionality-hint"},null,8,["title","hint"])):u("",!0),e.formVisible?(m(),p($,{key:1,functionality:e.selectedFunctionality,parentId:e.functionalityParentId,rolesShort:e.rolesShort,onTouched:t[2]||(t[2]=a=>e.touched=!0),onClose:e.onClose,onInserted:t[3]||(t[3]=a=>e.loadPage(a))},null,8,["functionality","parentId","rolesShort","onClose"])):u("",!0)])])])}var we=T(ue,[["render",$e]]);export{we as default};
//# sourceMappingURL=FunctionalitiesManagement-ccd78f79.js.map
