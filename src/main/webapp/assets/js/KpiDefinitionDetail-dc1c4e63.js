import{K as B,u as R,c as J}from"./KnValidatonMessages-ebe48c72.js";import{bg as X,d as N,ah as _,i as Z,s as H,aX as I,_ as F,r as u,o as C,c as D,a as n,f as i,G as U,t as v,h as V,A as T,w as c,B as z,ad as P,n as G,l as q,D as $,g as K,C as ee,p as te,b as oe,a4 as Q,q as re,a5 as ae,y as ie,z as ne,v as le,u as se}from"./index-1e676509.js";import{s as de}from"./radiobutton.esm-c3e6fa9b.js";import{s as ce}from"./sidebar.esm-2131cfd1.js";import{s as Y}from"./checkbox.esm-fa6c8259.js";import{s as pe}from"./colorpicker.esm-423214e6.js";import{s as be}from"./autocomplete.esm-bebdfcbd.js";const ue={cardinality:'{"measureList":[],"checkedAttribute":{"attributeUnion":{},"attributeIntersection":{}}}',definition:'{"formula":"","measures":[],"functions":[],"formulaDecoded":"","formulaSimple":""}',name:"",placeholder:"",threshold:{description:"",thresholdValues:[]}},me=["alias","name"],ke={insert:{toastTitle:"common.toast.createTitle"},success:"common.toast.success",update:{toastTitle:"common.toast.updateTitle"}},he={card:{"margin-bottom":"2em",width:"100%"},cardinalityCard:{"font-size":"large","margin-bottom":"2em","text-align":"center"},cardinalityColumn:{"text-align":"center",width:"100%"},cardinalityTable:{"text-align":"center"},formulaDialog:{width:"20%"},saveDialog:{width:"20%"},aliasButton:{"text-transform":"uppercase"},aliasList:{height:"39px"}},fe={selectedKpi:[{fieldName:"name",validators:[{key:"required"}]},{fieldName:"category",validators:[{key:"required"}]}]};var E={emptyKpi:ue,filterFields:me,operation:ke,style:he,validations:fe};function ge(){X.defineMode("mathematica",function(e,t){console.log(e,t);var r="[a-zA-Z\\$][a-zA-Z0-9\\$]*",o="(?:\\d+)",d="(?:\\.\\d+|\\d+\\.\\d*|\\d+)",p="(?:\\.\\w+|\\w+\\.\\w*|\\w+)",l="(?:`(?:`?"+d+")?)",m=new RegExp("(?:"+o+"(?:\\^\\^"+p+l+"?(?:\\*\\^[+-]?\\d+)?))"),k=new RegExp("(?:"+d+l+"?(?:\\*\\^[+-]?\\d+)?)"),a=new RegExp("(?:`?)(?:"+r+")(?:`(?:"+r+"))*(?:`?)");function f(b,g){var w;return w=b.next(),w==='"'?(g.tokenize=x,g.tokenize(b,g)):w==="("&&b.eat("*")?(g.commentLevel++,g.tokenize=h,g.tokenize(b,g)):(b.backUp(1),b.match(m,!0,!1)||b.match(k,!0,!1)?"number":b.match(/(?:In|Out)\[[0-9]*\]/,!0,!1)?"atom":b.match(/([a-zA-Z\$]+(?:`?[a-zA-Z0-9\$])*::usage)/,!0,!1)?"meta":b.match(/([a-zA-Z\$]+(?:`?[a-zA-Z0-9\$])*::[a-zA-Z\$][a-zA-Z0-9\$]*):?/,!0,!1)?"string-2":b.match(/([a-zA-Z_\$][a-zA-Z0-9\$]*\s*:)(?:(?:[a-zA-Z_\$][a-zA-Z0-9_\$]*)|(?:[^:=>~@\^\&\*\)\[\]'\?,\|])).*/,!0,!1)||b.match(/[a-zA-Z_\$][a-zA-Z_0-9\$]*_+[a-zA-Z_\$][a-zA-Z0-9_\$]*/,!0,!1)||b.match(/[a-zA-Z_\$][a-zA-Z_0-9\$]*_+[0-9\$]*/,!0,!1)||b.match(/_+[a-zA-Z_\$][a-zA-Z_0-9\$]*/,!0,!1)?"variable-2":b.match(/\\\[[a-zA-Z\$][a-zA-Z0-9\$]*\]/,!0,!1)?"variable-3":b.match(/(?:\[|\]|{|}|\(|\))/,!0,!1)?"bracket":b.match(/(?:#[a-zA-Z\$][a-zA-Z0-9\$]*|#+[0-9]?)/,!0,!1)?"variable-2":b.match(a,!0,!1)?"keyword":b.match(/(?:\\|\+|\-|\*|\/|,|;|\.|:|@|~|=|>|<|&|\||_|`|'|\^|\?|!|%)/,!0,!1)?"operator":"error")}function x(b,g){for(var w,A=!1,S=!1;(w=b.next())!=null;){if(w==='"'&&!S){A=!0;break}S=!S&&w==="\\"}return A&&!S&&(g.tokenize=f),"string"}function h(b,g){for(var w,A;g.commentLevel>0&&(A=b.next())!=null;)w==="("&&A==="*"&&g.commentLevel++,w==="*"&&A===")"&&g.commentLevel--,w=A;return g.commentLevel<=0&&(g.tokenize=f),"comment"}return{startState:function(){return{tokenize:f,commentLevel:0}},token:function(b,g){return b.eatSpace()?null:g.tokenize(b,g)},blockCommentStart:"(*",blockCommentEnd:"*)"}}),X.defineMIME("text/x-mathematica",{name:"mathematica"})}const ve=N({components:{VCodeMirror:_,Dialog:Z,RadioButton:de,KnValidationMessages:B},props:{propKpi:Object,measures:{type:Array},aliasToInput:{type:String},checkFormula:{type:Boolean},activeTab:{type:Number},loading:Boolean,reloadKpi:Boolean},emits:["touched","errorInFormula","updateFormulaToSave","onGuideClose"],data(){return{codeMirrorOptions:{mode:"text/x-mathematica",indentWithTabs:!0,smartIndent:!0,lineWrapping:!0,matchBrackets:!0,autofocus:!0,theme:"eclipse",lineNumbers:!0,gutters:["CodeMirror-lint-markers"],lint:!0,extraKeys:{"Ctrl-Space":this.keyAssistFunc}},v$:R(),tabViewDescriptor:E,selectedKpi:{},codeMirror:{},previousTabIndex:0,dialogHeaderInfo:{},measuresToJSON:[],functionsTOJSON:[],formula:"",formulaDecoded:"",formulaSimple:"",token:"",selectedFunctionalities:"SUM",functionDialogVisible:!1,cursorPosition:null}},validations(){return{selectedKpi:J("selectedKpi",E.validations.selectedKpi)}},setup(){return{store:H()}},created(){ge()},mounted(){this.propKpi&&(this.selectedKpi=this.propKpi),this.registerCodeMirrorHelper(),this.loadKPI()},watch:{propKpi(){this.selectedKpi=this.propKpi,this.selectedKpi.definition!=""&&(this.selectedKpi.definition=JSON.parse(this.selectedKpi.definition)),this.loadKPI()},aliasToInput(){this.cursorPosition=this.codeMirror.getCursor(),this.codeMirror.replaceRange(" "+this.aliasToInput,this.cursorPosition),this.$emit("touched")},activeTab(){setTimeout(()=>{this.codeMirror.refresh()},0),this.previousTabIndex===0&&this.activeTab!=0&&this.checkFormulaForErrors(),this.previousTabIndex=this.activeTab},reloadKpi(){this.reloadKpi===!0&&this.loadKPI()}},methods:{openFunctionPicker(){for(var e=this.codeMirror.getCursor(),t=this.codeMirror.getTokenAt(e);t.string.trim()=="";)e.ch=e.ch+1,t=this.codeMirror.getTokenAt(e);for(;t.type=="operator"||t.type=="bracket"||t.type=="number";)e.ch=e.ch+1,t=this.codeMirror.getTokenAt(e);for(;t.string.trim()=="";)e.ch=e.ch+1,t=this.codeMirror.getTokenAt(e);if(this.selectedFunctionalities!="")for(var r=this.codeMirror.findMarksAt({line:this.codeMirror.getCursor().line,ch:t.end}),o=0;o<r.length;o++)r[o].clear();this.selectedFunctionalities=="MAX"?this.codeMirror.markText({line:this.codeMirror.getCursor().line,ch:t.start},{line:this.codeMirror.getCursor().line,ch:t.end},{className:"cm-m-max",atomic:!0}):this.selectedFunctionalities=="MIN"?this.codeMirror.markText({line:this.codeMirror.getCursor().line,ch:t.start},{line:this.codeMirror.getCursor().line,ch:t.end},{className:"cm-m-min",atomic:!0}):this.selectedFunctionalities=="COUNT"?this.codeMirror.markText({line:this.codeMirror.getCursor().line,ch:t.start},{line:this.codeMirror.getCursor().line,ch:t.end},{className:"cm-m-count",atomic:!0}):this.selectedFunctionalities=="SUM"&&this.codeMirror.markText({line:this.codeMirror.getCursor().line,ch:t.start},{line:this.codeMirror.getCursor().line,ch:t.end},{className:"cm-m-sum",atomic:!0}),this.functionDialogVisible=!1,this.checkError(this.codeMirror,t)},checkError(e,t){var r=!1;this.measureInList(t.string,this.measures)==-1&&(r=!0),r&&e.markText({line:e.getCursor().line,ch:t.start},{line:e.getCursor().line,ch:t.end},{className:"error_word"}),document.querySelectorAll(".CodeMirrorMathematica .CodeMirror-code span.error_word ").forEach(o=>o.setAttribute("target","Measure Missing"))},registerCodeMirrorHelper(){I.registerHelper("hint","measures",()=>{for(var e=this.codeMirror.getCursor(),t=this.codeMirror.getTokenAt(e),r=t.string.trim()==""?t.start+1:t.start,o=t.end,d=[],p=0;p<this.measures.length;p++)(t.string.trim()==""||this.measures[p].alias.startsWith(t.string))&&d.push(this.measures[p].alias);return{list:d,from:I.Pos(e.line,r),to:I.Pos(e.line,o)}})},onKeyUp(e){var t=this.codeMirror;if(this.$emit("touched"),e.keyIdentifier!=null&&e.keyIdentifier!="U+0008"&&e.keyIdentifier!="Left"&&e.keyIdentifier!="Right"||e.key!=null&&e.key!="Backspace"&&e.key!="Left"&&e.key!="Right"){var r=t.getCursor(),o=t.getTokenAt(r);o.string=="{"||o.string=="}"||o.string=="["||o.string=="]"?t.replaceRange("",{line:t.getCursor().line,ch:o.start},{line:t.getCursor().line,ch:o.end+1}):(o.type=="operator"||o.type=="bracket")&&o.string!="_"&&(o.string=" ",t.replaceRange(o.string,{line:t.getCursor().line,ch:o.end}),t.replaceRange(" ",{line:t.getCursor().line,ch:o.start}))}},onMouseDown(e){if("srcElement"in e){for(var t=0;t<e.srcElement.classList.length;t++)if(this.token=e.srcElement.innerHTML,e.srcElement.classList[t]=="cm-m-max"){this.selectedFunctionalities="MAX";break}else if(e.srcElement.classList[t]=="cm-m-min"){this.selectedFunctionalities="MIN";break}else if(e.srcElement.classList[t]=="cm-m-count"){this.selectedFunctionalities="COUNT";break}else if(e.srcElement.classList[t]=="cm-m-sum"){this.selectedFunctionalities="SUM";break}var r=e.srcElement.className;(r.startsWith("cm-keyword")||r.startsWith("cm-variable-2"))&&(this.dialogHeaderInfo.functionName=e.srcElement.innerHTML,this.functionDialogVisible=!0)}},keyAssistFunc(){I.showHint(this.codeMirror,I.hint.measures)},loadKPI(){const e=setInterval(()=>{!this.$refs.codeMirror||(this.codeMirror=this.$refs.codeMirror.cminstance,setTimeout(()=>{this.codeMirror.refresh()},0),this.codeMirror.setValue(""),this.codeMirror.clearHistory(),this.codeMirror.setValue(this.selectedKpi.definition.formulaSimple),this.changeIndexWithMeasures(this.selectedKpi.definition.functions,this.codeMirror),clearInterval(e))},200)},changeIndexWithMeasures(e,t){for(var r=0,o=0;o<t.lineCount();o++)for(var d=this.removeSpace(t.getLineTokens(o)),p=0;p<d.length;p++){var l=d[p];if(l.type=="keyword"||l.type=="variable-2"){var m=e[r];r++,m=="MAX"?t.markText({line:o,ch:l.start},{line:o,ch:l.end},{className:"cm-m-max"}):m=="MIN"?t.markText({line:o,ch:l.start},{line:o,ch:l.end},{className:"cm-m-min"}):m=="SUM"?t.markText({line:o,ch:l.start},{line:o,ch:l.end},{className:"cm-m-sum"}):m=="COUNT"&&t.markText({line:o,ch:l.start},{line:o,ch:l.end},{className:"cm-m-count"})}}},removeSpace(e){for(var t=0;t<e.length;t++)e[t].type==null&&e.splice(t,1);return e},reset(){this.measuresToJSON=[],this.functionsTOJSON=[],this.formula="",this.formulaDecoded="",this.formulaSimple=""},measureInList(e,t){for(var r=0;r<t.length;r++){var o=t[r];if(o.alias==e)return r}return-1},checkFormulaForErrors(){this.reset();var e=0,t=0,r=this.$refs.codeMirror.cminstance,o=!0,d=0;e:for(var p=0;p<r.lineCount();p++)for(var l=p+1,m=this.removeSpace(r.getLineTokens(p)),k=0;k<m.length;k++){var a=m[k],f=r.findMarksAt({line:p,ch:a.end});if(a.string.trim()!="")if(f.length==0){if(k-1>=0){var x=m[k-1];if((x.type=="keyword"||x.type=="variable-2")&&(a.type=="keyword"||a.type=="number"||a.type=="variable-2"||a.string=="(")){this.store.setError({msg:this.$t("kpi.kpiDefinition.errorformula.missingoperator")+l}),this.$emit("errorInFormula",!0),this.reset(),o=!1;break e}if(x.type=="operator"&&(a.type=="operator"||a.string==")")){this.store.setError({msg:this.$t("kpi.kpiDefinition.errorformula.malformed")+l}),this.$emit("errorInFormula",!0),this.reset(),o=!1;break e}if(x.type=="number"&&(a.type=="number"||a.string=="("||a.type=="keyword"||a.type=="variable-2")){this.store.setError({msg:this.$t("kpi.kpiDefinition.errorformula.malformed")+l}),this.$emit("errorInFormula",!0),this.reset(),o=!1;break e}if(x.type=="bracket"){if(a.string==")"&&x.string=="("||a.string=="("&&x.string==")"){this.store.setError({msg:this.$t("kpi.kpiDefinition.errorformula.malformed")+l}),this.$emit("errorInFormula",!0),o=!1;break e}if(x.string==")"&&(a.type=="keyword"||a.type=="number"||a.type=="variable-2")){this.store.setError({msg:this.$t("kpi.kpiDefinition.errorformula.missingoperator")}),this.$emit("errorInFormula",!0),this.reset(),o=!1;break e}}if(x.string=="("&&a.type=="operator"){this.store.setError({msg:this.$t("kpi.kpiDefinition.errorformula.malformed")+l}),this.$emit("errorInFormula",!0),this.reset(),o=!1;break e}}if(k==m.length-1&&a.type=="operator"){this.store.setError({msg:this.$t("kpi.kpiDefinition.errorformula.malformed")+l}),this.$emit("errorInFormula",!0),this.reset(),o=!1;break e}if(a.type=="operator")if(k==0){this.store.setError({msg:this.$t("kpi.kpiDefinition.errorformula.malformed")+l}),this.$emit("errorInFormula",!0),this.reset(),o=!1;break e}else this.formula=this.formula+a.string,this.formulaDecoded=this.formulaDecoded+a.string,this.formulaSimple=this.formulaSimple+" "+a.string+" ";else if(a.type=="bracket")a.string=="("?e++:t++,this.formula=this.formula+a.string,this.formulaDecoded=this.formulaDecoded+a.string,this.formulaSimple=this.formulaSimple+" "+a.string+" ";else if(a.type=="number")this.formula=this.formula+a.string,this.formulaDecoded=this.formulaDecoded+a.string,this.formulaSimple=this.formulaSimple+a.string;else{this.store.setError({msg:this.$t("kpi.kpiDefinition.errorformula.missingfunctions")}),this.$emit("errorInFormula",!0),this.reset(),o=!1;break e}}else{if(k-1>=0&&(x=m[k-1],x.type=="number"||x.type=="keyword"||x.type=="variable-2")){this.store.setError({msg:this.$t("kpi.kpiDefinition.errorformula.missingoperator")}),this.$emit("errorInFormula",!0),this.reset(),o=!1;break e}for(var h=0;h<f.length;h++){var b=f[h].className;if(this.measureInList(a.string,this.measures)==-1&&(this.store.setError({msg:this.$t("kpi.kpiDefinition.errorformula.generic")}),this.$emit("errorInFormula",!0),this.reset(),o=!1),b=="cm-m-max"){d++,this.measuresToJSON.push(a.string),this.functionsTOJSON.push("MAX");var g=this.measuresToJSON.length-1,w="M"+g;this.formula=this.formula+w,this.formulaDecoded=this.formulaDecoded+"MAX("+a.string+")",this.formulaSimple=this.formulaSimple+a.string}else if(b=="cm-m-min")d++,this.measuresToJSON.push(a.string),this.functionsTOJSON.push("MIN"),g=this.measuresToJSON.length-1,w="M"+g,this.formula=this.formula+w,this.formulaDecoded=this.formulaDecoded+"MIN("+a.string+")",this.formulaSimple=this.formulaSimple+a.string;else if(b=="cm-m-count")d++,this.measuresToJSON.push(a.string),this.functionsTOJSON.push("COUNT"),g=this.measuresToJSON.length-1,w="M"+g,this.formula=this.formula+w,this.formulaDecoded=this.formulaDecoded+"COUNT("+a.string+")",this.formulaSimple=this.formulaSimple+a.string;else if(b=="cm-m-sum")d++,this.measuresToJSON.push(a.string),this.functionsTOJSON.push("SUM"),g=this.measuresToJSON.length-1,w="M"+g,this.formula=this.formula+w,this.formulaDecoded=this.formulaDecoded+"SUM("+a.string+")",this.formulaSimple=this.formulaSimple+a.string;else if(b=="error_word"){this.store.setError({msg:this.$t("kpi.kpiDefinition.errorformula.generic")}),this.$emit("errorInFormula",!0),this.reset(),o=!1;break e}}}}if(o&&this.$emit("errorInFormula",!1),e!=t&&o)this.store.setError({msg:this.$t("kpi.kpiDefinition.errorformula.missingbracket")}),this.$emit("errorInFormula",!0),this.reset();else if(d==0&&o&&(this.store.setError({msg:this.$t("kpi.kpiDefinition.errorformula.missingmeasure")}),this.$emit("errorInFormula",!0),this.reset()),this.formula!=""&&o)return this.selectedKpi.definition.formula=this.formula,this.selectedKpi.definition.measures=this.measuresToJSON,this.selectedKpi.definition.functions=this.functionsTOJSON,this.selectedKpi.definition.formulaDecoded=this.formulaDecoded,this.selectedKpi.definition.formulaSimple=this.formulaSimple,this.$emit("updateFormulaToSave",this.formula),this.loadKPI(),this.selectedKpi.definition;return{}}}}),ye={class:"p-fluid p-formgrid p-grid p-mt-3"},we={class:"p-field p-col-6"},xe={class:"p-float-label p-mb-2"},Ce={for:"label",class:"kn-material-input-label"},Me={class:"p-field p-col-6"},$e={class:"p-float-label p-mb-2"},Te={for:"name",class:"kn-material-input-label"},Ae={class:"p-mt-4 p-ml-4"},De={class:"p-field-radiobutton"},Se=n("label",{for:"SUM"},"SUM",-1),Ve={class:"p-field-radiobutton"},Ke=n("label",{for:"MAX"},"MAX",-1),Ee={class:"p-field-radiobutton"},Ie=n("label",{for:"MIN"},"MIN",-1),ze={class:"p-field-radiobutton"},Le=n("label",{for:"COUNT"},"COUNT",-1);function Ue(e,t,r,o,d,p){const l=u("InputText"),m=u("KnValidationMessages"),k=u("VCodeMirror"),a=u("RadioButton"),f=u("Button"),x=u("Dialog");return C(),D(z,null,[n("form",ye,[n("div",we,[n("span",xe,[i(l,{id:"name",class:U(["kn-material-input",{"p-invalid":e.v$.selectedKpi.name.$invalid&&e.v$.selectedKpi.name.$dirty}]),type:"text",maxLength:"25",modelValue:e.v$.selectedKpi.name.$model,"onUpdate:modelValue":t[0]||(t[0]=h=>e.v$.selectedKpi.name.$model=h),modelModifiers:{trim:!0},onBlur:t[1]||(t[1]=h=>e.v$.selectedKpi.name.$touch())},null,8,["modelValue","class"]),n("label",Ce,v(e.$t("common.name"))+" * ",1)]),i(m,{vComp:e.v$.selectedKpi.name,additionalTranslateParams:{fieldName:e.$t("common.name")}},null,8,["vComp","additionalTranslateParams"])]),n("div",Me,[n("span",$e,[i(l,{id:"name",class:"kn-material-input",type:"text",modelValue:e.selectedKpi.author,"onUpdate:modelValue":t[2]||(t[2]=h=>e.selectedKpi.author=h),modelModifiers:{trim:!0},disabled:!0},null,8,["modelValue"]),n("label",Te,v(e.$t("common.author")),1)])])]),e.loading?T("",!0):(C(),V(k,{key:0,ref:"codeMirror",class:"CodeMirrorMathematica",value:e.selectedKpi.definition.formula,"onUpdate:value":t[3]||(t[3]=h=>e.selectedKpi.definition.formula=h),autoHeight:!0,options:e.codeMirrorOptions,onKeyup:e.onKeyUp,onMousedown:e.onMouseDown},null,8,["value","options","onKeyup","onMousedown"])),i(x,{class:"kn-dialog--toolbar--primary importExportDialog",footer:"footer",visible:e.functionDialogVisible,closable:!1,modal:""},{header:c(()=>[n("h4",null,v(e.$t("kpi.kpiDefinition.formulaDialogHeader"))+" "+v(this.dialogHeaderInfo.functionName),1)]),footer:c(()=>[n("div",null,[i(f,{class:"kn-button kn-button--secondary",label:e.$t("common.apply"),onClick:e.openFunctionPicker},null,8,["label","onClick"])])]),default:c(()=>[n("div",Ae,[n("div",De,[i(a,{id:"SUM",name:"city",value:"SUM",modelValue:e.selectedFunctionalities,"onUpdate:modelValue":t[4]||(t[4]=h=>e.selectedFunctionalities=h)},null,8,["modelValue"]),Se]),n("div",Ve,[i(a,{id:"MAX",name:"city",value:"MAX",modelValue:e.selectedFunctionalities,"onUpdate:modelValue":t[5]||(t[5]=h=>e.selectedFunctionalities=h)},null,8,["modelValue"]),Ke]),n("div",Ee,[i(a,{id:"MIN",name:"city",value:"MIN",modelValue:e.selectedFunctionalities,"onUpdate:modelValue":t[6]||(t[6]=h=>e.selectedFunctionalities=h)},null,8,["modelValue"]),Ie]),n("div",ze,[i(a,{id:"COUNT",name:"city",value:"COUNT",modelValue:e.selectedFunctionalities,"onUpdate:modelValue":t[7]||(t[7]=h=>e.selectedFunctionalities=h)},null,8,["modelValue"]),Le])])]),_:1},8,["visible"])],64)}var Ne=F(ve,[["render",Ue]]);const Fe=N({components:{Card:P,DataTable:G,Column:q},props:{selectedKpi:{type:Object},updateMeasureList:Boolean,loading:Boolean},computed:{},emits:["touched","measureListUpdated"],data(){return{tabViewDescriptor:E,kpi:{},attributesList:[],currentCell:{},formulaChanged:!1,indexOfMeasure:-1,oldFormula:""}},watch:{selectedKpi(){this.kpi=this.selectedKpi,this.oldFormula=this.kpi.definition.formulaSimple},updateMeasureList(){this.updateMeasureList===!0&&(this.createFormulaToShow(),this.getAllMeasure())}},methods:{createFormulaToShow(){if(this.kpi&&this.kpi.definition&&this.kpi.definition.formulaSimple){this.oldFormula!=this.kpi.definition.formulaSimple&&(this.formulaChanged=!0,this.oldFormula=this.kpi.definition.formulaSimple);var e=this.kpi.definition.formulaSimple.split(" "),t=0;let r="";for(let d=0;d<e.length;d++){let p="";e[d].trim()=="+"||e[d].trim()=="-"||e[d].trim()=="/"||e[d].trim()=="*"||e[d].trim()=="("||e[d].trim()==")"||e[d].trim()==""||!isNaN(e[d])?p="<span class='showFormula'> "+e[d]+" </span>":(p="<span ng-class='{classBold:currentCell.row=="+d+"}' class='showFormula "+this.kpi.definition.functions[t]+"' id=M"+t+"> "+e[d]+" </span>",t++),r+=p}const o=document.getElementsByClassName("formula");o.length>0&&[...o].forEach(p=>p.innerHTML=r)}},getAllMeasure(){if(this.attributesList=[],this.kpi.cardinality!=null&&this.kpi.cardinality!=null){typeof this.kpi.cardinality!="object"&&(this.kpi.cardinality=JSON.parse(this.kpi.cardinality));for(var e=0;e<this.kpi.cardinality.measureList.length;e++)for(var t in this.kpi.cardinality.measureList[e].attributes)this.attributesList.indexOf(t)==-1&&this.attributesList.push(t);this.retryNewAttributes()}},async retryNewAttributes(){for(var e={},t=0;t<this.kpi.definition.measures.length;t++){var r=this.kpi.definition.measures[t];e[t]=r}await this.$http.post("/knowage/restful-services/1.0/kpi/buildCardinalityMatrix",e).then(o=>{if(this.formulaChanged){this.kpi.cardinality.measureList=[...o.data],this.formulaChanged=!1,this.attributesList=[];for(var d=0;d<o.data.length;d++)for(let p of Object.keys(o.data[d].attributes))this.attributesList.indexOf(p)==-1&&this.attributesList.push(p)}this.$emit("measureListUpdated")})},isEnabled(e,t){var r=this.checkMeasure(t);return r.status||this.isContainedByUpperSet(e,t,r.itemNumber)},canDisable(e,t){return!this.isContainedByUnderSet(e,t)},measureHaveAttribute(e,t){return t.attributes.hasOwnProperty(e)},checkMeasure(e){var t=0;for(var r in e.attributes)e.attributes[r]&&t++;var o={status:Object.keys(this.kpi.cardinality.checkedAttribute.attributeUnion).length==t,itemNumber:t};return o},isContainedByUpperSet(e,t,r){for(var o=99999999,d,p=0;p<this.kpi.cardinality.measureList.length;p++){var l=this.kpi.cardinality.measureList[p];if(l!=t){var m=0;for(var k in l.attributes)l.attributes[k]&&m++;if(m-1==r){d=l;break}m<o&&m>r&&(o=m,d=l)}}return!!(d==null||d.attributes[e])},isContainedByUnderSet(e,t){var r=0;for(var o in t.attributes)t.attributes[o]&&r++;for(var d=0,p,l=0;l<this.kpi.cardinality.measureList.length;l++){var m=this.kpi.cardinality.measureList[l];if(m!=t){var k=0;for(var a in m.attributes)m.attributes[a]&&k++;if(k+1==r){p=m;break}k>d&&k<r&&(d=k,p=m)}}return!(p==null||!p.attributes[e])},getMaxAttributeNumber(e){var t=0;for(var r in e)e[r]>=t&&(t=e[r]);return t},blinkMeasure(e,t,r){this.currentCell.row=t,this.currentCell.column=r,this.indexOfMeasure=r;var o="M"+this.indexOfMeasure,d=document.getElementById(o);d.css("background","#eceff1")},removeblinkMeasure(){var e="M"+this.indexOfMeasure,t=document.getElementById(e);t.css("background","transparent")},toggleCell(e,t){if(!(!t.attributes[e]&&!this.isEnabled(e,t))&&!(t.attributes[e]&&!this.canDisable(e,t))){t.attributes[e]=!t.attributes[e],t.attributes[e]?this.kpi.cardinality.checkedAttribute.attributeUnion[e]?this.kpi.cardinality.checkedAttribute.attributeUnion[e]++:this.kpi.cardinality.checkedAttribute.attributeUnion[e]=1:this.kpi.cardinality.checkedAttribute.attributeUnion[e]==1?delete this.kpi.cardinality.checkedAttribute.attributeUnion[e]:this.kpi.cardinality.checkedAttribute.attributeUnion[e]--,this.kpi.cardinality.checkedAttribute.attributeIntersection={};var r=this.getMaxAttributeNumber(this.kpi.cardinality.checkedAttribute.attributeUnion);for(var o in this.kpi.cardinality.checkedAttribute.attributeUnion)this.kpi.cardinality.checkedAttribute.attributeUnion[o]==r&&(this.kpi.cardinality.checkedAttribute.attributeIntersection[o]=!0)}}}}),Oe=e=>(te("data-v-21755626"),e=e(),oe(),e),Be=Oe(()=>n("div",{class:"CodeMirrorMathematica"},[n("div",{class:"CodeMirror-code formula"})],-1)),Re=["onClick"],Je={key:0,class:"fa fa-ban invalidCell"},Ze={key:1,class:"fa fa-check selectedCell"},Xe={key:2,class:"fa fa-lock selectedCell"},He={key:3,class:"fa fa-check selectableCell"};function Pe(e,t,r,o,d,p){const l=u("Card"),m=u("Column"),k=u("DataTable");return C(),D(z,null,[i(l,{style:$(e.tabViewDescriptor.style.cardinalityCard)},{content:c(()=>[Be]),_:1},8,["style"]),e.loading?T("",!0):(C(),V(l,{key:0,style:$(e.tabViewDescriptor.style.card)},{content:c(()=>[i(k,{value:e.attributesList,responsiveLayout:"scroll",class:"cardinalityTable"},{default:c(()=>[i(m,null,{body:c(a=>[K(v(a.data),1)]),_:1}),(C(!0),D(z,null,ee(e.kpi.cardinality.measureList,a=>(C(),V(m,{key:a},{header:c(()=>[n("div",{style:$(e.tabViewDescriptor.style.cardinalityColumn)},v(a.measureName),5)]),body:c(f=>[e.measureHaveAttribute(f.data,f.column.key)?(C(),D("div",{key:0,class:"measureCell",onClick:x=>e.toggleCell(f.data,f.column.key)},[e.isEnabled(f.data,f.column.key)?T("",!0):(C(),D("i",Je)),a.attributes[f.data]?(C(),D("i",Ze)):T("",!0),a.attributes[f.data]&&!e.canDisable(f.data,f.column.key)?(C(),D("i",Xe)):T("",!0),!a.attributes[f.data]&&e.isEnabled(f.data,f.column.key)?(C(),D("i",He)):T("",!0)],8,Re)):T("",!0)]),_:2},1024))),128))]),_:1},8,["value"])]),_:1},8,["style"]))],64)}var Ge=F(Fe,[["render",Pe],["__scopeId","data-v-21755626"]]);const qe={color:"#00FFFF",includeMax:!1,includeMin:!1,label:"",maxValue:"",minValue:"",position:""},Qe={colorInput:{border:"none",width:"50%"},input:{width:"80%"},message:{"align-items":"center",display:"flex","justify-content":"center","margin-bottom":"3%","text-align":"center"},table:{footer:{float:"right"}}},Ye={kpi:[{fieldName:"name",validators:[{key:"required"},{key:"regex",validator:{type:"extendedAlphanumericRegex"}}]},{fieldName:"description",validators:[{key:"regex",validator:{type:"extendedAlphanumericRegex"}}]}]};var L={newThreshold:qe,styles:Qe,validations:Ye};const je=N({components:{KnValidationMessages:B,Card:P,Sidebar:ce,Listbox:Q,Message:re,DataTable:G,Column:q,Checkbox:Y,Dropdown:ae,ColorPicker:pe,Dialog:Z},props:{selectedKpi:{type:Object},thresholdsList:Array,severityOptions:{type:Array,required:!1},thresholdTypeList:{type:Array,required:!1},loading:Boolean},emits:["touched"],data(){return{v$:R(),tabViewDescriptor:E,tresholdTabDescriptor:L,kpi:{},threshold:{},thresholdToClone:{},thresholdListVisible:!1,overrideDialogVisible:!1}},watch:{selectedKpi(){this.kpi=this.selectedKpi,this.threshold=this.kpi.threshold}},validations(){return{threshold:J("threshold",L.validations.kpi)}},methods:{setPositionOnReorder(e){this.kpi.threshold.thresholdValues=e.value,this.kpi.threshold.thresholdValues.forEach((t,r)=>{this.kpi.threshold.thresholdValues[r].position=r+1})},setSeverityCd(e,t){const r=this.severityOptions.findIndex(o=>o.valueId===e.value);t.severityCd=r>=0?this.severityOptions[r].valueCd:""},setTypeCd(e){const t=this.thresholdTypeList.findIndex(r=>r.valueId===e.value);this.threshold.type=t>=0?this.thresholdTypeList[t].translatedValueName:""},addNewThresholdItem(){const e={...L.newThreshold};e.position=this.kpi.threshold.thresholdValues.length+1,this.kpi.threshold.thresholdValues.push(e)},deleteThresholdItemConfirm(e){this.$confirm.require({message:this.$t("common.toast.deleteMessage"),header:this.$t("common.toast.deleteTitle"),icon:"pi pi-exclamation-triangle",accept:()=>this.deleteThresholdItem(e)})},deleteThresholdItem(e){this.kpi.threshold.thresholdValues.splice(e,1)},confirmToLoadThreshold(e){this.kpi.threshold.thresholdValues.length==0||this.kpi.threshold===L.newThreshold?this.loadSelectedThreshold(e):this.$confirm.require({message:this.$t("kpi.kpiDefinition.confirmOverride"),header:this.$t("kpi.kpiDefinition.thresholdAlreadyPresent"),icon:"pi pi-exclamation-triangle",accept:()=>this.loadSelectedThreshold(e)})},loadSelectedThreshold(e){this.thresholdToClone=[];let t="";return this.kpi.id?t=`/knowage/restful-services/1.0/kpi/${e.value.id}/loadThreshold?kpiId=${this.selectedKpi.id}`:t=`/knowage/restful-services/1.0/kpi/${e.value.id}/loadThreshold`,this.$http.get(t).then(r=>{this.thresholdToClone={...r.data},this.thresholdToClone.usedByKpi?this.overrideDialogVisible=!0:this.cloneSelectedThreshold()})},cloneSelectedThreshold(e){this.thresholdToClone.usedByKpi&&(e==="clone"?(this.thresholdToClone.name+=" ("+this.$t("kpi.kpiDefinition.clone")+")",this.thresholdToClone.id=void 0,this.thresholdToClone.usedByKpi=!1):e==="use"&&(this.thresholdToClone.usedByKpi=!0)),this.kpi.threshold=this.thresholdToClone,this.threshold=this.kpi.threshold,this.thresholdListVisible=!1,this.overrideDialogVisible=!1},cloneExistingThreshold(){this.kpi.threshold.name+=" ("+this.$t("kpi.kpiDefinition.clone")+")",this.kpi.threshold.id=void 0,this.kpi.threshold.usedByKpi=!1},onCellEditComplete(e){this.kpi.threshold.thresholdValues[e.index]=e.newData}}}),We={class:"p-fluid p-formgrid p-grid"},_e={class:"p-field p-col-12 p-md-4"},et={class:"p-float-label"},tt={for:"name",class:"kn-material-input-label"},ot={class:"p-field p-col-12 p-md-4"},rt={class:"p-float-label"},at={for:"description",class:"kn-material-input-label"},it={class:"p-field p-col-12 p-md-4"},nt={class:"p-float-label"},lt={for:"type",class:"kn-material-input-label"},st={class:"kn-list-item","data-test":"list-item"},dt={class:"kn-list-item-text"},ct={class:"kn-list-item-text-secondary"},pt={class:"p-mt-4"},bt={class:"p-d-flex p-jc-center"};function ut(e,t,r,o,d,p){const l=u("Button"),m=u("Message"),k=u("InputText"),a=u("KnValidationMessages"),f=u("Dropdown"),x=u("ProgressBar"),h=u("Column"),b=u("Checkbox"),g=u("ColorPicker"),w=u("DataTable"),A=u("Card"),S=u("Toolbar"),O=u("Listbox"),M=u("Sidebar"),j=u("Dialog"),W=ie("tooltip");return C(),D(z,null,[e.loading?T("",!0):(C(),V(A,{key:0,style:$(e.tabViewDescriptor.style.card)},{content:c(()=>[e.kpi.threshold.usedByKpi?(C(),V(m,{key:0,severity:"info",closable:!1,style:$(e.tresholdTabDescriptor.styles.message)},{default:c(()=>[K(v(e.$t("kpi.kpiDefinition.thresholdReused"))+" ",1),i(l,{label:e.$t("kpi.kpiDefinition.clone"),onClick:e.cloneExistingThreshold},null,8,["label","onClick"])]),_:1},8,["style"])):T("",!0),n("form",We,[n("div",_e,[n("span",et,[i(k,{id:"name",class:U(["kn-material-input",{"p-invalid":e.v$.threshold.name.$invalid&&e.v$.threshold.name.$dirty}]),type:"text",maxLength:"100",modelValue:e.v$.threshold.name.$model,"onUpdate:modelValue":t[0]||(t[0]=s=>e.v$.threshold.name.$model=s),modelModifiers:{trim:!0},onBlur:t[1]||(t[1]=s=>e.v$.threshold.name.$touch()),onChange:t[2]||(t[2]=s=>e.$emit("touched")),"data-test":"name-input"},null,8,["modelValue","class"]),n("label",tt,v(e.$t("common.name"))+" * ",1)]),i(a,{class:"p-mt-1",vComp:e.v$.threshold.name,additionalTranslateParams:{fieldName:e.$t("common.name")}},null,8,["vComp","additionalTranslateParams"])]),n("div",ot,[n("span",rt,[i(k,{id:"description",class:U(["kn-material-input",{"p-invalid":e.v$.threshold.description.$invalid&&e.v$.threshold.description.$dirty}]),type:"text",maxLength:"500",modelValue:e.v$.threshold.description.$model,"onUpdate:modelValue":t[3]||(t[3]=s=>e.v$.threshold.description.$model=s),modelModifiers:{trim:!0},onBlur:t[4]||(t[4]=s=>e.v$.threshold.description.$touch()),onChange:t[5]||(t[5]=s=>e.$emit("touched")),"data-test":"description-input"},null,8,["modelValue","class"]),n("label",at,v(e.$t("common.description")),1)]),i(a,{class:"p-mt-1",vComp:e.v$.threshold.description,additionalTranslateParams:{fieldName:e.$t("common.description")}},null,8,["vComp","additionalTranslateParams"])]),n("div",it,[n("span",nt,[i(f,{id:"type",class:"kn-material-input",modelValue:e.threshold.typeId,"onUpdate:modelValue":t[6]||(t[6]=s=>e.threshold.typeId=s),options:e.thresholdTypeList,optionLabel:"translatedValueName",optionValue:"valueId",onChange:e.setTypeCd},{option:c(s=>[n("span",null,v(s.option.translatedValueName),1)]),_:1},8,["modelValue","options","onChange"]),n("label",lt,v(e.$t("common.type")),1)])])]),e.loading?(C(),V(x,{key:1,mode:"indeterminate",class:"kn-progress-bar","data-test":"progress-bar"})):T("",!0),e.loading?T("",!0):(C(),V(w,{key:2,value:e.kpi.threshold.thresholdValues,loading:e.loading,editMode:"cell",class:"p-datatable-sm kn-table",dataKey:"id",responsiveLayout:"stack",breakpoint:"960px",onRowReorder:e.setPositionOnReorder,"data-test":"messages-table",onCellEditComplete:e.onCellEditComplete},{footer:c(()=>[i(l,{label:e.$t("kpi.kpiDefinition.addNewThreshold"),class:"p-button-link",style:$(e.tresholdTabDescriptor.styles.table.footer),onClick:e.addNewThresholdItem},null,8,["label","style","onClick"])]),default:c(()=>[i(h,{rowReorder:!0,headerStyle:"width: 3rem",reorderableColumn:!1}),i(h,{field:"label",header:e.$t("common.label")},{editor:c(s=>[i(k,{style:$(e.tresholdTabDescriptor.styles.input),modelValue:s.data.label,"onUpdate:modelValue":y=>s.data.label=y,onChange:t[7]||(t[7]=y=>e.$emit("touched"))},null,8,["style","modelValue","onUpdate:modelValue"])]),_:1},8,["header"]),i(h,{field:"minValue",header:e.$t("kpi.kpiDefinition.min")},{editor:c(s=>[i(k,{style:$(e.tresholdTabDescriptor.styles.input),modelValue:s.data.minValue,"onUpdate:modelValue":y=>s.data.minValue=y,type:"number",onChange:t[8]||(t[8]=y=>e.$emit("touched"))},null,8,["style","modelValue","onUpdate:modelValue"])]),_:1},8,["header"]),i(h,{field:"includeMin",header:e.$t("kpi.kpiDefinition.minInclude")},{body:c(s=>[i(b,{modelValue:s.data.includeMin,"onUpdate:modelValue":y=>s.data.includeMin=y,binary:!0,onChange:t[9]||(t[9]=y=>e.$emit("touched"))},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["header"]),i(h,{field:"maxValue",header:e.$t("kpi.kpiDefinition.max")},{editor:c(s=>[i(k,{style:$(e.tresholdTabDescriptor.styles.input),modelValue:s.data.maxValue,"onUpdate:modelValue":y=>s.data.maxValue=y,type:"number",onChange:t[10]||(t[10]=y=>e.$emit("touched"))},null,8,["style","modelValue","onUpdate:modelValue"])]),_:1},8,["header"]),i(h,{field:"includeMax",header:e.$t("kpi.kpiDefinition.maxInclude")},{body:c(s=>[i(b,{modelValue:s.data.includeMax,"onUpdate:modelValue":y=>s.data.includeMax=y,binary:!0,onChange:t[11]||(t[11]=y=>e.$emit("touched"))},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["header"]),i(h,{field:"severityId",header:"Severity"},{editor:c(s=>[i(f,{modelValue:s.data.severityId,"onUpdate:modelValue":y=>s.data.severityId=y,style:$(e.tresholdTabDescriptor.styles.input),options:e.severityOptions,optionLabel:"valueCd",optionValue:"valueId",onChange:y=>e.setSeverityCd(y,s.data)},{option:c(y=>[n("span",null,v(y.option.valueCd),1)]),_:2},1032,["modelValue","onUpdate:modelValue","style","options","onChange"])]),body:c(s=>[K(v(s.data.severityCd),1)]),_:1}),i(h,{field:"color",header:e.$t("kpi.kpiDefinition.color")},{body:c(s=>[i(g,{modelValue:s.data.color,"onUpdate:modelValue":y=>s.data.color=y,format:"hex",onChange:t[12]||(t[12]=y=>e.$emit("touched"))},null,8,["modelValue","onUpdate:modelValue"]),ne(i(k,{class:"kn-material-input",style:$(e.tresholdTabDescriptor.styles.colorInput),modelValue:s.data.color,"onUpdate:modelValue":y=>s.data.color=y,onChange:t[13]||(t[13]=y=>e.$emit("touched"))},null,8,["style","modelValue","onUpdate:modelValue"]),[[W,s.data.color,void 0,{top:!0}]])]),_:1},8,["header"]),i(h,{header:"",style:{"text-align":"right"}},{header:c(()=>[i(l,{label:e.$t("kpi.kpiDefinition.thresholdsListTitle"),class:"p-button-link",onClick:t[14]||(t[14]=s=>e.thresholdListVisible=!0)},null,8,["label"])]),body:c(s=>[i(l,{icon:"pi pi-trash",class:"p-button-link",onClick:y=>e.deleteThresholdItemConfirm(s.index)},null,8,["onClick"])]),_:1})]),_:1},8,["value","loading","onRowReorder","onCellEditComplete"]))]),_:1},8,["style"])),i(M,{class:"mySidebar",visible:e.thresholdListVisible,"onUpdate:visible":t[15]||(t[15]=s=>e.thresholdListVisible=s),showCloseIcon:!1,position:"right"},{default:c(()=>[i(S,{class:"kn-toolbar kn-toolbar--secondary"},{start:c(()=>[K(v(e.$t("kpi.kpiDefinition.thresholdsListTitle")),1)]),_:1}),i(O,{class:"kn-list--column",options:e.thresholdsList,filter:!0,filterPlaceholder:e.$t("common.search"),filterMatchMode:"contains",filterFields:e.tabViewDescriptor.filterFields,emptyFilterMessage:e.$t("common.info.noDataFound"),onChange:e.confirmToLoadThreshold},{empty:c(()=>[K(v(e.$t("common.info.noDataFound")),1)]),option:c(s=>[n("div",st,[n("div",dt,[n("span",null,v(s.option.name),1),n("span",ct,v(s.option.description),1)])])]),_:1},8,["options","filterPlaceholder","filterFields","emptyFilterMessage","onChange"])]),_:1},8,["visible"]),i(j,{class:"kn-dialog--toolbar--primary importExportDialog",visible:e.overrideDialogVisible,footer:"footer",header:e.$t("kpi.kpiDefinition.reusedTitle"),closable:!1,modal:""},{footer:c(()=>[n("div",bt,[i(l,{class:"kn-button kn-button--primary",label:e.$t("common.cancel"),onClick:t[16]||(t[16]=s=>e.overrideDialogVisible=!1)},null,8,["label"]),i(l,{class:"kn-button kn-button--primary",label:e.$t("kpi.kpiDefinition.useIt"),onClick:t[17]||(t[17]=s=>e.cloneSelectedThreshold("use"))},null,8,["label"]),i(l,{class:"kn-button kn-button--primary",label:e.$t("kpi.kpiDefinition.clone"),onClick:t[18]||(t[18]=s=>e.cloneSelectedThreshold("clone"))},null,8,["label"])])]),default:c(()=>[n("p",pt,v(e.$t("kpi.kpiDefinition.thresholdReused")),1)]),_:1},8,["visible","header"])],64)}var mt=F(je,[["render",ut]]);const kt=N({components:{TabView:le,TabPanel:se,KnValidationMessages:B,Listbox:Q,KpiDefinitionThresholdTab:mt,KpiDefinitionFormulaTab:Ne,Dialog:Z,AutoComplete:be,Checkbox:Y,KpiDefinitionCardinalityTab:Ge},props:{id:{type:String,required:!1},version:{type:String,required:!1},cloneKpiVersion:{type:Number},cloneKpiId:{type:Number}},computed:{buttonDisabled(){return!!(this.selectedKpi.threshold&&(this.formulaHasErrors===!0||!this.selectedKpi.threshold.name))}},emits:["touched","closed","kpiCreated","kpiUpdated"],data(){return{v$:R(),tabViewDescriptor:E,touched:!1,loading:!1,isAliasVisible:!1,reloadKpi:!1,updateMeasureList:!1,showSaveDialog:!1,aliasToInput:null,activeTab:0,previousActiveTab:-1,selectedKpi:{},kpiToSave:{},measureList:[],tresholdList:[],severityOptions:[],thresholdTypeList:[],kpiCategoryList:[],filteredCategories:[],formulaToSave:"",formulaHasErrors:!1}},validations(){return{selectedKpi:J("selectedKpi",E.validations.selectedKpi)}},setup(){return{store:H()}},async created(){this.loadPersistentData()},watch:{id(){this.loadSelectedKpi(),this.activeTab=0},cloneKpiId(){this.cloneKpiConfirm(this.cloneKpiId,this.cloneKpiVersion)}},methods:{async loadPersistentData(){this.loading=!0,await this.createGetKpiDataUrl("listMeasure").then(e=>{this.measureList=[...e.data]}),await this.createGetKpiDataUrl("listThreshold").then(e=>{this.tresholdList=[...e.data]}),await this.createGetTabViewDataUrl("SEVERITY").then(e=>{this.severityOptions=[...e.data]}),await this.createGetTabViewDataUrl("THRESHOLD_TYPE").then(e=>{this.thresholdTypeList=[...e.data]}),await this.createCategories("KPI_KPI_CATEGORY").then(e=>{this.kpiCategoryList=[...e.data]}),await this.loadSelectedKpi(),this.loading=!1},createGetTabViewDataUrl(e){return this.$http.get(`/knowage/restful-services/2.0/domains/listByCode/${e}`)},createCategories(e){return this.$http.get(`/knowage/restful-services/3.0/category/listByCode/${e}`)},createGetKpiDataUrl(e){return this.$http.get(`/knowage/restful-services/1.0/kpi/${e}`)},async loadSelectedKpi(){this.id?await this.$http.get(`/knowage/restful-services/1.0/kpi/${this.id}/${this.version}/loadKpi`).then(e=>{this.selectedKpi={...e.data};let t=JSON.parse(this.selectedKpi.definition);this.formulaToSave=t.formula}):this.selectedKpi={...E.emptyKpi}},onUpdateFormulaToSave(e){this.formulaToSave=e},setTouched(){this.touched=!0},toggleAlias(){this.isAliasVisible=!this.isAliasVisible},insertAlias(e){this.activeTab===0&&(this.aliasToInput=e)},ifErrorInFormula(e){e?(this.activeTab=0,this.formulaHasErrors=!0):(this.updateMeasureList=!0,this.formulaHasErrors=!1)},closeTemplateConfirm(){this.touched?this.$confirm.require({message:this.$t("common.toast.unsavedChangesMessage"),header:this.$t("common.toast.unsavedChangesHeader"),icon:"pi pi-exclamation-triangle",accept:()=>{this.touched=!1,this.closeTemplate()}}):this.closeTemplate()},closeTemplate(){this.$router.push("/kpi-definition"),this.$emit("closed")},cloneKpiConfirm(e,t){this.$confirm.require({icon:"pi pi-exclamation-triangle",message:this.$t("kpi.kpiDefinition.confirmClone"),header:this.$t(" "),accept:()=>this.cloneKpi(e,t)})},async cloneKpi(e,t){await this.$http.get(`/knowage/restful-services/1.0/kpi/${e}/${t}/loadKpi`).then(r=>{r.data.id=void 0,r.data.name=this.$t("kpi.kpiDefinition.copyOf")+r.data.name,this.selectedKpi={...r.data}})},setAutocompleteCategory(e){setTimeout(()=>{e.query.trim().length?this.filteredCategories=this.kpiCategoryList.filter(t=>t.valueCd.toLowerCase().startsWith(e.query.toLowerCase())):this.filteredCategories=[...this.kpiCategoryList]},250)},async saveKpi(){this.showSaveDialog=!1,this.touched=!1,this.kpiToSave={...this.selectedKpi},typeof this.kpiToSave.category!="object"&&(this.kpiToSave.category={valueCd:this.kpiToSave.category}),this.correctColors(this.kpiToSave.threshold.thresholdValues),typeof this.kpiToSave.definition=="object"&&(this.kpiToSave.definition.formula=this.formulaToSave,this.kpiToSave.definition=JSON.stringify(this.kpiToSave.definition)),typeof this.kpiToSave.cardinality=="object"&&(this.kpiToSave.cardinality=JSON.stringify(this.kpiToSave.cardinality)),await this.$http.post("/knowage/restful-services/1.0/kpi/saveKpi",this.kpiToSave).then(()=>{this.store.setInfo({title:this.$t("common.toast.success")}),this.kpiToSave.id===void 0?this.$emit("kpiCreated",this.kpiToSave.name):this.$emit("kpiUpdated"),this.reloadKpi=!0,setTimeout(()=>{this.reloadKpi=!1},250)}).catch(e=>{this.store.setError({title:this.$t("common.error.generic"),msg:e})})},correctColors(e){e.forEach(t=>{if(!t.color.includes("#")){let r="#"+t.color;t.color=r}})}}}),ht={class:"p-d-flex p-flex-row"},ft={class:"card kn-flex"},gt={key:0},vt={class:"kn-list-item","data-test":"list-item"},yt={class:"kn-list-item-text"},wt={class:"p-fluid p-formgrid p-grid"},xt={class:"p-field p-col-12 p-mt-4"},Ct={class:"p-float-label p-mb-2"},Mt={for:"name",class:"kn-material-input-label"},$t={class:"p-field-checkbox p-ml-2"},Tt={for:"versioning"};function At(e,t,r,o,d,p){const l=u("Button"),m=u("Toolbar"),k=u("ProgressBar"),a=u("KpiDefinitionFormulaTab"),f=u("TabPanel"),x=u("KpiDefinitionCardinalityTab"),h=u("KpiDefinitionThresholdTab"),b=u("TabView"),g=u("Listbox"),w=u("AutoComplete"),A=u("KnValidationMessages"),S=u("Checkbox"),O=u("Dialog");return C(),D(z,null,[i(m,{class:"kn-toolbar kn-toolbar--primary p-m-0"},{start:c(()=>[K(v(e.selectedKpi.name),1)]),end:c(()=>[i(l,{label:e.$t("kpi.kpiDefinition.aliasToolbarTitle"),style:$(e.tabViewDescriptor.style.aliasButton),class:"p-button-text p-button-rounded p-button-plain",onClick:e.toggleAlias},null,8,["label","style","onClick"]),i(l,{icon:"pi pi-save",class:"p-button-text p-button-rounded p-button-plain",onClick:t[0]||(t[0]=M=>e.showSaveDialog=!0),disabled:e.buttonDisabled},null,8,["disabled"]),i(l,{icon:"pi pi-times",class:"p-button-text p-button-rounded p-button-plain",onClick:e.closeTemplateConfirm},null,8,["onClick"])]),_:1}),e.loading?(C(),V(k,{key:0,mode:"indeterminate",class:"kn-progress-bar"})):T("",!0),n("div",ht,[n("div",ft,[i(b,{activeIndex:e.activeTab,"onUpdate:activeIndex":t[3]||(t[3]=M=>e.activeTab=M),class:"tabview-custom","data-test":"tab-view"},{default:c(()=>[i(f,null,{header:c(()=>[n("span",null,v(e.$t("kpi.kpiDefinition.formulaTitle")),1)]),default:c(()=>[i(a,{propKpi:e.selectedKpi,measures:e.measureList,loading:e.loading,aliasToInput:e.aliasToInput,checkFormula:e.checkFormula,activeTab:e.activeTab,reloadKpi:e.reloadKpi,showGuide:e.showGuide,onUpdateFormulaToSave:e.onUpdateFormulaToSave,onErrorInFormula:e.ifErrorInFormula,onTouched:e.setTouched,onOnGuideClose:t[1]||(t[1]=M=>e.$emit("onGuideClose"))},null,8,["propKpi","measures","loading","aliasToInput","checkFormula","activeTab","reloadKpi","showGuide","onUpdateFormulaToSave","onErrorInFormula","onTouched"])]),_:1}),i(f,null,{header:c(()=>[n("span",null,v(e.$t("kpi.kpiDefinition.cardinalityTtitle")),1)]),default:c(()=>[i(x,{selectedKpi:e.selectedKpi,loading:e.loading,updateMeasureList:e.updateMeasureList,onMeasureListUpdated:t[2]||(t[2]=M=>e.updateMeasureList=!1)},null,8,["selectedKpi","loading","updateMeasureList"])]),_:1}),i(f,null,{header:c(()=>[n("span",null,v(e.$t("kpi.kpiDefinition.tresholdTitle")),1)]),default:c(()=>[i(h,{selectedKpi:e.selectedKpi,thresholdsList:e.tresholdList,severityOptions:e.severityOptions,thresholdTypeList:e.thresholdTypeList,loading:e.loading,onTouched:e.setTouched},null,8,["selectedKpi","thresholdsList","severityOptions","thresholdTypeList","loading","onTouched"])]),_:1})]),_:1},8,["activeIndex"])]),e.isAliasVisible?(C(),D("div",gt,[i(m,{class:"kn-toolbar kn-toolbar--secondary",style:$(e.tabViewDescriptor.style.aliasList)},{start:c(()=>[K(v(e.$t("kpi.kpiDefinition.aliasToolbarTitle")),1)]),_:1},8,["style"]),i(g,{class:"kn-list--column",options:e.measureList,filter:!0,filterPlaceholder:e.$t("common.search"),optionLabel:"alias",filterMatchMode:"contains",filterFields:e.tabViewDescriptor.filterFields,emptyFilterMessage:e.$t("common.info.noDataFound"),onChange:t[4]||(t[4]=M=>e.insertAlias(M.value.alias)),"data-test":"kpi-list"},{empty:c(()=>[K(v(e.$t("common.info.noDataFound")),1)]),option:c(M=>[n("div",vt,[n("div",yt,[n("span",null,v(M.option.alias),1)])])]),_:1},8,["options","filterPlaceholder","filterFields","emptyFilterMessage"])])):T("",!0),i(O,{id:"saveDialog",class:"kn-dialog--toolbar--primary importExportDialog",style:$(e.tabViewDescriptor.style.saveDialog),visible:e.showSaveDialog,footer:"footer",closable:!1,modal:""},{header:c(()=>[n("h4",null,v(e.$t("kpi.kpiDefinition.addKpiAssociations")),1)]),footer:c(()=>[n("div",null,[i(l,{class:"kn-button kn-button--secondary",label:e.$t("common.cancel"),onClick:t[8]||(t[8]=M=>e.showSaveDialog=!1)},null,8,["label"]),i(l,{class:"kn-button kn-button--primary",label:e.$t("common.save"),onClick:e.saveKpi,disabled:e.v$.$invalid},null,8,["label","onClick","disabled"])])]),default:c(()=>[n("form",wt,[n("div",xt,[n("span",Ct,[i(w,{modelValue:e.v$.selectedKpi.category.$model,"onUpdate:modelValue":t[5]||(t[5]=M=>e.v$.selectedKpi.category.$model=M),class:U({"p-invalid":e.v$.selectedKpi.category.$invalid&&e.v$.selectedKpi.category.$dirty}),suggestions:e.filteredCategories,field:"valueName",onComplete:t[6]||(t[6]=M=>e.setAutocompleteCategory(M))},null,8,["modelValue","class","suggestions"]),n("label",Mt,v(e.$t("managers.configurationManagement.headers.category"))+" *",1)]),i(A,{vComp:e.v$.selectedKpi.category,additionalTranslateParams:{fieldName:e.$t("managers.configurationManagement.headers.category")}},null,8,["vComp","additionalTranslateParams"])]),n("div",$t,[i(S,{id:"versioning",modelValue:e.selectedKpi.enableVersioning,"onUpdate:modelValue":t[7]||(t[7]=M=>e.selectedKpi.enableVersioning=M),binary:!0},null,8,["modelValue"]),n("label",Tt,v(e.$t("kpi.kpiDefinition.enableVersioning")),1)])])]),_:1},8,["style","visible"])])],64)}var Lt=F(kt,[["render",At]]);export{Lt as default};
//# sourceMappingURL=KpiDefinitionDetail-dc1c4e63.js.map
