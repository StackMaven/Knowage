import{d as A,i as P,s as S,_ as E,r as l,y as D,o as s,h as u,w as c,f,z,l as R,n as I,x as $,a as g,t as h,c as y,C as F,D as M,G as U,A as w,g as T,B as N,q as B,a6 as L}from"./index-1e676509.js";import{K as O,d as X}from"./KnScheduler-d2aec922.js";import{f as C}from"./filterHelper-a723991a.js";import{m as j}from"./WorkspaceDescriptor-d4693b02.js";import{K as Q}from"./KnParameterSidebar-7c5f3d6f.js";const K=A({name:"data-preparation-monitoring-dialog",components:{Dialog:P,KnScheduler:O},props:{visibility:Boolean,dataset:Object},emits:["close","save","update:loading"],data(){return{schedulerDescriptor:X,logs:Array(),filters:{global:[C]},validSchedulation:Boolean,showHint:!1,currentCronExpression:"",cronExpressionType:"",touched:!1,schedulationPaused:!1,schedulationEnabled:!1,instanceId:"",loadingLogs:!1}},watch:{async visibility(o){this.store.setLoading(!0),this.logs=[],this.loadingLogs=!0,o&&await this.loadLogs(),this.store.setLoading(!1),this.loadingLogs=!1}},setup(){return{store:S()}},methods:{async loadLogs(){this.dataset&&this.dataset.id&&await this.$http.get("/knowage-data-preparation/api/1.0/process/by-destination-data-set/"+this.dataset.id).then(o=>{let r=o.data.instance;r&&(this.instanceId=r.id,this.currentCronExpression=r.config.cron,this.currentCronExpression||this.showHint,this.cronExpressionType=r.config.type,this.schedulationPaused=r.config.paused||!1,this.schedulationEnabled=!!this.currentCronExpression,this.$http.get("/knowage-data-preparation/api/1.0/process/logs/"+r.id).then(e=>{this.logs=e.data}))})},cancel(){this.touched?this.$confirm.require({message:this.$t("common.toast.unsavedChangesHeader"),header:this.$t("common.toast.unsavedChangesMessage"),icon:"pi pi-exclamation-triangle",accept:()=>this.resetAndClose()}):this.resetAndClose()},resetAndClose(){this.currentCronExpression="",this.cronExpressionType="",this.touched=!1,this.showHint=!1,this.$emit("close"),this.store.setLoading(!1)},setCronValid(o){this.validSchedulation=o.item},saveSchedulation(){let o={instanceId:this.instanceId,config:{}};this.schedulationEnabled&&(o.config.cron=this.currentCronExpression,o.config.paused=this.schedulationPaused,o.config.type=this.cronExpressionType),this.$emit("save",o),this.resetAndClose()},updateSchedulationPaused(o){this.schedulationPaused=o},updateSchedulationEnabled(o){this.schedulationEnabled=o},updateCurrentCronExpression(o){this.currentCronExpression=o},updateCronExpressionType(o){this.cronExpressionType=o}}});function J(o,r,e,a,n,b){const i=l("KnScheduler"),k=l("Button"),p=l("Dialog"),m=D("t");return s(),u(p,{class:"p-fluid kn-dialog--toolbar--primary schedulerDialog",visible:o.visibility,footer:"footer",header:o.$t("workspace.myData.monitoring"),modal:"",breakpoints:{"960px":"75vw","640px":"100vw"},closable:!1,baseZIndex:1,autoZIndex:!0},{footer:c(()=>[f(k,{visible:o.visibility,class:"kn-button--secondary",label:o.$t("common.cancel"),onClick:o.cancel},null,8,["visible","label","onClick"]),z(f(k,{visible:o.visibility,class:"kn-button--primary",onClick:o.saveSchedulation,disabled:!o.touched},null,8,["visible","onClick","disabled"]),[[m,"common.save"]])]),default:c(()=>[f(i,{class:"p-m-1",cronExpression:o.currentCronExpression,cronExpressionType:o.cronExpressionType,descriptor:o.schedulerDescriptor,onTouched:r[0]||(r[0]=t=>o.touched=!0),readOnly:!1,logs:o.logs,schedulationEnabled:o.schedulationEnabled,schedulationPaused:o.schedulationPaused,"onUpdate:schedulationPaused":o.updateSchedulationPaused,"onUpdate:schedulationEnabled":o.updateSchedulationEnabled,"onUpdate:currentCronExpression":o.updateCurrentCronExpression,"onUpdate:cronExpressionType":o.updateCronExpressionType,loadingLogs:o.loadingLogs},null,8,["cronExpression","cronExpressionType","descriptor","logs","schedulationEnabled","schedulationPaused","onUpdate:schedulationPaused","onUpdate:schedulationEnabled","onUpdate:currentCronExpression","onUpdate:cronExpressionType","loadingLogs"])]),_:1},8,["visible","header"])}var go=E(K,[["render",J]]);const Y={width:"200px"};var _={columnStyle:Y};const Z=A({name:"function-catalog-preview-table",components:{Column:R,DataTable:I},props:{previewColumns:{type:Array},previewRows:{type:Array},pagination:{type:Object},previewType:String},emits:["pageChanged","sort","filter"],data(){return{datasetPreviewTableDescriptor:_,columns:[],rows:[],filters:{global:[C]},globalFilterFields:[],lazyParams:{},sorted:"ASC",timer:null,searchInput:{},searchVisible:{},customFilters:[],first:0}},watch:{previewColumns(){this.loadColumns()},previewRows(){this.loadRows()},pagination(){this.loadPagination()}},created(){this.loadColumns(),this.loadRows(),this.loadPagination()},methods:{loadColumns(){var o;this.columns=[],(o=this.previewColumns)==null||o.forEach(r=>{this.columns.push(r),this.globalFilterFields.push(r.field),this.filters[r.field]={operator:$.AND,constraints:[C]}})},loadRows(){this.rows=this.previewRows},loadPagination(){this.lazyParams=this.pagination},onPage(o){this.lazyParams={paginationStart:o.first,paginationLimit:o.rows,paginationEnd:o.first+o.rows,size:this.lazyParams.size},this.$emit("pageChanged",this.lazyParams)},onSort(o){let r="";const e=this.columns.findIndex(n=>n.field===o.sortField);e!==-1&&(r=this.columns[e].header);const a=o.sortOrder===1?"asc":"desc";this.$emit("sort",{column:r,order:a})},onFilter(o){this.timer&&(clearTimeout(this.timer),this.timer=null),this.timer=setTimeout(()=>{const r={column:o.header,value:this.searchInput[o.field]},e=this.customFilters.findIndex(a=>a.column===o.header);e!==-1?r.value?this.customFilters[e]=r:this.customFilters.splice(e,1):this.customFilters.push(r),this.$emit("filter",this.customFilters)},1e3)}}}),G={id:"noFunctionsFound"},q={class:"dropdown"},H={clas:"p-d-flex p-flex-column"},W={class:"p-m-0"},oo={key:0,class:"dropdown-icon-container"},eo=["onClick"],ro={key:0,class:"dropdown-content"};function to(o,r,e,a,n,b){const i=l("InputText"),k=l("Column"),p=l("DataTable"),m=D("tooltip");return s(),u(p,{id:"preview-datatable",first:o.first,"onUpdate:first":r[0]||(r[0]=t=>o.first=t),value:o.rows,lazy:!0,paginator:o.lazyParams.size>15,rows:15,totalRecords:o.lazyParams.size,paginatorTemplate:"CurrentPageReport FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink",class:"p-datatable-sm kn-table kn-flex",filters:o.filters,"onUpdate:filters":r[1]||(r[1]=t=>o.filters=t),filterDisplay:"menu",currentPageReportTemplate:o.$t("common.table.footer.paginated",{first:"{first}",last:"{last}",totalRecords:"{totalRecords}"}),stripedRows:"",responsiveLayout:"stack",breakpoint:"960px",onPage:r[2]||(r[2]=t=>o.onPage(t)),onSort:o.onSort},{empty:c(()=>[g("div",G,h(o.$t("common.info.noDataFound")),1)]),default:c(()=>[(s(!0),y(N,null,F(o.columns,t=>(s(),u(k,{class:"kn-truncated",style:M(o.datasetPreviewTableDescriptor.columnStyle),field:t.field,key:t.field,sortable:o.previewType!=="dataset"},{header:c(()=>[g("div",q,[g("div",H,[g("p",W,h(t.header),1),g("small",null,h(t.type),1)]),o.previewType!=="dataset"?(s(),y("div",oo,[g("i",{class:U(["pi pi-filter-icon pi-filter p-ml-5",{"filter-icon-active":o.searchInput[t.field]}]),onClick:d=>o.searchVisible[t.field]=!o.searchVisible[t.field]},null,10,eo),o.searchVisible[t.field]?(s(),y("div",ro,[f(i,{modelValue:o.searchInput[t.field],"onUpdate:modelValue":d=>o.searchInput[t.field]=d,class:"p-inputtext-sm p-column-filter",onInput:d=>o.onFilter(t)},null,8,["modelValue","onUpdate:modelValue","onInput"])])):w("",!0)])):w("",!0)])]),body:c(d=>[z((s(),y("span",null,[T(h(d.data[t.field]),1)])),[[m,d.data[t.field],void 0,{top:!0}]])]),_:2},1032,["style","field","sortable"]))),128))]),_:1},8,["first","value","paginator","totalRecords","filters","currentPageReportTemplate","onSort"])}var ao=E(Z,[["render",to]]);const no={contentStyle:{display:"flex",flex:"1","flex-direction":"column","padding-bottom":"0"},style:{display:"flex","flex-direction":"column","max-height":"90%","max-width":"80%","min-height":"435px","min-width":"600px"}};var io={dialog:no};const lo=A({name:"kpi-scheduler-save-dialog",components:{Dialog:P,DatasetPreviewTable:ao,Message:B,KnParameterSidebar:Q},props:{visible:{type:Boolean},propDataset:{type:Object},previewType:String,loadFromDatasetManagement:Boolean},emits:["close"],data(){return{mainDescriptor:j,workspaceDataPreviewDialogDescriptor:io,dataset:null,columns:[],rows:[],pagination:{start:0,limit:15},sort:null,filter:null,errorMessageVisible:!1,errorMessage:"",parameterSidebarVisible:!1,loading:!1,filtersData:{},userRole:null,sidebarMode:"workspaceView"}},computed:{isParameterSidebarVisible(){var e,a;let o=!1;for(let n=0;n<((a=(e=this.filtersData)==null?void 0:e.filterStatus)==null?void 0:a.length);n++)if(this.filtersData.filterStatus[n].showOnPanel==="true"){o=!0;break}let r=!1;return this.dataset&&this.dataset.pars&&this.dataset.pars.length!==0&&(r=this.dataset.pars.length!==0),o||r}},watch:{async propDataset(){this.visible&&await this.loadPreview()},async visible(o){o&&await this.loadPreview()},previewType(){this.setSidebarMode()}},setup(){return{store:S()}},async created(){this.userRole=this.store.$state.user.sessionRole!==this.$t("role.defaultRolePlaceholder")?this.store.$state.user.sessionRole:null,await this.loadPreview(),this.setSidebarMode()},methods:{async loadPreview(){if(this.loadDataset(),this.dataset.drivers&&this.dataset.drivers.length>0)if(this.userRole)await this.loadDatasetDrivers();else{this.parameterSidebarVisible=!0;return}this.dataset.label&&this.dataset.pars.length===0&&(this.filtersData.isReadyForExecution===void 0||this.filtersData.isReadyForExecution)?(this.loadFromDatasetManagement?await this.loadPreSavePreview():await this.loadPreviewData(),this.parameterSidebarVisible=!1):this.parameterSidebarVisible=!0},loadDataset(){this.dataset=this.propDataset},async loadPreSavePreview(){var r;this.loading=!0;const o={...this.dataset};o.start=this.pagination.start,((r=this.filtersData.filterStatus)==null?void 0:r.length)>0&&(o.DRIVERS=this.formatDriversForPreviewData()),await this.$http.post("/knowage/restful-services/1.0/datasets/preview",o,{headers:{"X-Disable-Errors":"true"}}).then(e=>{this.setPreviewColumns(e.data),this.rows=e.data.rows,this.pagination.size=e.data.results}).catch(e=>{this.errorMessage=e.message,this.errorMessageVisible=!0}),this.loading=!1},async loadPreviewData(){var r;this.loading=!0;const o={...this.pagination};this.sort&&(o.sorting=this.sort),this.filter&&(o.filters=this.filter),this.dataset.pars.length>0&&(o.pars=[...this.dataset.pars]),((r=this.filtersData.filterStatus)==null?void 0:r.length)>0&&(o.drivers=this.formatDriversForPreviewData()),await this.$http.post(`/knowage/restful-services/2.0/datasets/${this.dataset.label}/preview`,o,{headers:{"X-Disable-Errors":"true"}}).then(e=>{this.setPreviewColumns(e.data),this.rows=e.data.rows,this.pagination.size=e.data.results}).catch(e=>{this.errorMessage=e.message,this.errorMessageVisible=!0}),this.loading=!1},async loadDatasetDrivers(){let o=!1;return this.dataset.label&&this.dataset.id&&this.dataset.dsTypeCd!=="Prepared"&&(await this.$http.post(`/knowage/restful-services/3.0/datasets/${this.dataset.label}/filters`,{role:this.userRole}).then(r=>{this.filtersData=r.data,this.filtersData.filterStatus&&(this.filtersData.filterStatus=this.filtersData.filterStatus.filter(e=>e.id))}).catch(()=>{o=!0}),this.formatDrivers()),o},formatDrivers(){var o,r;(r=(o=this.filtersData)==null?void 0:o.filterStatus)==null||r.forEach(e=>{var a,n,b,i,k;if(e.parameterValue=e.multivalue?[]:[{value:"",description:""}],((a=e.driverDefaultValue)==null?void 0:a.length)>0){let p="_col0",m="col1";(n=e.metadata)!=null&&n.colsMap&&(p=Object.keys((b=e.metadata)==null?void 0:b.colsMap).find(t=>e.metadata.colsMap[t]===e.metadata.valueColumn),m=Object.keys((i=e.metadata)==null?void 0:i.colsMap).find(t=>e.metadata.colsMap[t]===e.metadata.descriptionColumn)),e.parameterValue=e.driverDefaultValue.map(t=>{var d,x;return{value:(d=t.value)!=null?d:t[p],description:(x=t.desc)!=null?x:t[m]}}),e.type==="DATE"&&!e.selectionType&&e.valueSelection==="man_in"&&e.showOnPanel==="true"&&(e.parameterValue[0].value=L((k=e.parameterValue[0].description)==null?void 0:k.split("#")[0]).toDate())}e.data&&(e.data=e.data.map(p=>this.formatParameterDataOptions(e,p)),e.data.length===1&&(e.parameterValue=[...e.data])),(e.selectionType==="COMBOBOX"||e.selectionType==="LIST")&&e.multivalue&&e.mandatory&&e.data.length===1&&(e.showOnPanel="false"),e.parameterValue||(e.parameterValue=[{value:"",description:""}]),e.parameterValue[0]&&!e.parameterValue[0].description&&(e.parameterValue[0].description=e.parameterDescription?e.parameterDescription[0]:"")})},formatParameterDataOptions(o,r){const e=o.metadata.valueColumn,a=o.metadata.descriptionColumn,n=Object.keys(o.metadata.colsMap).find(i=>o.metadata.colsMap[i]===e),b=Object.keys(o.metadata.colsMap).find(i=>o.metadata.colsMap[i]===a);return{value:n?r[n]:"",description:b?r[b]:""}},formatDriversForPreviewData(){var r;let o={};return(r=this.filtersData)==null||r.filterStatus.forEach(e=>{o[e.urlName]=e.parameterValue}),o},async updatePagination(o){this.pagination.start=o.paginationStart,this.pagination.limit=o.paginationLimit,this.loadFromDatasetManagement?await this.loadPreSavePreview():await this.loadPreviewData(),this.parameterSidebarVisible=!1},async onSort(o){this.sort=o,this.loadFromDatasetManagement?await this.loadPreSavePreview():await this.loadPreviewData()},async onFilter(o){this.filter=o,this.loadFromDatasetManagement?await this.loadPreSavePreview():await this.loadPreviewData()},setPreviewColumns(o){this.columns=[];for(let r=1;r<o.metaData.fields.length;r++)this.columns.push({header:o.metaData.fields[r].header,field:o.metaData.fields[r].name,type:o.metaData.fields[r].type})},closeDialog(){this.dataset=null,this.rows=[],this.columns=[],this.pagination={start:0,limit:15},this.sort=null,this.filter=null,this.errorMessageVisible=!1,this.errorMessage="",this.parameterSidebarVisible=!1,this.$emit("close")},async onExecute(o){this.dataset.pars||(this.dataset.pars=[]),this.dataset.pars=o,this.loadFromDatasetManagement?await this.loadPreSavePreview():await this.loadPreviewData(),this.parameterSidebarVisible=!1},setSidebarMode(){this.sidebarMode=this.loadFromDatasetManagement?"datasetManagement":"workspaceView"},async onRoleChange(o){this.userRole=o,this.filtersData={};let r=!1;this.dataset.drivers&&this.dataset.drivers.length>0&&(r=await this.loadDatasetDrivers()),!r&&this.dataset.label&&this.dataset.pars.length===0&&(this.filtersData.isReadyForExecution===void 0||this.filtersData.isReadyForExecution)?(this.loadFromDatasetManagement?await this.loadPreSavePreview():await this.loadPreviewData(),this.parameterSidebarVisible=!1):this.parameterSidebarVisible=!0}}}),so={class:"p-d-flex p-flex-column kn-flex workspace-scrollable-table"};function co(o,r,e,a,n,b){const i=l("Button"),k=l("Toolbar"),p=l("ProgressBar"),m=l("Message"),t=l("DatasetPreviewTable"),d=l("KnParameterSidebar"),x=l("Dialog"),V=D("tooltip");return s(),u(x,{style:M(o.workspaceDataPreviewDialogDescriptor.dialog.style),contentStyle:o.workspaceDataPreviewDialogDescriptor.dialog.contentStyle,visible:o.visible,modal:!0,class:"p-fluid kn-dialog--toolbar--primary",closable:!1},{header:c(()=>[f(k,{class:"kn-toolbar kn-toolbar--primary p-col-12",style:M(o.mainDescriptor.style.maxWidth)},{start:c(()=>{var v;return[g("span",null,h((v=o.dataset)==null?void 0:v.label),1)]}),end:c(()=>[o.isParameterSidebarVisible?z((s(),u(i,{key:0,icon:"pi pi-filter",class:"p-button-text p-button-rounded p-button-plain",onClick:r[0]||(r[0]=v=>o.parameterSidebarVisible=!o.parameterSidebarVisible)},null,512)),[[V,o.$t("common.filter"),void 0,{bottom:!0}]]):w("",!0),f(i,{class:"kn-button p-button-text p-button-plain",label:o.$t("common.close"),onClick:o.closeDialog},null,8,["label","onClick"])]),_:1},8,["style"])]),default:c(()=>[o.loading?(s(),u(p,{key:0,mode:"indeterminate",class:"kn-progress-bar p-ml-2","data-test":"progress-bar"})):w("",!0),g("div",so,[o.errorMessageVisible?(s(),u(m,{key:0,class:"p-m-2",severity:"warn",closable:!1,style:M(o.mainDescriptor.style.message)},{default:c(()=>[T(h(o.errorMessage),1)]),_:1},8,["style"])):(s(),u(t,{key:1,class:"p-d-flex p-flex-column kn-flex p-m-2",previewColumns:o.columns,previewRows:o.rows,pagination:o.pagination,previewType:o.previewType,onPageChanged:r[1]||(r[1]=v=>o.updatePagination(v)),onSort:o.onSort,onFilter:o.onFilter},null,8,["previewColumns","previewRows","pagination","previewType","onSort","onFilter"])),o.parameterSidebarVisible&&o.dataset?(s(),u(d,{key:2,style:{height:"calc(100% - 35px)"},class:"workspace-parameter-sidebar kn-overflow-y",filtersData:o.filtersData,propDocument:o.dataset,propMode:o.sidebarMode,propQBEParameters:o.dataset.pars,userRole:o.userRole,dataset:o.dataset,onExecute:o.onExecute,onRoleChanged:o.onRoleChange},null,8,["filtersData","propDocument","propMode","propQBEParameters","userRole","dataset","onExecute","onRoleChanged"])):w("",!0)])]),_:1},8,["style","contentStyle","visible"])}var ho=E(lo,[["render",co]]);export{go as D,ho as W};
//# sourceMappingURL=WorkspaceDataPreviewDialog-5099e5c1.js.map
