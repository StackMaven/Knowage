import{a6 as F,d as M,a5 as N,ad as E,_ as A,r as i,o as k,h as v,w as f,c as h,a as r,f as s,t as m,A as w,s as D,a7 as x,W as $,g as z,l as S,n as V,C as U,D as T,B as I}from"./index-1e676509.js";import{t as _}from"./TimespanDescriptor-40eb9dcc.js";import{s as B}from"./calendar.esm-60a451ba.js";function y(e){return F(e,"DD/MM/yyyy").toDate()}const L=M({name:"timespan-form",components:{Dropdown:N,Card:E},props:{propTimespan:{type:Object},categories:{type:Array}},emits:["touched"],data(){return{timespanDescriptor:_,timespan:null}},watch:{propTimespan(){this.loadTimespan()}},created(){this.loadTimespan()},methods:{loadTimespan(){this.timespan=this.propTimespan},onTypeChange(){this.timespan&&(this.$emit("touched"),this.timespan.definition=[])}}}),O={key:0,class:"p-fluid p-formgrid p-grid"},H={class:"p-field p-col-4"},X={class:"p-float-label"},Q={class:"kn-material-input-label"},j={class:"p-field p-col-4"},Y={class:"p-float-label"},R={key:0},J={class:"timespan-type-value"},G={class:"kn-material-input-label"},q={class:"p-field p-col-4"},K={class:"p-float-label"},Z={class:"kn-material-input-label"};function P(e,t,a,o,l,d){const c=i("InputText"),b=i("Dropdown"),p=i("Card");return k(),v(p,{class:"p-m-2"},{content:f(()=>[e.timespan?(k(),h("form",O,[r("div",H,[r("span",X,[s(c,{class:"kn-material-input",modelValue:e.timespan.name,"onUpdate:modelValue":t[0]||(t[0]=n=>e.timespan.name=n),maxLength:"100",onInput:t[1]||(t[1]=n=>e.$emit("touched"))},null,8,["modelValue"]),r("label",Q,m(e.$t("common.name"))+" *",1)])]),r("div",j,[r("span",Y,[s(b,{class:"kn-material-input",modelValue:e.timespan.type,"onUpdate:modelValue":t[2]||(t[2]=n=>e.timespan.type=n),options:e.timespanDescriptor.typeValues,optionValue:"value",optionLabel:"label",onChange:e.onTypeChange},{value:f(n=>[n.value?(k(),h("div",R,[r("span",J,m(n.value),1)])):w("",!0)]),option:f(n=>[r("span",null,m(e.$t(n.option.label)),1)]),_:1},8,["modelValue","options","onChange"]),r("label",G,m(e.$t("common.type"))+" *",1)])]),r("div",q,[r("span",K,[s(b,{class:"kn-material-input",modelValue:e.timespan.category,"onUpdate:modelValue":t[3]||(t[3]=n=>e.timespan.category=n),options:e.categories,optionValue:"VALUE_ID",optionLabel:"VALUE_NM",onChange:t[4]||(t[4]=n=>e.$emit("touched"))},null,8,["modelValue","options"]),r("label",Z,m(e.$t("common.category")),1)])])])):w("",!0)]),_:1})}var W=A(L,[["render",P]]);const ee=M({name:"timespan-interval-form",components:{Calendar:B},props:{propTimespan:{type:Object}},emits:["touched"],data(){return{interval:{},timespan:null}},watch:{propTimespan(){this.loadTimespan()},timespanType(){this.loadTimespan()}},computed:{addButtonDisabled(){return!this.interval.from||!this.interval.to},timespanType(){var e;return(e=this.timespan)==null?void 0:e.type}},setup(){return{store:D()}},created(){this.loadTimespan()},methods:{loadTimespan(){this.timespan=this.propTimespan,this.initializeInterval()},initializeInterval(){this.interval={to:new Date,from:new Date}},onAddInterval(){var t;const e=x(this.interval);((t=this.timespan)==null?void 0:t.type)==="temporal"?this.createNewTemporalInterval(e):this.createNewTimeInterval(e),this.$emit("touched")},createNewTimeInterval(e){if(!(e.from instanceof Date)||!(e.to instanceof Date)){this.store.setError({title:this.$t("common.toast.errorTitle"),msg:this.$t("managers.timespan.invalidDatesError")});return}const t=this.getHoursAndMinutes(e.from),a=this.getHoursAndMinutes(e.to),o=this.createDateFromHoursAndMinutes(t),l=this.createDateFromHoursAndMinutes(a);if(o>l){this.store.setError({title:this.$t("common.toast.errorTitle"),msg:this.$t("managers.timespan.startTimeGreaterError")});return}this.addNewTimeInterval(e,t,a,o,l)},addNewTimeInterval(e,t,a,o,l){if(this.timespan){for(let d in this.timespan.definition){const c=this.createDateFromHoursAndMinutes(this.timespan.definition[d].from),b=this.createDateFromHoursAndMinutes(this.timespan.definition[d].to);if(o<=b&&l>=c){this.store.setError({title:this.$t("common.toast.errorTitle"),msg:this.$t("managers.timespan.timeOverlapError")});return}}e.from=t,e.to=a,this.timespan.definition.push(e),this.refreshTimeInterval(o,l)}},refreshTimeInterval(e,t){this.interval.from=new Date(t+6e4);const o=t-e;this.interval.to=new Date(t+6e4+o),this.interval=x(this.interval)},createNewTemporalInterval(e){if(!(e.from instanceof Date)||!(e.to instanceof Date)){this.store.setError({title:this.$t("common.toast.errorTitle"),msg:this.$t("managers.timespan.invalidDatesError")});return}const t=e.from,a=e.to;if(t>a){this.store.setError({title:this.$t("common.toast.errorTitle"),msg:this.$t("managers.timespan.startDateGreaterError")});return}this.addNewTemporalInterval(t,a)},addNewTemporalInterval(e,t){if(this.timespan){for(let c in this.timespan.definition){const b=y(this.timespan.definition[c].from),p=y(this.timespan.definition[c].to);if(e<=p&&t>=b){this.store.setError({title:this.$t("common.toast.errorTitle"),msg:this.$t("managers.timespan.temporalOverlapError")});return}}const a=this.getFormattedDateString(e),o=this.getFormattedDateString(t),l=this.getFormattedDate(a),d=this.getFormattedDate(o);this.timespan.definition.push({from:a,to:o,fromLocalized:l,toLocalized:d}),this.refreshTimespanInterval(e,t)}},refreshTimespanInterval(e,t){this.interval.from=t,this.interval.from.setTime(t.getTime()+864e5),this.interval.to=new Date,this.interval.to.setTime(this.interval.from.getTime()+t.getTime()-e.getTime()-864e5),this.interval=x(this.interval)},padTo2Digits(e){return String(e).padStart(2,"0")},getFormattedDate(e){return $(e,"","DD/MM/yyyy")},getHoursAndMinutes(e){return this.padTo2Digits(e.getHours())+":"+this.padTo2Digits(e.getMinutes())},createDateFromHoursAndMinutes(e){return Date.parse("01/01/2011 "+e)},getFormattedDateString(e){return("0"+e.getDate()).slice(-2)+"/"+("0"+(e.getMonth()+1)).slice(-2)+"/"+e.getFullYear()}}}),te={key:0,class:"p-d-flex kn-flex"},ae={class:"timespan-interval-calendar p-fluid kn-flex"},oe={class:"p-float-label"},re={class:"kn-material-input-label"},ne={class:"timespan-interval-calendar p-fluid kn-flex p-mx-auto"},ie={class:"p-float-label"},le={class:"kn-material-input-label"};function de(e,t,a,o,l,d){const c=i("Calendar"),b=i("Button");return e.timespan?(k(),h("div",te,[r("div",ae,[r("span",oe,[s(c,{modelValue:e.interval.from,"onUpdate:modelValue":t[0]||(t[0]=p=>e.interval.from=p),manualInput:!0,timeOnly:e.timespan.type==="time",hourFormat:"24"},null,8,["modelValue","timeOnly"]),r("label",re,m(e.$t("common.from")),1)])]),r("div",ne,[r("span",ie,[s(c,{modelValue:e.interval.to,"onUpdate:modelValue":t[1]||(t[1]=p=>e.interval.to=p),manualInput:!0,timeOnly:e.timespan.type==="time",hourFormat:"24"},null,8,["modelValue","timeOnly"]),r("label",le,m(e.$t("common.to")),1)])]),s(b,{id:"timespan-interval-add-button",class:"kn-button kn-button--primary p-ml-auto",disabled:e.addButtonDisabled,onClick:e.onAddInterval,"data-test":"add-button"},{default:f(()=>[z(m(e.$t("common.add")),1)]),_:1},8,["disabled","onClick"])])):w("",!0)}var ce=A(ee,[["render",de],["__scopeId","data-v-3fca88be"]]);const se=M({name:"timespan-interval-table",props:{propTimespan:{type:Object}},components:{Column:S,DataTable:V,Card:E,TimespanIntervalForm:ce},data(){return{timespanDescriptor:_,timespan:null}},watch:{propTimespan(){this.loadTimespan()}},computed:{columns(){var e;return((e=this.timespan)==null?void 0:e.type)==="temporal"?this.timespanDescriptor.temporalColumns:this.timespanDescriptor.timeColumns}},created(){this.loadTimespan()},methods:{loadTimespan(){this.timespan=this.propTimespan},deleteInterval(e){if(this.timespan){const t=this.timespan.definition.findIndex(a=>e.from===a.from&&e.to===a.to);t!==-1&&this.timespan.definition.splice(t,1)}}}});function be(e,t,a,o,l,d){const c=i("TimespanIntervalForm"),b=i("Column"),p=i("Button"),n=i("DataTable"),C=i("Card");return k(),v(C,{class:"p-m-2"},{content:f(()=>{var u;return[s(c,{propTimespan:e.propTimespan},null,8,["propTimespan"]),e.timespan&&((u=e.timespan.definition)==null?void 0:u.length)>0?(k(),v(n,{key:0,class:"p-datatable-sm kn-table p-m-2",value:e.timespan.definition,responsiveLayout:"stack",breakpoint:"960px",scrollable:!0,scrollHeight:"60vh"},{default:f(()=>[(k(!0),h(I,null,U(e.columns,g=>(k(),v(b,{key:g.header,field:g.field,header:e.$t(g.header),style:T(g.style)},null,8,["field","header","style"]))),128)),s(b,{style:T(e.timespanDescriptor.iconColumnStyle)},{body:f(g=>[s(p,{icon:"pi pi-trash",class:"p-button-link",onClick:ue=>e.deleteInterval(g.data)},null,8,["onClick"])]),_:1},8,["style"])]),_:1},8,["value"])):w("",!0)]}),_:1})}var pe=A(se,[["render",be]]);const ke=M({name:"timespan-detail",components:{TimespanForm:W,TimespanIntervalTable:pe},props:{id:{type:String},clone:{type:String},categories:{type:Array},timespans:{type:Array,required:!0}},emits:["timespanCreated"],data(){return{timespan:null,operation:"create",loading:!1,touched:!1}},computed:{saveDisabled(){return!this.timespan||!this.timespan.name||this.timespan.definition.length===0}},watch:{id(){this.loadTimespan()},clone(){var e;this.id==((e=this.timespan)==null?void 0:e.id)&&this.loadTimespan()}},setup(){return{store:D()}},created(){this.loadTimespan()},methods:{async loadTimespan(){this.loading=!0,this.touched=!1,this.id?(await this.$http.get(`/knowage/restful-services/1.0/timespan/loadTimespan?ID=${this.id}`).then(e=>{var t;this.timespan=e.data,((t=this.timespan)==null?void 0:t.type)==="temporal"&&this.formatIntervalDates()}).catch(()=>{}),this.clone==="true"&&await this.cloneTimespan()):this.timespan=this.getDefautTimespan(),this.loading=!1},formatIntervalDates(){this.timespan&&this.timespan.definition.forEach(e=>{e.fromLocalized=this.getFormattedDate(e.from),e.toLocalized=this.getFormattedDate(e.to)})},getFormattedDate(e){return $(e,"","DD/MM/yyyy")},getDefautTimespan(){return{name:"",type:"time",definition:[],category:"",isnew:!0}},closeTimespanDetailsConfirm(){this.touched?this.$confirm.require({message:this.$t("common.toast.unsavedChangesMessage"),header:this.$t("common.toast.unsavedChangesHeader"),icon:"pi pi-exclamation-triangle",accept:()=>{this.closeTimespanDetails()}}):this.closeTimespanDetails()},closeTimespanDetails(){this.touched=!1,this.timespan=null,this.$router.push("/timespan")},async saveTimespan(e){const t=e!=null?e:this.timespan;if(!!t){if(t.definition.length===0){this.store.setError({title:this.$t("common.toast.errorTitle"),msg:this.$t("managers.timespan.noIntervalError")});return}this.operation=t.id?"update":"create",this.loading=!0,await this.$http.post("/knowage/restful-services/1.0/timespan/saveTimespan",t).then(a=>{var o;this.store.setInfo({title:this.$t("common.toast."+this.operation+"Title"),msg:this.$t("common.toast.success")}),this.operation==="create"&&t.isnew&&(t.id=(o=a.data)==null?void 0:o.id,delete t.isnew,this.$router.push(`/timespan/edit-timespan?id=${t.id}&clone=false`)),this.$emit("timespanCreated")}).catch(()=>{}),this.loading=!1}},async cloneTimespan(){const e=x(this.timespan);if(!e){this.$router.push("/timespan"),this.timespan=this.getDefautTimespan();return}delete e.id,e.isnew=!0,this.genereateClonedTimespanName(e),!this.checkIfCloneAlreadyDefined(e)&&(this.createFirstIntervalForClonedTimespan(e),await this.saveTimespan(e))},genereateClonedTimespanName(e){new RegExp(/.*#.*\d/gi).test(e.name)?e.name=e.name.substring(0,e.name.length-1)+""+(parseInt(e.name[e.name.length-1])+1):e.name=e.name+" #2"},checkIfCloneAlreadyDefined(e){let t=!1;for(let a=0;a<this.timespans.length;a++)if(this.timespans[a].name===e.name){this.store.setError({title:this.$t("common.toast.errorTitle"),msg:this.$t("managers.timespan.cloneAlreadyDefined")}),this.$router.push("/timespan"),this.timespan=this.getDefautTimespan(),t=!0;break}return t},createFirstIntervalForClonedTimespan(e){const t=e.definition[e.definition.length-1],a=y(t.from),o=y(t.to),l=864e5,d={from:o,to:new Date};d.from.setTime(o.getTime()+l),d.to.setTime(d.from.getTime()+o.getTime()-a.getTime()-l),t.from=this.getFormattedDateString(d.from),t.to=this.getFormattedDateString(d.to),e.definition=[t]},getFormattedDateString(e){return e.getDate()+"/"+(e.getMonth()+1)+"/"+e.getFullYear()}}}),me={class:"p-d-flex p-flex-column kn-flex kn-overflow"};function fe(e,t,a,o,l,d){const c=i("Button"),b=i("Toolbar"),p=i("ProgressBar"),n=i("TimespanForm"),C=i("TimespanIntervalTable");return k(),h(I,null,[s(b,{class:"kn-toolbar kn-toolbar--primary p-m-0"},{start:f(()=>{var u;return[z(m((u=e.timespan)==null?void 0:u.name),1)]}),end:f(()=>[s(c,{icon:"pi pi-save",class:"p-button-text p-button-rounded p-button-plain",disabled:e.saveDisabled,onClick:t[0]||(t[0]=u=>e.saveTimespan(null)),"data-test":"save-button"},null,8,["disabled"]),s(c,{icon:"pi pi-times",class:"p-button-text p-button-rounded p-button-plain",onClick:e.closeTimespanDetailsConfirm},null,8,["onClick"])]),_:1}),e.loading?(k(),v(p,{key:0,class:"kn-progress-bar",mode:"indeterminate","data-test":"progress-bar"})):w("",!0),r("div",me,[s(n,{propTimespan:e.timespan,categories:e.categories,onTouched:t[1]||(t[1]=u=>e.touched=!0)},null,8,["propTimespan","categories"]),s(C,{propTimespan:e.timespan,onTouched:t[2]||(t[2]=u=>e.touched=!0)},null,8,["propTimespan"])])],64)}var we=A(ke,[["render",fe]]);export{we as default};
//# sourceMappingURL=TimespanDetail-df8f0326.js.map
