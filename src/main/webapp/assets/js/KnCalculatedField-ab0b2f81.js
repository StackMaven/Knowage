import{u as S,c as V}from"./KnValidatonMessages-ebe48c72.js";import{d as T,i as B,a5 as I,q as L,aG as U,ah as J,aX as P,_ as Q,r as d,y as E,o as i,h as $,w as p,f as l,G as x,z as M,A as z,g as H,t as s,a,J as K,c,C as D,B as N}from"./index-1e676509.js";import{K as R}from"./KnHint-6d455703.js";const X=T({name:"calculated-field",components:{Dialog:B,Dropdown:I,KnHint:R,Message:L,ScrollPanel:U,VCodeMirror:J},props:{fields:Array,visibility:Boolean,readOnly:Boolean,descriptor:Object,template:{},valid:Boolean,source:String,propCalcFieldFunctions:{type:Array,required:!0}},data(){return{cf:{formula:""},allCategories:{name:"ALL",code:"ALL"},selectedFunction:{},selectedCategory:"",availableCategories:[],codeMirror:null,availableFunctions:[],scriptOptions:{mode:"text/x-mathematica",indentWithTabs:!0,smartIndent:!0,lineWrapping:!0,matchBrackets:!0,autofocus:!0,theme:"eclipse",lineNumbers:!0,readOnly:this.readOnly},v$:S(),formulaValidationInterval:{},isValidFormula:!1,calcFieldFunctions:[],showHelpPanel:!1}},emits:["save","cancel","update:readOnly"],created(){this.calcFieldFunctions=[...this.propCalcFieldFunctions],this.availableFunctions=[...this.calcFieldFunctions].sort((e,o)=>e.name.localeCompare(o.name)),this.availableFunctions.forEach(e=>{e.category=e.category.toUpperCase()}),this.cf={formula:""},!this.readOnly&&this.template&&!this.template.parameters&&this.source==="QBE"&&(this.cf={colName:this.template.alias,formula:this.template.expression}),!this.readOnly&&this.template&&!this.template.parameters&&this.source==="dashboard"&&(this.cf={colName:this.template.alias,formula:this.template.formula}),this.handleCategories()},updated(){if(this.setupCodeMirror(),this.cf.formula||(this.cf.formula=""),this.readOnly&&this.template&&this.template.parameters){this.cf={};for(var e=0;e<this.template.parameters.length;e++)this.template.parameters[e].name=="formula"?this.cf.formula=this.template.parameters[e].value:this.template.parameters[e].name=="colName"&&(this.cf.colName=this.template.parameters[e].value)}!this.readOnly&&this.template&&!this.template.parameters&&this.source==="QBE"&&(this.cf={colName:this.template.alias,formula:this.template.expression}),!this.readOnly&&this.template&&!this.template.parameters&&this.source==="dashboard"&&(this.cf={colName:this.template.alias,formula:this.template.formula})},validations(){return this.descriptor?{cf:V("cf",this.descriptor.validations)}:{}},methods:{handleClick(e){JSON.stringify(this.selectedFunction)===JSON.stringify(e)?this.selectedFunction={}:this.selectedFunction=e},setupCodeMirror(){P.Pos(0,0);const e=setInterval(()=>{!this.$refs.codeMirror||(this.codeMirror=this.$refs.codeMirror.cminstance,setTimeout(()=>{this.codeMirror.refresh()},0),clearInterval(e))},200)},apply(){this.$emit("save",this.cf),this.clearForm()},cancel(){this.$emit("update:readOnly",!1),this.$emit("cancel",this.cf),this.clearForm()},clearForm(){this.cf={formula:""},this.selectedFunction={},this.selectedCategory=""},filterFunctions(){let e=[...this.calcFieldFunctions].sort((o,t)=>o.name.localeCompare(t.name));if(e.forEach(o=>{o.category=o.category.toUpperCase()}),this.availableFunctions=e,this.selectedCategory&&this.selectedCategory!==this.allCategories.name){let o=this.selectedCategory;this.availableFunctions=e.filter(t=>t.category.toUpperCase()===o.toUpperCase())}},handleCategories(){let e=[];this.calcFieldFunctions.sort((o,t)=>o.name.localeCompare(t.name)).map(o=>({name:o.category,code:o.category.toUpperCase()})).forEach(o=>{e.filter(t=>t.code===o.code).length==0&&e.push({name:o.name,code:o.code})}),e.filter(o=>o.name===this.allCategories.name).length==0&&(e=[this.allCategories,...e]),this.availableCategories=e},allowDrop(e){e.preventDefault()},clearCodemirror(e,o){if(this.codeMirror.somethingSelected()){let n=this.codeMirror.getSelections();for(var t of n)this.codeMirror.replaceRange("",{line:e.line,ch:e.ch-JSON.stringify(o).length},{line:e.line,ch:e.ch-JSON.stringify(o).length+t.length})}},dragElement(e,o,t){this.readOnly||(t==="function"?e.dataTransfer.setData("myItem",JSON.stringify({item:o.formula,elementType:t})):t==="field"&&e.dataTransfer.setData("myItem",JSON.stringify({item:o,elementType:t})),e.dataTransfer.effectAllowed="copy")},drop(e,o){if(this.readOnly)return;o.stopPropagation(),o.preventDefault();var t=JSON.parse(o.dataTransfer.getData("myItem")),n=e.coordsChar({left:o.x,top:o.y});this.clearCodemirror(n,t),this.codeMirror.clearHistory();let k=-1,m=-1;e.getLine(n.line).length==n.ch?(k=n.ch,m=n.ch):(k=this.codeMirror.findWordAt(n).anchor.ch,m=this.codeMirror.findWordAt(n).head.ch);let u={line:n.line,ch:k},h={line:n.line,ch:m},b=this.codeMirror.getDoc().getRange(u,h),w=this.source!=="QBE"?"$F{"+t.item.fieldAlias+"}":t.item.fieldAlias,g=t.elementType==="function"?t.item:w;b.match(/\(|\)|,|\./g)?this.codeMirror.getDoc().replaceSelection(g,n):this.codeMirror.getDoc().replaceRange(g,u,h);let f=document.querySelector(".CodeMirror-line");if(f){let v=f.querySelector("div span");v&&(this.cf.formula=v.innerText)}this.codeMirror.refresh()},applyValidationResultsToFormula(){let e={line:this.codeMirror.getDoc().firstLine(),ch:0},o={line:this.codeMirror.getDoc().lastLine(),ch:this.codeMirror.getDoc().getLine(this.codeMirror.getDoc().lastLine()).length};this.isValidFormula?this.codeMirror.getDoc().markText(e,o,{className:"no-syntax-error"}):this.codeMirror.getDoc().markText(e,o,{className:"syntax-error"})}},watch:{selectedFunction(e,o){e&&o!==e&&e.label?this.showHelpPanel=!0:this.showHelpPanel=!1},readOnly(e){this.scriptOptions.readOnly=e},visibility(e,o){var t,n;e&&e!==o&&(this.selectedCategory||((t=this.descriptor)!=null&&t.defaultSelectedCategory?this.selectedCategory=(n=this.descriptor)==null?void 0:n.defaultSelectedCategory:this.selectedCategory=this.allCategories.name))},cf:{handler(){var e;this.cf.formula&&((e=this.descriptor)!=null&&e.validationServiceUrl?this.formulaValidationInterval=setInterval(()=>{var o;this.$http.get((o=this.descriptor)==null?void 0:o.validationServiceUrl).then(t=>{this.isValidFormula=t.data[0],this.applyValidationResultsToFormula()}),clearInterval(this.formulaValidationInterval),this.formulaValidationInterval=null},2500):this.isValidFormula=!0)},deep:!0}},computed:{saveButtonDisabled(){return typeof this.valid=="undefined"?this.v$.$invalid||!this.isValidFormula:this.v$.$invalid||!this.isValidFormula||!this.valid}}}),j={class:"p-fluid p-grid"},q={class:"p-col"},G={class:"p-float-label p-field kn-flex"},W={class:"kn-material-input-label"},Y={class:"p-fluid p-grid"},Z={class:"p-col-4"},ee={class:"p-float-label p-text-uppercase p-m-2"},oe=["onDragstart"],te=a("div",null,[a("i",{class:"fa fa-solid fa-bars"})],-1),re={key:0,class:"p-ml-2"},ae={key:1,class:"p-ml-2"},ne={class:"p-col-4"},ie={class:"p-float-label p-m-2"},le={for:"category",class:"kn-material-input-label"},se={class:"p-float-label p-text-uppercase p-m-2"},de=["onDragstart","onClick"],ce=a("div",null,[a("i",{class:"fa fa-solid fa-bars"})],-1),pe={class:"p-ml-2"},be={class:"p-col-4"},ke={key:0,class:"kn-flex p-d-flex p-flex-column p-jc-between helpCol p-m-2"},me={class:"p-float-label p-text-uppercase p-m-2"},ue=["innerHTML"],he={key:0,class:"helpClass"},ge=["href"],fe={key:1,class:"p-m-2"};function ve(e,o,t,n,k,m){const u=d("Message"),h=d("InputText"),b=d("ScrollPanel"),w=d("Dropdown"),g=d("KnHint"),f=d("Card"),v=d("VCodeMirror"),A=d("Button"),_=d("Dialog"),F=E("tooltip"),O=E("t");return i(),$(_,{class:"kn-dialog--toolbar--primary calculatedFieldDialogClass",visible:e.visibility,header:e.$t("components.knCalculatedField.title"),closable:!1,modal:"",breakpoints:{"960px":"75vw","640px":"100vw"}},{footer:p(()=>[l(A,{class:x(e.readOnly?"kn-button kn-button--primary":"kn-button kn-button--secondary"),label:e.$t("common.cancel"),onClick:e.cancel},null,8,["class","label","onClick"]),e.readOnly?z("",!0):M((i(),$(A,{key:0,class:"kn-button kn-button--primary",onClick:e.apply,disabled:e.saveButtonDisabled},null,8,["onClick","disabled"])),[[O,"common.apply"]])]),default:p(()=>[l(u,{severity:"info",closable:!1},{default:p(()=>[H(s(e.$t("components.knCalculatedField.description")),1)]),_:1}),a("div",j,[a("div",q,[a("span",G,[l(h,{ref:"colName",type:"text",disabled:e.readOnly,class:x(["kn-material-input",{"p-invalid":e.v$.cf.colName.$invalid}]),id:"colName",modelValue:e.v$.cf.colName.$model,"onUpdate:modelValue":o[0]||(o[0]=r=>e.v$.cf.colName.$model=r),onBlur:o[1]||(o[1]=r=>e.v$.cf.colName.$touch())},null,8,["disabled","modelValue","class"]),a("label",W,s(e.$t("components.knCalculatedField.columnName")),1)])]),K(e.$slots,"additionalInputs")]),l(f,{class:"card-0-padding"},{content:p(()=>[a("div",Y,[a("div",Z,[a("h5",ee,s(e.$t("components.knCalculatedField.fields")),1),l(b,{class:"kn-list knListBox kn-flex kn-list-no-border-right",style:{height:"200px !important",border:"1px"}},{default:p(()=>[(i(!0),c(N,null,D(e.fields,(r,C)=>M((i(),c("div",{key:C,class:"kn-list-item p-d-flex p-ai-center fieldType kn-truncated p-ml-2",draggable:"true",onDragstart:y=>e.dragElement(y,r,"field")},[te,e.source==="QBE"?(i(),c("div",re,s(r.fieldLabel),1)):(i(),c("div",ae,s(r.fieldAlias),1))],40,oe)),[[F,e.source==="QBE"?r.fieldLabel:r.fieldAlias,void 0,{bottom:!0}]])),128))]),_:1})]),a("div",ne,[a("span",ie,[l(w,{id:"category",modelValue:e.selectedCategory,"onUpdate:modelValue":o[2]||(o[2]=r=>e.selectedCategory=r),options:e.availableCategories,class:"kn-material-input",optionLabel:"name",optionValue:"code",onChange:e.filterFunctions},null,8,["modelValue","options","onChange"]),a("label",le,s(e.$t(e.descriptor.category.label)),1)]),a("h5",se,s(e.$t("components.knCalculatedField.functions")),1),l(b,{class:"kn-list knListBox kn-flex kn-list-no-border-right",style:{height:"150px !important",border:"1px"}},{default:p(()=>[(i(!0),c(N,null,D(e.availableFunctions,(r,C)=>M((i(),c("div",{key:C,class:x(["kn-list-item p-d-flex p-ai-center formulaType kn-truncated p-ml-2",{selected:r.formula===e.selectedFunction.formula}]),draggable:"true",onDragstart:y=>e.dragElement(y,r,"function"),onClick:y=>e.handleClick(r)},[ce,a("div",pe,s(r.formula),1)],42,de)),[[F,r.formula,void 0,{bottom:!0}]])),128))]),_:1})]),a("div",be,[e.showHelpPanel?(i(),c("span",ke,[a("h5",me,s(e.selectedFunction.label),1),l(b,{class:"helpScrollPanel custombar1"},{default:p(()=>[a("div",{innerHTML:e.$t(e.selectedFunction.help)},null,8,ue)]),_:1}),e.selectedFunction.officialDocumentationLink?(i(),c("div",he,[a("a",{href:e.selectedFunction.officialDocumentationLink,target:"_blank"},s(e.$t("components.knCalculatedField.officialDocumentation",{function:e.selectedFunction.label})),9,ge)])):z("",!0)])):(i(),c("span",fe,[l(g,{class:"kn-hint-sm",title:"components.knCalculatedField.title",hint:e.$t(e.descriptor.hint),"data-test":"hint"},null,8,["title","hint"])]))])])]),_:1}),l(v,{class:x(["p-mt-2 codeMirrorClass",this.readOnly?"readOnly":"",e.v$.cf.formula.$invalid?"p-invalid":""]),ref:"codeMirror",value:e.cf.formula,"onUpdate:value":o[3]||(o[3]=r=>e.cf.formula=r),options:e.scriptOptions,onDrop:e.drop,modelValue:e.v$.cf.formula.$model,"onUpdate:modelValue":o[4]||(o[4]=r=>e.v$.cf.formula.$model=r)},null,8,["class","value","options","onDrop","modelValue"])]),_:3},8,["visible","header"])}var Ce=Q(X,[["render",ve]]);export{Ce as K};
//# sourceMappingURL=KnCalculatedField-ab0b2f81.js.map
