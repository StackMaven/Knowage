import{d as $,ad as z,l as K,n as L,aE as j,s as V,W as I,a8 as R,_ as E,r as n,o as b,c as h,f as e,w as o,g as y,t as s,a as i,D as g,B as S,C as D,h as x,A as M,a5 as X,G as N,i as T,p as _,b as q,v as Y,u as J}from"./index-1e676509.js";import{s as Q}from"./radiobutton.esm-c3e6fa9b.js";import{s as G}from"./autocomplete.esm-bebdfcbd.js";import{K as H}from"./KnCron-7fa39115.js";import{f as Z}from"./filterHelper-a723991a.js";import"./calendar.esm-60a451ba.js";import"./checkbox.esm-fa6c8259.js";import"./inputswitch.esm-80317a38.js";import"./KnCronDescriptor-98645843.js";import"./multiselect.esm-ce4000f7.js";const W=[{field:"errorCount",header:"kpi.kpiScheduler.errorCount"},{field:"successCount",header:"kpi.kpiScheduler.successCount"},{field:"totalCount",header:"kpi.kpiScheduler.totalCount"}],aa={columns:{style:{width:"24%"}},iconColumn:{style:{"text-align":"end"}}};var ta={columns:W,table:aa};const ea=$({name:"kpi-scheduler-execute-card",components:{Card:z,Column:K,DataTable:L,InputNumber:j,RadioButton:Q},props:{selectedSchedule:{type:Object}},emits:["touched"],data(){return{executeCardDescriptor:ta,schedule:{},executionList:[],numberOfLogs:10,loading:!1}},setup(){return{store:V()}},created(){this.loadSelectedSchedule(),this.loadLogExecutionList()},methods:{loadSelectedSchedule(){this.schedule=this.selectedSchedule},loadLogExecutionList(){this.schedule&&this.schedule.id&&(this.loading=!0,this.$http.get(`/knowage/restful-services/1.0/kpi/${this.schedule.id}/${this.numberOfLogs}/logExecutionList`).then(a=>this.executionList=a.data).finally(()=>this.loading=!1))},getFormattedDate(a){return I(a,"YYYY-MM-DD HH:mm:ss")},async downloadFile(a){await this.$http.get(`/knowage/restful-services/1.0/kpi/${a}/logExecutionListOutputContent`).then(t=>{t.data.errors?this.store.setError({title:this.$t("common.error.downloading"),msg:this.$t("common.error.downloading")}):(R(JSON.stringify(t.data.output),this.schedule.name+"ErrorLog","text/plain"),this.store.setInfo({title:this.$t("common.toast.success")}))})}}}),oa={class:"p-field-radiobutton"},ra={for:"delta-with-update"},na={class:"p-field-radiobutton"},ia={for:"delta-with-delete"},la={class:"table-header"},da={class:"p-d-flex p-ai-center"},ca={class:"p-d-flex p-flex-column p-mr-2"},sa={for:"numberOfLogs",class:"kn-material-input-label"};function ba(a,t,l,d,k,w){const p=n("Toolbar"),v=n("RadioButton"),u=n("Card"),m=n("InputNumber"),f=n("Button"),c=n("Column"),A=n("DataTable");return b(),h(S,null,[e(u,null,{header:o(()=>[e(p,{class:"kn-toolbar kn-toolbar--primary"},{start:o(()=>[y(s(a.$t("kpi.kpiScheduler.executionType")),1)]),_:1})]),content:o(()=>[i("div",oa,[e(v,{id:"delta-with-update",name:"delta",value:!0,modelValue:a.schedule.delta,"onUpdate:modelValue":t[0]||(t[0]=r=>a.schedule.delta=r),onClick:t[1]||(t[1]=r=>a.$emit("touched"))},null,8,["modelValue"]),i("label",ra,s(a.$t("kpi.kpiScheduler.insertAndUpdate")),1)]),i("div",na,[e(v,{id:"delta-with-delete",name:"delta",value:!1,modelValue:a.schedule.delta,"onUpdate:modelValue":t[2]||(t[2]=r=>a.schedule.delta=r),onClick:t[3]||(t[3]=r=>a.$emit("touched"))},null,8,["modelValue"]),i("label",ia,s(a.$t("kpi.kpiScheduler.deleteAndInsert")),1)])]),_:1}),e(u,{class:"p-mt-2"},{header:o(()=>[e(p,{class:"kn-toolbar kn-toolbar--primary"},{start:o(()=>[y(s(a.$t("kpi.kpiScheduler.logExecution")),1)]),_:1})]),content:o(()=>[e(A,{value:a.executionList,paginator:!0,rowsPerPageOptions:[10,20,50],rows:10,loading:a.loading,class:"p-datatable-sm kn-table p-m-1",dataKey:"id",responsiveLayout:"stack",breakpoint:"960px",onRowClick:t[5]||(t[5]=r=>a.showForm(r.data,!1)),"data-test":"executions-table"},{loading:o(()=>[y(s(a.$t("common.info.dataLoading")),1)]),header:o(()=>[i("div",la,[i("div",da,[i("span",ca,[i("label",sa,s(a.$t("kpi.kpiScheduler.numberOfExecutions")),1),e(m,{id:"numberOfLogs",inputClass:"kn-material-input",modelValue:a.numberOfLogs,"onUpdate:modelValue":t[4]||(t[4]=r=>a.numberOfLogs=r)},null,8,["modelValue"])]),e(f,{id:"load-button",class:"kn-button kn-button--primary",label:a.$t("common.load"),onClick:a.loadLogExecutionList},null,8,["label","onClick"])])])]),default:o(()=>[e(c,{style:g(a.executeCardDescriptor.table.columns.style),field:"timeRun",header:a.$t("kpi.kpiScheduler.timeRun"),sortable:!0},{body:o(r=>[y(s(a.getFormattedDate(r.data.timeRun)),1)]),_:1},8,["style","header"]),(b(!0),h(S,null,D(a.executeCardDescriptor.columns,r=>(b(),x(c,{class:"kn-truncated",style:g(a.executeCardDescriptor.table.columns.style),field:r.field,header:a.$t(r.header),key:r.field,sortable:!0},null,8,["style","field","header"]))),128)),e(c,{style:g(a.executeCardDescriptor.table.iconColumn.style)},{body:o(r=>[r.data.outputPresent?(b(),x(f,{key:0,icon:"pi pi-download",class:"p-button-link",onClick:F=>a.downloadFile(r.data.id)},null,8,["onClick"])):M("",!0)]),_:1},8,["style"])]),_:1},8,["value","loading"])]),_:1})],64)}var pa=E(ea,[["render",ba],["__scopeId","data-v-00cca4a5"]]);const ka={style:{"min-width":"175px"}};var ua={input:ka};const va=$({name:"filters-card",components:{AutoComplete:G,Card:z,Dropdown:X},props:{filter:{type:Object},placeholderType:{type:Array},temporalType:{type:Array},lovs:{type:Array,required:!0}},emits:["touched"],data(){return{kpiSchedulerFilterDetailCardDescriptor:ua,currentFilter:{},filteredLovs:[]}},watch:{filter(){this.loadFilter()}},created(){this.loadFilter()},methods:{loadFilter(){this.currentFilter=this.filter,this.currentFilter.type.valueCd==="LOV"&&(this.currentFilter.value=this.getLovValue(this.currentFilter.value))},searchCategories(a){setTimeout(()=>{a.query.trim().length?this.filteredLovs=this.lovs.filter(t=>t.name.toLowerCase().startsWith(a.query.toLowerCase())):this.filteredLovs=[...this.lovs]},250)},setLovValue(a,t){t.value=this.getLovValue(a.label),this.$emit("touched")},getLovValue(a){const t=this.lovs.find(l=>l.label===a);return t?t.name:""},resetValue(){this.currentFilter.value=null,this.$emit("touched")}}}),ma={class:"p-d-flex p-flex-row"},fa={key:0,class:"p-dropdown-car-value"},ha={class:"p-dropdown-car-option"},ga={key:0},wa={class:"p-float-label"},ya={for:"label",class:"kn-material-input-label"},xa={key:1},Ca={class:"p-float-label"},Aa={key:2},Ma={class:"p-float-label"};function Sa(a,t,l,d,k,w){const p=n("Toolbar"),v=n("Dropdown"),u=n("InputText"),m=n("AutoComplete"),f=n("Card");return a.currentFilter?(b(),x(f,{key:0},{header:o(()=>[e(p,{class:"kn-toolbar kn-toolbar--secondary"},{start:o(()=>[y(s(a.filter.placeholderName),1)]),_:1})]),content:o(()=>[i("div",ma,[e(v,{id:"valueCd",class:"kn-material-input p-mr-2",style:g(a.kpiSchedulerFilterDetailCardDescriptor.input.style),modelValue:a.currentFilter.type,"onUpdate:modelValue":t[0]||(t[0]=c=>a.currentFilter.type=c),options:a.placeholderType,onChange:a.resetValue},{value:o(c=>[c.value?(b(),h("div",fa,[i("span",null,s(c.value.valueCd),1)])):M("",!0)]),option:o(c=>[i("div",ha,[i("span",null,s(c.option.valueCd),1)])]),_:1},8,["style","modelValue","options","onChange"]),a.currentFilter.type.valueCd==="FIXED_VALUE"?(b(),h("div",ga,[i("span",wa,[e(u,{class:N(["kn-material-input",{"p-invalid":a.currentFilter.value===""}]),style:g(a.kpiSchedulerFilterDetailCardDescriptor.input.style),modelValue:a.currentFilter.value,"onUpdate:modelValue":t[1]||(t[1]=c=>a.currentFilter.value=c),modelModifiers:{trim:!0},onInput:t[2]||(t[2]=c=>a.$emit("touched"))},null,8,["class","style","modelValue"]),i("label",ya,s(a.$t("common.value"))+" * ",1)])])):a.currentFilter.type.valueCd==="TEMPORAL_FUNCTIONS"?(b(),h("div",xa,[i("span",Ca,[e(v,{id:"valueCd",class:"kn-material-input p-mr-2",style:g(a.kpiSchedulerFilterDetailCardDescriptor.input.style),optionLabel:"valueCd",optionValue:"valueCd",modelValue:a.currentFilter.value,"onUpdate:modelValue":t[3]||(t[3]=c=>a.currentFilter.value=c),options:a.temporalType,onChange:t[4]||(t[4]=c=>a.$emit("touched"))},null,8,["style","modelValue","options"])])])):a.currentFilter.type.valueCd==="LOV"?(b(),h("div",Aa,[i("span",Ma,[e(m,{class:"p-mr-2",style:g(a.kpiSchedulerFilterDetailCardDescriptor.input.style),modelValue:a.currentFilter.value,"onUpdate:modelValue":t[5]||(t[5]=c=>a.currentFilter.value=c),suggestions:a.filteredLovs,field:"name",dropdown:!0,forceSelection:!0,onComplete:t[6]||(t[6]=c=>a.searchCategories(c)),onItemSelect:t[7]||(t[7]=c=>a.setLovValue(c.value,a.filter))},null,8,["style","modelValue","suggestions"])])])):M("",!0)])]),_:1})):M("",!0)}var $a=E(va,[["render",Sa]]);const Ea=$({name:"kpi-scheduler-filters-card",components:{Card:z,KpiSchedulerFilterDetailCard:$a},props:{formatedFilters:{type:Object,required:!0},placeholderType:{type:Array},temporalType:{type:Array},lovs:{type:Array,required:!0}},emits:["touched"],data(){return{filters:[],kpiNames:[],filteredLovs:[]}},watch:{formatedFilters(){this.loadFilters()}},created(){this.loadFilters()},methods:{loadFilters(){this.filters=this.formatedFilters,this.filters&&(this.kpiNames=Object.keys(this.filters))}}}),Da={class:"p-d-flex p-flex-row p-flex-wrap"};function za(a,t,l,d,k,w){const p=n("Toolbar"),v=n("KpiSchedulerFilterDetailCard"),u=n("Card");return b(),h("div",null,[(b(!0),h(S,null,D(a.kpiNames,(m,f)=>(b(),x(u,{key:f,class:"p-mt-2"},{header:o(()=>[e(p,{class:"kn-toolbar kn-toolbar--primary"},{start:o(()=>[y(s(m),1)]),_:2},1024)]),content:o(()=>[i("div",Da,[(b(!0),h(S,null,D(a.formatedFilters[m],c=>(b(),x(v,{class:"p-m-2",key:c.id,filter:c,placeholderType:a.placeholderType,temporalType:a.temporalType,lovs:a.lovs,onTouched:t[0]||(t[0]=A=>a.$emit("touched"))},null,8,["filter","placeholderType","temporalType","lovs"]))),128))])]),_:2},1024))),128))])}var Fa=E(Ea,[["render",za]]);const Ta=[{field:"name",header:"common.name",style:{}},{field:"category.translatedValueName",header:"common.category",style:{}}],Ka={style:{width:"60vw"}},La=["name"],Va={iconColumn:{style:{"text-align":"end"}}};var Ia={columns:Ta,dialog:Ka,globalFilterFields:La,table:Va};const Na=$({name:"kpi-scheduler-kpi-card",components:{Card:z,Column:K,DataTable:L,Dialog:T},props:{expired:{type:Boolean},kpis:{type:Array},allKpiList:{type:Array}},emits:["touched","kpiAdded","kpiDeleted"],data(){return{kpiCardDescriptor:Ia,kpisList:[],filters:{global:[Z]},selectedKpiAssociations:[],addKpiAssociationVisible:!1,showExpired:!0}},created(){this.loadKpis(),this.loadSelectedKpiAssociations()},methods:{loadKpis(){this.kpisList=this.kpis},loadSelectedKpiAssociations(){this.kpisList&&(this.selectedKpiAssociations=[...this.kpisList])},deleteKpiAssociationConfirm(a){this.$confirm.require({message:this.$t("common.toast.deleteMessage"),header:this.$t("common.toast.deleteTitle"),icon:"pi pi-exclamation-triangle",accept:()=>this.deleteKpiAssociation(a)})},deleteKpiAssociation(a){const t=this.kpisList.findIndex(l=>l.id===a);if(t>-1){const l=this.kpisList[t];this.kpisList.splice(t,1),this.$emit("kpiDeleted",l)}this.loadSelectedKpiAssociations()},addKpiAssociations(){this.kpisList=[...this.selectedKpiAssociations],this.addKpiAssociationVisible=!1,this.$emit("kpiAdded",this.kpisList)},getFormattedDate(a){return I(a,"YYYY-MM-DD")},closeKpiAssociations(){this.addKpiAssociationVisible=!1,this.loadSelectedKpiAssociations()}}}),U=a=>(_("data-v-04b21c08"),a=a(),q(),a),Ua={key:0,id:"expired-schedule","data-test":"expired-warning"},Oa={class:"table-header p-d-flex p-ai-center"},Ba={id:"search-container",class:"p-input-icon-left p-mr-3"},Pa=U(()=>i("i",{class:"pi pi-search"},null,-1)),ja={class:"table-header p-d-flex"},Ra={class:"p-input-icon-left p-mr-3"},Xa=U(()=>i("i",{class:"pi pi-search"},null,-1));function _a(a,t,l,d,k,w){const p=n("InputText"),v=n("Button"),u=n("Column"),m=n("DataTable"),f=n("Toolbar"),c=n("Dialog"),A=n("Card");return b(),x(A,null,{content:o(()=>[a.showExpired&&a.expired?(b(),h("div",Ua,[i("p",null,s(a.$t("kpi.kpiScheduler.expiredInterval")),1),i("i",{class:"fa fa-times-circle",onClick:t[0]||(t[0]=r=>a.showExpired=!1)})])):M("",!0),e(m,{value:a.kpisList,class:"p-datatable-sm kn-table",dataKey:"id",filters:a.filters,"onUpdate:filters":t[3]||(t[3]=r=>a.filters=r),globalFilterFields:a.kpiCardDescriptor.globalFilterFields,responsiveLayout:"stack",breakpoint:"960px","data-test":"kpi-table"},{header:o(()=>[i("div",Oa,[i("span",Ba,[Pa,e(p,{class:"kn-material-input",modelValue:a.filters.global.value,"onUpdate:modelValue":t[1]||(t[1]=r=>a.filters.global.value=r),type:"text",placeholder:a.$t("common.search"),"data-test":"filterInput"},null,8,["modelValue","placeholder"])]),e(v,{id:"add-kpi-associations-button",class:"kn-button kn-button--primary",label:a.$t("kpi.kpiScheduler.addKpiAssociation"),onClick:t[2]||(t[2]=r=>a.addKpiAssociationVisible=!0)},null,8,["label"])])]),empty:o(()=>[y(s(a.$t("common.info.noDataFound")),1)]),default:o(()=>[(b(!0),h(S,null,D(a.kpiCardDescriptor.columns,r=>(b(),x(u,{class:"kn-truncated",field:r.field,header:a.$t(r.header),key:r.field,sortable:!0},null,8,["field","header"]))),128)),e(u,{style:g(a.kpiCardDescriptor.table.iconColumn.style)},{body:o(r=>[e(v,{icon:"pi pi-trash",class:"p-button-link",onClick:F=>a.deleteKpiAssociationConfirm(r.data.id),"data-test":"delete-button-"+r.data.id},null,8,["onClick","data-test"])]),_:1},8,["style"])]),_:1},8,["value","filters","globalFilterFields"]),e(c,{style:g(a.kpiCardDescriptor.dialog.style),visible:a.addKpiAssociationVisible,modal:!0,class:"p-fluid kn-dialog--toolbar--primary",closable:!1},{header:o(()=>[e(f,{class:"kn-toolbar kn-toolbar--primary p-p-0 p-m-0 p-col-12"},{start:o(()=>[y(s(a.$t("kpi.kpiScheduler.saveKpiAssociation")),1)]),end:o(()=>[e(v,{class:"kn-button p-button-text p-m-2",label:a.$t("common.close"),onClick:a.closeKpiAssociations},null,8,["label","onClick"]),e(v,{class:"kn-button p-button-text",label:a.$t("common.save"),onClick:a.addKpiAssociations},null,8,["label","onClick"])]),_:1})]),default:o(()=>[e(m,{value:a.allKpiList,selection:a.selectedKpiAssociations,"onUpdate:selection":t[5]||(t[5]=r=>a.selectedKpiAssociations=r),class:"p-datatable-sm kn-table",dataKey:"id",filters:a.filters,"onUpdate:filters":t[6]||(t[6]=r=>a.filters=r),globalFilterFields:a.kpiCardDescriptor.globalFilterFields,responsiveLayout:"stack",breakpoint:"960px"},{header:o(()=>[i("div",ja,[i("span",Ra,[Xa,e(p,{class:"kn-material-input",modelValue:a.filters.global.value,"onUpdate:modelValue":t[4]||(t[4]=r=>a.filters.global.value=r),type:"text",placeholder:a.$t("common.search"),"data-test":"filterInput"},null,8,["modelValue","placeholder"])])])]),empty:o(()=>[y(s(a.$t("common.info.noDataFound")),1)]),default:o(()=>[e(u,{selectionMode:"multiple",headerStyle:"width: 3em"}),e(u,{class:"kn-truncated",field:"name",header:a.$t("kpi.kpiScheduler.kpiName"),key:"name",sortable:!0},null,8,["header"]),e(u,{class:"kn-truncated",field:"category.valueCd",header:a.$t("common.category"),key:"category.valueCd",sortable:!0},null,8,["header"]),e(u,{class:"kn-truncated",field:"dateCreation",header:a.$t("kpi.kpiScheduler.kpiName"),key:"dateCreation",sortable:!0},{body:o(r=>[i("span",null,s(a.getFormattedDate(r.data.dateCreation)),1)]),_:1},8,["header"]),e(u,{class:"kn-truncated",field:"author",header:a.$t("common.author"),key:"author",sortable:!0},null,8,["header"])]),_:1},8,["value","selection","filters","globalFilterFields"])]),_:1},8,["style","visible"])]),_:1})}var qa=E(Na,[["render",_a],["__scopeId","data-v-04b21c08"]]);const Ya={contentStyle:{"max-height":"300px","min-height":"200px"},style:{width:"40vw"}},Ja={style:{width:"60vw"}};var O={dialog:Ya,errorDialog:Ja};const Qa=$({name:"kpi-scheduler-save-dialog",components:{Dialog:T},props:{schedulerName:{type:String}},emits:["close"],data(){return{kpiSchedulerTabViewDescriptor:O,name:"",nameDirty:!1}},computed:{nameHelp(){var a,t;return((t=(a=this.name)==null?void 0:a.length)!=null?t:"0")+" / 40"},saveSchedulerButtonDisabled(){return!this.name}},watch:{currentRule(){this.loadSchedulerName()}},async created(){this.loadSchedulerName()},methods:{loadSchedulerName(){this.name=this.schedulerName}}}),Ga={class:"p-field p-m-4"},Ha={class:"p-float-label"},Za={class:"kn-material-input-label"},Wa={id:"name-help"},at={id:"name-help"};function tt(a,t,l,d,k,w){const p=n("InputText"),v=n("Button"),u=n("Dialog");return b(),x(u,{style:g(a.kpiSchedulerTabViewDescriptor.dialog.style),contentStyle:a.kpiSchedulerTabViewDescriptor.dialog.contentStyle,header:a.$t("kpi.kpiScheduler.saveScheduler"),visible:!0,modal:!0,class:"full-screen-dialog p-fluid kn-dialog--toolbar--primary",closable:!1},{footer:o(()=>[e(v,{class:"kn-button kn-button--secondary",label:a.$t("common.close"),onClick:t[2]||(t[2]=m=>a.$emit("close"))},null,8,["label"]),e(v,{class:"kn-button kn-button--primary",label:a.$t("common.save"),onClick:t[3]||(t[3]=m=>a.$emit("save",a.name)),disabled:a.saveSchedulerButtonDisabled},null,8,["label","disabled"])]),default:o(()=>[i("div",Ga,[i("span",Ha,[e(p,{class:N(["kn-material-input",{"p-invalid":a.name&&a.name.length==0&&a.nameDirty}]),type:"text",modelValue:a.name,"onUpdate:modelValue":t[0]||(t[0]=m=>a.name=m),modelModifiers:{trim:!0},max:"40",onBlur:t[1]||(t[1]=m=>a.nameDirty=!0)},null,8,["modelValue","class"]),i("label",Za,s(a.$t("common.name"))+" *",1),i("div",Wa,[i("small",at,s(a.nameHelp),1)])])])]),_:1},8,["style","contentStyle","header"])}var et=E(Qa,[["render",tt],["__scopeId","data-v-6f2599bc"]]);const ot=$({name:"kpi-scheduler-tab-view",components:{Dialog:T,KpiSchedulerExecuteCard:pa,KpiSchedulerFiltersCard:Fa,KnCron:H,KpiSchedulerKpiCard:qa,KpiSchedulerSaveDialog:et,TabView:Y,TabPanel:J},props:{id:{type:String},clone:{type:String}},emits:["touched","inserted","closed"],data(){return{kpiSchedulerTabViewDescriptor:O,selectedSchedule:{},domainsKpiPlaceholderType:[],domainsKpiPlaceholderFunction:[],lovs:[],kpiList:[],kpiIds:[],filters:[],formatedFilters:{},loading:!1,touched:!1,saveDialogVisible:!1,errorMessage:null,operation:"create",validCron:!0}},computed:{buttonDisabled(){return!this.selectedSchedule.kpis||this.selectedSchedule.kpis.length==0||this.validCron==!1||this.loading||this.emptyFilters()},errorDialogVisible(){return!!this.errorMessage}},watch:{async id(){await this.loadPage()},async clone(){await this.loadPage()}},setup(){return{store:V()}},async created(){await this.loadPage()},methods:{async loadPage(){this.loading=!0,this.id?await this.loadSchedule():this.selectedSchedule={kpis:[],name:"",delta:!0,filters:[],frequency:{cron:{type:"minute",parameter:{numRepetition:"1"}},startDate:new Date().valueOf(),endDate:null,startTime:new Date().valueOf(),endTime:""}},this.clone==="true"&&(delete this.selectedSchedule.id,this.selectedSchedule.name="Copy of "+this.selectedSchedule.name),await this.loadDomainsData(),await this.loadLovs(),await this.loadKpiList(),this.loadKpiIds(),await this.loadFilters(),this.addMissingPlaceholder(),this.loading=!1},async loadSchedule(){await this.$http.get(`/knowage/restful-services/1.0/kpi/${this.id}/loadSchedulerKPI`).then(a=>this.selectedSchedule=a.data),this.selectedSchedule.frequency.cron&&(this.selectedSchedule.frequency.cron=JSON.parse(this.selectedSchedule.frequency.cron),this.selectedSchedule.frequency.endTime="")},async loadDomainsData(){await this.loadDomainsByCode("KPI_PLACEHOLDER_TYPE").then(a=>this.domainsKpiPlaceholderType=a.data),await this.loadDomainsByCode("KPI_PLACEHOLDER_FUNC").then(a=>this.domainsKpiPlaceholderFunction=a.data)},loadDomainsByCode(a){return this.$http.get(`/knowage/restful-services/2.0/domains/listByCode/${a}`)},async loadLovs(){await this.$http.get("/knowage/restful-services/2.0/lovs/get/all/").then(a=>this.lovs=a.data)},async loadKpiList(){await this.$http.get("/knowage/restful-services/1.0/kpi/listKpi").then(a=>this.kpiList=a.data)},setTouched(){this.touched=!0,this.$emit("touched")},closeTemplate(){const a="/kpi-scheduler";this.touched?this.$confirm.require({message:this.$t("common.toast.unsavedChangesMessage"),header:this.$t("common.toast.unsavedChangesHeader"),icon:"pi pi-exclamation-triangle",accept:()=>{this.touched=!1,this.$emit("closed"),this.$router.push(a)}}):this.$router.push(a)},async onKpiAdded(a){this.touched=!0,this.selectedSchedule={...this.selectedSchedule,kpis:a},await this.loadFormatedFilters()},async onKpiDeleted(a){this.selectedSchedule.filters=this.selectedSchedule.filters.filter(t=>t.kpiId!=a.id),this.touched=!0,await this.loadFormatedFilters()},async loadFormatedFilters(){this.loadKpiIds(),await this.loadFilters(),this.addMissingPlaceholder()},loadKpiIds(){var a;this.kpiIds=[],this.selectedSchedule.kpis&&((a=this.selectedSchedule)==null||a.kpis.forEach(t=>this.kpiIds.push({id:t.id,version:t.version})))},async loadFilters(){await this.$http.post("/knowage/restful-services/1.0/kpi/listPlaceholderByKpi",this.kpiIds).then(a=>this.filters=a.data)},addMissingPlaceholder(){this.formatedFilters=[];const a=Object.keys(this.filters);for(let t=0;t<a.length;t++)if(this.selectedSchedule.filters.length>0){const l=[];this.getPlaceholders(l,a,t);const d=JSON.parse(this.filters[a[t]]);this.removeUnusedPlaceholders(l,d),this.pushPlaceholderToFormatedFilters(l,d,a,t)}else{this.selectedSchedule.filters=[];const l=JSON.parse(this.filters[a[t]]);for(let d=0;d<l.length;d++){const k=this.createNewFilter(a[t],l[d]);this.selectedSchedule.filters.push(k),this.addToFormatedFilters(k)}}},getPlaceholders(a,t,l){for(let d in this.selectedSchedule.filters)this.selectedSchedule.filters[d].kpiName==t[l]&&a.push(this.selectedSchedule.filters[d])},pushPlaceholderToFormatedFilters(a,t,l,d){let k=null;for(let w=0;w<t.length;w++){k=null;for(let p in a)if(Object.keys(t[w])[0]==a[p].placeholderName){k=a[p];break}if(k==null){const p=this.createNewFilter(l[d],t[w]);this.selectedSchedule.filters.push(p),this.addToFormatedFilters(p)}else this.addToFormatedFilters(k)}},removeUnusedPlaceholders(a,t){let l=null;for(let d in a){for(let k=0;k<t.length;k++)if(Object.keys(t[k])[0]==a[d].placeholderName){l=d;break}l==null&&this.selectedSchedule.filters.splice(this.indexInList(a[d].placeholderName,this.selectedSchedule.filters,"placeholderName"),1)}},createNewFilter(a,t){const l={kpiName:a,placeholderName:Object.keys(t)[0],type:{valueCd:"FIXED_VALUE",valueId:242}};l.value=t[l.placeholderName];const d=this.indexInList(a,this.kpiList,"name");return l.kpiId=this.kpiList[d].id,l.kpiVersion=this.kpiList[d].version,l},addToFormatedFilters(a){this.formatedFilters[a.kpiName]?this.formatedFilters[a.kpiName].push(a):this.formatedFilters[a.kpiName]=[a]},indexInList(a,t,l){for(let d=0;d<t.length;d++)if(t[d][l]==a)return d;return-1},async saveScheduler(a){this.saveDialogVisible=!1,this.loading=!0,this.selectedSchedule.name=a,this.selectedSchedule.frequency.cron=JSON.stringify(this.selectedSchedule.frequency.cron),this.selectedSchedule.filters.forEach(t=>{t.type.valueCd==="LOV"&&(t.value=this.getLovValue(t.value))}),!this.schedulerInvalid()&&(this.selectedSchedule.id&&(this.operation="update"),this.clone&&this.selectedSchedule.filters.forEach(t=>delete t.executionId),await this.$http.post("/knowage/restful-services/1.0/kpi/saveSchedulerKPI",this.selectedSchedule).then(t=>{this.store.setInfo({title:this.$t("common.toast."+this.operation+"Title"),msg:this.$t("common.toast.success")}),this.$emit("inserted"),this.$router.push(`/kpi-scheduler/edit-kpi-schedule?id=${t.data.id}&clone=false`)}).catch(t=>{this.errorMessage=t}).finally(()=>this.selectedSchedule.frequency.cron=JSON.parse(this.selectedSchedule.frequency.cron)),this.loading=!1)},getLovValue(a){const t=this.lovs.find(l=>l.name===a);return t?t.label:""},setCronValid(a){this.validCron=a},schedulerInvalid(){return"delta"in this.selectedSchedule?!this.selectedSchedule.kpis||this.selectedSchedule.kpis.length==0?(this.errorMessage=this.$t("kpi.kpiScheduler.missingKpiList"),!0):this.validCron==!1?(this.errorMessage=this.$t("kpi.kpiScheduler.dateError"),!0):!1:(this.errorMessage=this.$t("kpi.kpiScheduler.missingExecuteValue"),!0)},emptyFilters(){let a=!1;return this.selectedSchedule.filters.forEach(t=>{t.value||(a=!0)}),a}}}),rt={key:1,class:"card"};function nt(a,t,l,d,k,w){const p=n("Button"),v=n("Toolbar"),u=n("ProgressBar"),m=n("KpiSchedulerKpiCard"),f=n("TabPanel"),c=n("KpiSchedulerFiltersCard"),A=n("KnCron"),r=n("KpiSchedulerExecuteCard"),F=n("TabView"),B=n("KpiSchedulerSaveDialog"),P=n("Dialog");return b(),h(S,null,[e(v,{class:"kn-toolbar kn-toolbar--primary p-m-0"},{start:o(()=>[y(s(this.clone||this.id?this.selectedSchedule.name:this.$t("kpi.kpiScheduler.newScheduler")),1)]),end:o(()=>[e(p,{icon:"pi pi-save",class:"p-button-text p-button-rounded p-button-plain",disabled:a.buttonDisabled,onClick:t[0]||(t[0]=C=>a.saveDialogVisible=!0),"data-test":"submit-button"},null,8,["disabled"]),e(p,{icon:"pi pi-times",class:"p-button-text p-button-rounded p-button-plain",onClick:a.closeTemplate,"data-test":"close-button"},null,8,["onClick"])]),_:1}),a.loading?(b(),x(u,{key:0,mode:"indeterminate",class:"kn-progress-bar"})):(b(),h("div",rt,[e(F,{class:"tabview-custom"},{default:o(()=>[e(f,null,{header:o(()=>[i("span",null,s(a.$t("common.kpi")),1)]),default:o(()=>[e(m,{expired:a.selectedSchedule.jobStatus==="EXPIRED",kpis:a.selectedSchedule.kpis,allKpiList:a.kpiList,onTouched:a.setTouched,onKpiAdded:t[1]||(t[1]=C=>a.onKpiAdded(C)),onKpiDeleted:a.onKpiDeleted},null,8,["expired","kpis","allKpiList","onTouched","onKpiDeleted"])]),_:1}),e(f,{disabled:Object.keys(this.formatedFilters).length===0},{header:o(()=>[i("span",null,s(a.$t("kpi.kpiScheduler.filters")),1)]),default:o(()=>[e(c,{formatedFilters:a.formatedFilters,placeholderType:a.domainsKpiPlaceholderType,temporalType:a.domainsKpiPlaceholderFunction,lovs:a.lovs,onTouched:a.setTouched},null,8,["formatedFilters","placeholderType","temporalType","lovs","onTouched"])]),_:1},8,["disabled"]),e(f,null,{header:o(()=>[i("span",null,s(a.$t("kpi.kpiScheduler.frequency")),1)]),default:o(()=>[e(A,{frequency:a.selectedSchedule.frequency,onTouched:a.setTouched,onCronValid:t[2]||(t[2]=C=>a.setCronValid(C))},null,8,["frequency","onTouched"])]),_:1}),e(f,null,{header:o(()=>[i("span",null,s(a.$t("kpi.kpiScheduler.execute")),1)]),default:o(()=>[e(r,{selectedSchedule:a.selectedSchedule,onTouched:a.setTouched},null,8,["selectedSchedule","onTouched"])]),_:1})]),_:1})])),a.saveDialogVisible?(b(),x(B,{key:2,schedulerName:a.selectedSchedule.name,onSave:t[3]||(t[3]=C=>a.saveScheduler(C)),onClose:t[4]||(t[4]=C=>a.saveDialogVisible=!1)},null,8,["schedulerName"])):M("",!0),e(P,{style:g(a.kpiSchedulerTabViewDescriptor.errorDialog.style),modal:!0,visible:a.errorDialogVisible,header:a.$t("common.toast."+this.operation+"Title"),class:"full-screen-dialog p-fluid kn-dialog--toolbar--primary error-dialog",closable:!1,"data-test":"save-dialog"},{footer:o(()=>[e(p,{class:"kn-button kn-button--secondary",label:a.$t("common.close"),onClick:t[5]||(t[5]=C=>a.errorMessage=null)},null,8,["label"])]),default:o(()=>[i("p",null,s(a.errorMessage),1)]),_:1},8,["style","visible","header"])],64)}var mt=E(ot,[["render",nt]]);export{mt as default};
//# sourceMappingURL=KpiSchedulerTabView-f8d501d8.js.map
