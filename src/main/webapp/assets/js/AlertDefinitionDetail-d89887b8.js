import{K as q,u as K,c as B}from"./KnValidatonMessages-ebe48c72.js";import{a as O}from"./AlertDefinitionDescriptor-4ed1dbf8.js";import{d as x,a5 as N,_ as C,r,o as l,h as y,w as c,a,f as i,K as I,t as s,c as g,C as T,D as A,B as j,A as D,p as P,b as F,aE as R,n as J,l as X,x as _,g as M,N as Q,i as Y,q as W,s as G}from"./index-1e676509.js";import{s as H}from"./menu.esm-6bee86d0.js";import{s as Z}from"./checkbox.esm-fa6c8259.js";import{K as ee}from"./KnCron-7fa39115.js";import{s as te}from"./multiselect.esm-ce4000f7.js";import{f as V}from"./filterHelper-a723991a.js";import{s as ae}from"./autocomplete.esm-bebdfcbd.js";import{s as oe}from"./editor.esm-7f249187.js";import"./calendar.esm-60a451ba.js";import"./inputswitch.esm-80317a38.js";import"./KnCronDescriptor-98645843.js";const re={action:[{fieldName:"type",validators:[{key:"required"}]},{fieldName:"threshold",validators:[{key:"required"}]}],alert:[{fieldName:"name",validators:[{key:"required"},{key:"regex",validator:{type:"extendedAlphanumericRegex"}}]},{fieldName:"alertListener",validators:[{key:"required"}]}]};var U={validations:re};const ne=x({name:"name-card",components:{Dropdown:N,KnValidationMessages:q},props:{selectedAlert:{type:Object,required:!1},listeners:{type:Array,required:!1},vcomp:Object},emits:["touched","valueChanged"],watch:{selectedAlert(){this.alert={...this.selectedAlert}}},data(){return{alert:{},alertDescriptor:O}},methods:{valueChanged(e,t){this.$emit("valueChanged",{fieldName:e,value:t})}}}),ie={class:"p-fluid p-formgrid p-grid"},le={class:"p-field p-col-6"},se={class:"p-float-label"},de={for:"name",class:"kn-material-input-label"},ce={class:"p-field p-col-6"},pe={class:"p-float-label"},ue={for:"listener",class:"kn-material-input-label"};function be(e,t,o,d,h,$){const b=r("InputText"),p=r("KnValidationMessages"),k=r("Dropdown"),n=r("Card");return l(),y(n,{style:{width:"100%"},class:"p-m-2"},{content:c(()=>[a("form",ie,[a("div",le,[a("span",se,[i(b,I(e.$attrs,{id:"name",class:["kn-material-input",{"p-invalid":e.vcomp.name.$invalid&&e.vcomp.name.$dirty}],type:"text",modelValue:e.alert.name,"onUpdate:modelValue":t[0]||(t[0]=f=>e.alert.name=f),onInput:t[1]||(t[1]=f=>e.valueChanged("name",f.target.value)),onBlur:t[2]||(t[2]=f=>e.vcomp.name.$touch())}),null,16,["modelValue","class"]),a("label",de,s(e.$t("kpi.alert.name"))+" * ",1)]),i(p,{class:"p-mt-1",vComp:e.vcomp.name,additionalTranslateParams:{fieldName:e.$t("kpi.alert.name")}},null,8,["vComp","additionalTranslateParams"])]),a("div",ce,[a("span",pe,[i(k,I(e.$attrs,{id:"listener",class:["kn-material-input",{"p-invalid":e.vcomp.alertListener.$invalid&&e.vcomp.alertListener.$dirty}],modelValue:e.alert.alertListener,"onUpdate:modelValue":t[3]||(t[3]=f=>e.alert.alertListener=f),options:e.listeners,optionLabel:"name",onChange:t[4]||(t[4]=f=>e.valueChanged("alertListener",f.value)),onBlur:t[5]||(t[5]=f=>e.vcomp.alertListener.$touch())}),null,16,["modelValue","options","class"]),a("label",ue,s(e.$t("kpi.alert.kpiListener"))+" * ",1)]),i(p,{class:"p-mt-1",vComp:e.vcomp.alertListener,additionalTranslateParams:{fieldName:e.$t("kpi.alert.kpiListener")}},null,8,["vComp","additionalTranslateParams"])])])]),_:1})}var fe=C(ne,[["render",be]]);const me=x({components:{Dropdown:N,Menu:H},props:{selectedAlert:{type:Object},kpiList:{type:Array},actionList:{type:Array}},emits:["showDialog","kpiLoaded","touched"],async created(){this.alert=this.selectedAlert,this.alert.jsonOptions&&(await this.loadKpi(this.alert.jsonOptions.kpiId,this.alert.jsonOptions.kpiVersion),this.alert.jsonOptions.actions=this.alert.jsonOptions.actions.map(e=>{var o;const t={...e,data:(o=this.actionList)==null?void 0:o.find(d=>e.idAction==d.id)};return t.thresholdData=t.thresholdValues.map(d=>this.kpi.threshold.thresholdValues.find(h=>h.id==d)),t}))},watch:{async selectedAlert(){this.alert=this.selectedAlert,this.alert.jsonOptions&&(await this.loadKpi(this.alert.jsonOptions.kpiId,this.alert.jsonOptions.kpiVersion),this.alert.jsonOptions.actions=this.alert.jsonOptions.actions.map(e=>{const t={...e,data:this.actionList.find(o=>e.idAction==o.id)};return t.thresholdData=t.thresholdValues.map(o=>this.kpi.threshold.thresholdValues.find(d=>d.id==o)),t}))}},computed:{disableActionButton(){for(var e in this.kpi)return!1;return!0}},data(){return{alertDescriptor:O,alert:{},kpi:{},oldKpi:null,items:[]}},methods:{toggleMenu(e,t){this.createMenuItems(t),this.$refs.menu.toggle(e)},createMenuItems(e){this.items=[],this.items.push({label:this.$t("common.modify"),icon:"pi pi-pencil",command:()=>{this.$emit("showDialog",e)}}),this.items.push({label:this.$t("common.delete"),icon:"far fa-trash-alt",command:()=>{this.$emit("touched"),this.alert.jsonOptions.actions.splice(e.index,1)}})},async loadKpi(e,t){e!=null&&await this.$http.get(`/knowage/restful-services/1.0/kpi/${e}/${t}/loadKpi`).then(o=>{this.oldKpi={...o.data},this.kpi={...o.data},this.$emit("kpiLoaded",this.kpi)})},confirmLoadSelectedKpi(e){this.alert.jsonOptions.actions.length>0?this.$confirm.require({message:this.$t("kpi.alert.kpiEditingMessage"),header:this.$t("kpi.alert.kpiEditing"),icon:"pi pi-exclamation-triangle",accept:()=>{this.loadKpi(e.id,e.version),this.alert.jsonOptions.actions=[],this.alert.jsonOptions.kpiId=e.id,this.alert.jsonOptions.kpiVersion=e.version,this.oldKpi=this.kpi,this.$emit("touched")},reject:()=>{this.kpi=this.oldKpi}}):(this.loadKpi(e.id,e.version),this.alert.jsonOptions.kpiId=e.id,this.alert.jsonOptions.kpiVersion=e.version,this.oldKpi=this.kpi)},getActionLabel(e){for(var t=0;t<this.actionList.length;t++)if(this.actionList[t].id==e)return this.actionList[t].name;return""},getThresholdItem(e){var d,h;if(!((h=(d=this.kpi)==null?void 0:d.threshold)!=null&&h.thresholdValues))return[];for(var t=[],o=0;o<this.kpi.threshold.thresholdValues.length;o++)e.indexOf(""+this.kpi.threshold.thresholdValues[o].id)!=-1&&t.push(this.kpi.threshold.thresholdValues[o]);return t}}}),ke=e=>(P("data-v-96ee25a4"),e=e(),F(),e),ve={class:"p-field"},he={class:"p-float-label"},ge=ke(()=>a("label",{for:"kpi",class:"kn-material-input-label"}," Kpi *",-1)),ye={class:"p-grid p-mt-2"},we={key:0,class:"p-d-flex p-flex-column severity-container p-m-2"},Ae={flex:""},xe={key:0,class:"severity-box",style:{}};function Ce(e,t,o,d,h,$){const b=r("Dropdown"),p=r("Button"),k=r("Toolbar"),n=r("Menu"),f=r("Card");return l(),y(f,{style:A(e.alertDescriptor.styles.basicCard),class:"p-m-2"},{content:c(()=>{var E;return[a("div",ve,[a("span",he,[i(b,{id:"kpi",class:"kn-material-input",dataKey:"id",modelValue:e.kpi,"onUpdate:modelValue":t[0]||(t[0]=v=>e.kpi=v),options:e.kpiList,optionLabel:"name",onChange:t[1]||(t[1]=v=>e.confirmLoadSelectedKpi(v.value))},null,8,["modelValue","options"]),ge])]),i(k,{class:"kn-toolbar kn-toolbar--primary"},{start:c(()=>[a("span",null,s(e.$t("kpi.alert.actionList")),1)]),end:c(()=>[i(p,{label:e.$t("kpi.alert.addAction"),class:"p-button-text p-button-rounded p-button-plain",disabled:e.disableActionButton,onClick:t[2]||(t[2]=v=>e.$emit("showDialog")),"data-test":"add-action-button"},null,8,["label","disabled"])]),_:1}),a("div",ye,[(l(!0),g(j,null,T((E=e.alert.jsonOptions)==null?void 0:E.actions,(v,L)=>(l(),g("div",{class:"p-m-2 p-shadow-2 action-box",key:L},[i(k,{class:"kn-toolbar kn-toolbar--primary p-col-12"},{start:c(()=>{var u;return[a("span",null,s((u=v.data)==null?void 0:u.name),1)]}),end:c(()=>[i(p,{class:"p-button-link p-button-sm",style:A(e.alertDescriptor.styles.menuButton),icon:"fa fa-ellipsis-v",onClick:u=>e.toggleMenu(u,{action:v,index:L}),"aria-haspopup":"true","aria-controls":"overlay_menu","data-test":"menu-button"},null,8,["style","onClick"]),i(n,{ref_for:!0,ref:"menu",model:e.items,popup:!0,"data-test":"menu"},null,8,["model"])]),_:2},1024),v?(l(),g("div",we,[(l(!0),g(j,null,T(v.thresholdData,(u,w)=>(l(),g("div",{class:"p-d-inline-flex p-m-2",key:w},[a("div",{class:"color-box",style:A({"background-color":u==null?void 0:u.color})},null,4),a("span",Ae,s(u==null?void 0:u.label),1),(u==null?void 0:u.severityCd)!=null?(l(),g("span",xe,"("+s(u.severityCd)+")",1)):D("",!0)]))),128))])):D("",!0)]))),128))])]}),_:1},8,["style"])}var $e=C(me,[["render",Ce],["__scopeId","data-v-96ee25a4"]]);const De=x({name:"events-card",components:{InputNumber:R,Checkbox:Z},props:{selectedAlert:{type:Object,required:!1},vcomp:Object},emits:["touched","valueChanged"],watch:{selectedAlert(){this.alert={...this.selectedAlert}}},data(){return{alert:{},alertDescriptor:O}},methods:{valueChanged(e,t){this.$emit("valueChanged",{fieldName:e,value:t})}}}),Me={class:"p-fluid p-formgrid p-grid"},Ee={class:"p-field p-col-6"},Le={class:"p-float-label"},je={for:"noOfEvents",class:"kn-material-input-label"},Te={class:"p-field-checkbox"},Oe={for:"execution"};function Se(e,t,o,d,h,$){const b=r("InputNumber"),p=r("Checkbox"),k=r("Card");return l(),y(k,{style:A(e.alertDescriptor.styles.basicCard),class:"p-m-2"},{content:c(()=>[a("form",Me,[a("div",Ee,[a("span",Le,[i(b,{id:"noOfEvents",inputClass:"kn-material-input",modelValue:e.alert.eventBeforeTriggerAction,"onUpdate:modelValue":t[0]||(t[0]=n=>e.alert.eventBeforeTriggerAction=n),onInput:t[1]||(t[1]=n=>e.valueChanged("eventBeforeTriggerAction",n.value))},null,8,["modelValue"]),a("label",je,s(e.$t("kpi.alert.noOfEvents")),1)])]),a("div",Te,[i(p,{id:"execution",modelValue:e.alert.singleExecution,"onUpdate:modelValue":t[2]||(t[2]=n=>e.alert.singleExecution=n),binary:!0,onClick:t[3]||(t[3]=n=>e.valueChanged("singleExecution",n))},null,8,["modelValue"]),a("label",Oe,s(e.$t("kpi.alert.execution")),1)])])]),_:1},8,["style"])}var Ve=C(De,[["render",Se]]);const Ue=[{field:"DOCUMENT_LABEL",header:"kpi.alert.name"},{field:"DOCUMENT_NAME",header:"kpi.alert.label"}],Ne={breakpoints:{"640px":"100vw","960px":"85vw"},style:{width:"70vw"}},Ie=["label","name"];var z={columnsDocument:Ue,dialog:Ne,documentFilterFields:Ie};const _e=x({name:"etl-card",components:{DataTable:J,Column:X},props:{loading:{type:Boolean},files:{type:Array},data:{type:Object}},created(){this.loadData()},data(){return{addActionDialogDescriptor:z,selectedFiles:[],myData:{},filters:{global:[V],label:{operator:_.AND,constraints:[V]},name:{operator:_.AND,constraints:[V]}}}},methods:{loadData(){var e,t;this.myData=this.data,this.selectedFiles=(t=(e=this.myData)==null?void 0:e.jsonActionParameters)!=null&&t.listDocIdSelected?[...this.myData.jsonActionParameters.listDocIdSelected]:[]},fileSelected(){this.myData.jsonActionParameters.listDocIdSelected=this.selectedFiles.map(e=>({DOCUMENT_ID:e.DOCUMENT_ID}))}}}),Ke={class:"table-header"},Be={class:"p-input-icon-left"},ze=a("i",{class:"pi pi-search"},null,-1);function qe(e,t,o,d,h,$){const b=r("InputText"),p=r("Column"),k=r("DataTable");return l(),y(k,{selection:e.selectedFiles,"onUpdate:selection":t[1]||(t[1]=n=>e.selectedFiles=n),value:e.files,loading:e.loading,class:"p-datatable-sm kn-table",dataKey:"DOCUMENT_ID",responsiveLayout:"stack",filters:e.filters,"onUpdate:filters":t[2]||(t[2]=n=>e.filters=n),filterDisplay:"menu",globalFilterFields:e.addActionDialogDescriptor.documentFilterFields,onRowSelect:e.fileSelected,onRowUnselect:e.fileSelected,onRowSelectAll:e.fileSelected,onRowUnselectAll:e.fileSelected},{header:c(()=>[a("div",Ke,[a("span",Be,[ze,i(b,{class:"kn-material-input",type:"text",modelValue:e.filters.global.value,"onUpdate:modelValue":t[0]||(t[0]=n=>e.filters.global.value=n),placeholder:e.$t("common.search"),badge:"0","data-test":"search-input"},null,8,["modelValue","placeholder"])])])]),empty:c(()=>[M(s(e.$t("common.info.noDataFound")),1)]),loading:c(()=>[M(s(e.$t("common.info.dataLoading")),1)]),default:c(()=>[i(p,{selectionMode:"multiple",headerStyle:"width: 3rem"}),(l(!0),g(j,null,T(e.addActionDialogDescriptor.columnsDocument,n=>(l(),y(p,{field:n.field,header:e.$t(n.header),key:n.field,sortable:!0,class:"kn-truncated"},{body:c(f=>[a("span",null,s(f.data[f.column.props.field]),1)]),_:2},1032,["field","header"]))),128))]),_:1},8,["selection","value","loading","filters","globalFilterFields","onRowSelect","onRowUnselect","onRowSelectAll","onRowUnselectAll"])}var Pe=C(_e,[["render",qe]]);const Fe=x({name:"contex-broker-card",data(){return{myData:{}}},props:{data:{type:Object}},created(){this.loadData()},methods:{loadData(){this.myData=this.data}}}),Re={class:"p-fluid"},Je={class:"p-field p-float-label"},Xe={for:"url",class:"kn-material-input-label"},Qe={class:"p-field p-float-label"},Ye={for:"type",class:"kn-material-input-label"};function We(e,t,o,d,h,$){const b=r("InputText");return l(),g("form",Re,[a("span",Je,[i(b,{id:"url",class:"kn-material-input",type:"text",modelValue:e.myData.jsonActionParameters.contextBrokerUrl,"onUpdate:modelValue":t[0]||(t[0]=p=>e.myData.jsonActionParameters.contextBrokerUrl=p)},null,8,["modelValue"]),a("label",Xe,s(e.$t("kpi.alert.brokerUrl"))+" * ",1)]),a("span",Qe,[i(b,{id:"type",class:"kn-material-input",type:"text",modelValue:e.myData.jsonActionParameters.contextBrokerType,"onUpdate:modelValue":t[1]||(t[1]=p=>e.myData.jsonActionParameters.contextBrokerType=p)},null,8,["modelValue"]),a("label",Ye,s(e.$t("kpi.alert.brokerType"))+" * ",1)])])}var Ge=C(Fe,[["render",We]]);const He={style:{height:"260px"}};var Ze={editor:He};const et=x({name:"send-mail-card",components:{AutoComplete:ae,Editor:oe},props:{action:{type:Object},users:{type:Array}},data(){return{sendMailCardDescriptor:Ze,selectedAction:{},userList:[],selectedUsers:[],filteredUsers:[]}},watch:{users(){this.loadUsers()}},created(){this.loadAction(),this.loadUsers()},methods:{loadAction(){var e,t;this.selectedAction=this.action,this.selectedUsers=(t=(e=this.selectedAction)==null?void 0:e.jsonActionParameters)!=null&&t.mailTo?this.selectedAction.jsonActionParameters.mailTo:[]},loadUsers(){this.userList=this.users},searchUsers(e){setTimeout(()=>{e.query.trim().length?this.filteredUsers=this.userList.filter(t=>t.name.toLowerCase().startsWith(e.query.toLowerCase())||t.email.toLowerCase().startsWith(e.query.toLowerCase())):this.filteredUsers=[...this.userList]},250)},createMailChip(e){e.target.value&&(this.selectedUsers.push({name:e.target.value,userId:"",email:e.target.value}),this.userList.push({name:e.target.value,userId:"",email:e.target.value}),e.target.value="",this.selectedAction.jsonActionParameters.mailTo=this.selectedUsers)}}}),tt={class:"p-float-label p-m-4"},at={for:"mailTo",class:"kn-material-input-label"},ot={id:"chips-help"},rt={class:"p-float-label p-m-4"},nt={for:"mailSubject",class:"kn-material-input-label"},it={class:"p-field"};function lt(e,t,o,d,h,$){const b=r("AutoComplete"),p=r("InputText"),k=r("Editor");return l(),g(j,null,[a("span",tt,[i(b,{id:"mailTo",class:"p-inputtext-sm",multiple:!0,modelValue:e.selectedUsers,"onUpdate:modelValue":t[0]||(t[0]=n=>e.selectedUsers=n),suggestions:e.filteredUsers,field:"name",onKeydown:Q(e.createMailChip,["enter"]),onComplete:t[1]||(t[1]=n=>e.searchUsers(n)),onItemSelect:t[2]||(t[2]=n=>e.setUser(n.value))},null,8,["modelValue","suggestions","onKeydown"]),a("label",at,s(e.$t("kpi.alert.mailTo")),1),a("small",ot,s(e.$t("common.chipsHint")),1)]),a("span",rt,[i(p,{id:"mailSubject",class:"kn-material-input",modelValue:e.selectedAction.jsonActionParameters.subject,"onUpdate:modelValue":t[3]||(t[3]=n=>e.selectedAction.jsonActionParameters.subject=n),modelModifiers:{trim:!0}},null,8,["modelValue"]),a("label",nt,s(e.$t("kpi.alert.mailSubject")),1)]),a("div",it,[a("span",null,[i(k,{id:"html",modelValue:e.selectedAction.jsonActionParameters.body,"onUpdate:modelValue":t[4]||(t[4]=n=>e.selectedAction.jsonActionParameters.body=n),editorStyle:e.sendMailCardDescriptor.editor.style},null,8,["modelValue","editorStyle"])])])],64)}var st=C(et,[["render",lt]]);const dt=x({name:"add-action-dialog",components:{Dialog:Y,Dropdown:N,MultiSelect:te,ExectuteEtlCard:Pe,ContextBrokerCard:Ge,SendMailCard:st},props:{actionList:[],dialogVisible:{type:Boolean,default:!1},kpi:{type:Object},selectedAction:{type:Object,required:!0}},emits:["save"],data(){return{v$:K(),addActionDialogDescriptor:z,type:{},action:{},selectedThresholds:[],data:[],etlDocumentList:[],usersList:[],formatedUsers:[],loading:!1}},computed:{componentToShow(){switch(this.action.className){case"it.eng.knowage.enterprise.tools.alert.action.ExecuteETLDocument":return"ExectuteEtlCard";case"it.eng.spagobi.tools.alert.action.NotifyContextBroker":return"ContextBrokerCard";case"it.eng.knowage.enterprise.tools.alert.action.SendMail":return"SendMailCard";default:return""}},actionSaveButtonDisabled(){return!this.action.className||this.selectedThresholds.length==0?!0:!!(this.action.className!="it.eng.knowage.enterprise.tools.alert.action.SendMail"&&this.isObjectEmpty(this.action.jsonActionParameters))}},created(){this.loadAction(),this.loadEtlDocuments(),this.loadUsers()},watch:{selectedAction(){this.loadAction()}},validations(){return{action:B("action",U.validations.action)}},methods:{isObjectEmpty(e){for(var t in e)return!1;return!0},loadAction(){this.action={...this.selectedAction},this.type=this.action.idAction,this.selectedThresholds=this.selectedAction.thresholdData?this.selectedAction.thresholdData:[]},async setType(e){this.action.jsonActionParameters={};var t=this.actionList.find(o=>o.id===e.value);this.action.className=t.className,this.action.className=="it.eng.knowage.enterprise.tools.alert.action.SendMail"&&(this.action.className="it.eng.knowage.enterprise.tools.alert.action.SendMail",this.formatUsers())},formatUsers(){for(let e=0;e<this.usersList.length;e++){const t=this.usersList[e].sbiUserAttributeses;for(let o in t)t[o].email&&this.formatedUsers.push({name:this.usersList[e].fullName,userId:this.usersList[e].userId,email:t[o].email})}},async loadEtlDocuments(){await this.$http.get("/knowage/restful-services/2.0/documents/listDocument?includeType=ETL").then(e=>{this.etlDocumentList=e.data?e.data.item:[]})},async loadUsers(){await this.$http.get("/knowage/restful-services/2.0/users").then(e=>{this.usersList=e.data})},handleSave(){this.action.thresholdValues=this.selectedThresholds.map(e=>e.id),this.$emit("save",this.action)}}}),ct={class:"p-fluid p-formgrid p-grid"},pt={class:"p-field p-col-6 p-mt-4 p-float-label"},ut={for:"type",class:"kn-material-input-label"},bt={class:"p-field p-col-6 p-mt-4 p-float-label"},ft={class:"selected-options-container"},mt={for:"threshold",class:"kn-material-input-label"};function kt(e,t,o,d,h,$){const b=r("Button"),p=r("Toolbar"),k=r("Dropdown"),n=r("MultiSelect"),f=r("ExectuteEtlCard"),E=r("ContextBrokerCard"),v=r("SendMailCard"),L=r("Card"),u=r("Dialog");return l(),y(u,{header:e.$t("kpi.alert.addAction"),breakpoints:e.addActionDialogDescriptor.dialog.breakpoints,style:A(e.addActionDialogDescriptor.dialog.style),visible:e.dialogVisible,modal:!0,closable:!1,class:"p-fluid kn-dialog--toolbar--primary","data-test":"add-action-dialog"},{header:c(()=>[i(p,{class:"kn-toolbar kn-toolbar--primary p-col-12"},{start:c(()=>[M(s(e.$t("kpi.alert.addAction")),1)]),end:c(()=>[i(b,{icon:"pi pi-save",class:"p-button-text p-button-rounded p-button-plain",disabled:e.actionSaveButtonDisabled,onClick:e.handleSave},null,8,["disabled","onClick"]),i(b,{icon:"pi pi-times",class:"p-button-text p-button-rounded p-button-plain",onClick:t[0]||(t[0]=w=>e.$emit("close"))})]),_:1})]),default:c(()=>{var w;return[a("div",ct,[a("span",pt,[i(k,{id:"type",class:"kn-material-input",modelValue:e.action.idAction,"onUpdate:modelValue":t[1]||(t[1]=m=>e.action.idAction=m),dataKey:"id",optionLabel:"name",optionValue:"id",options:e.actionList,onChange:e.setType},null,8,["modelValue","options","onChange"]),a("label",ut,s(e.$t("kpi.alert.type"))+" * ",1)]),a("span",bt,[i(n,{id:"threshold",class:"kn-material-input",modelValue:e.selectedThresholds,"onUpdate:modelValue":t[2]||(t[2]=m=>e.selectedThresholds=m),optionLabel:"label",options:(w=e.kpi.threshold)==null?void 0:w.thresholdValues},{value:c(m=>[(l(!0),g(j,null,T(m.value,S=>(l(),g("div",{class:"selected-options-container",key:S.code},[a("div",{class:"color-box",style:A({"background-color":S.color})},null,4),M(" "+s(S.label),1)]))),128))]),option:c(m=>[a("div",ft,[a("div",{class:"color-box",style:A({"background-color":m.option.color})},null,4),M(" "+s(m.option.label),1)])]),_:1},8,["modelValue","options"]),a("label",mt,s(e.$t("kpi.alert.threshold"))+" * ",1)])]),i(L,{style:{height:"37rem"}},{content:c(()=>[e.action&&e.action.className=="it.eng.knowage.enterprise.tools.alert.action.ExecuteETLDocument"?(l(),y(f,{key:0,loading:e.loading,files:e.etlDocumentList,data:e.action},null,8,["loading","files","data"])):D("",!0),e.action&&e.action.className=="it.eng.spagobi.tools.alert.action.NotifyContextBroker"?(l(),y(E,{key:1,data:e.action},null,8,["data"])):e.action&&e.action.className=="it.eng.knowage.enterprise.tools.alert.action.SendMail"?(l(),y(v,{key:2,action:e.action,users:e.formatedUsers},null,8,["action","users"])):D("",!0)]),_:1})]}),_:1},8,["header","breakpoints","style","visible"])}var vt=C(dt,[["render",kt],["__scopeId","data-v-1c1eaf80"]]);const ht=x({name:"alert-details",components:{NameCard:fe,EventsCard:Ve,AddActionDialog:vt,KpiCard:$e,Message:W,KnCron:ee},props:{id:{type:String,required:!1}},watch:{async id(){await this.checkId(),this.id==null&&(this.selectedAlert={id:null,singleExecution:!1,jsonOptions:{actions:[]},frequency:{cron:{type:"minute",parameter:{numRepetition:"1"}},startDate:new Date().valueOf(),endDate:null,startTime:new Date().valueOf(),endTime:""}})}},computed:{isListenerSelected(){return!(!this.selectedAlert.alertListener||this.selectedAlert.alertListener===this.emptyObject)},buttonDisabled(){var e,t;return((t=(e=this.selectedAlert.jsonOptions)==null?void 0:e.actions)==null?void 0:t.length)===0||!this.selectedAlert.name||!this.selectedAlert.alertListener||this.validCron==!1}},setup(){return{store:G()}},created(){this.id?this.loadAlert():this.selectedAlert={id:null,singleExecution:!1,jsonOptions:{actions:[]},frequency:{cron:{type:"minute",parameter:{numRepetition:"1"}},startDate:new Date().valueOf(),endDate:null,startTime:new Date().valueOf(),endTime:""}},this.loadListener(),this.loadKpiList(),this.loadActionList()},data(){return{v$:K(),alertValidationDescriptor:U,alertDescriptor:O,kpi:{},emptyObject:{},jsonOptions:{},selectedAlert:{},selectedAction:{},listeners:[],actionList:[],actions:[],kpiList:[],isActionDialogVisible:!1,expiredCard:!1,touched:!1,actionIndexToEdit:-1,validCron:!0}},validations(){return{selectedAlert:B("alert",U.validations.alert)}},methods:{async loadAlert(){await this.$http.get("/knowage/restful-services/1.0/alert/"+this.id+"/load").then(e=>{var t,o;this.selectedAlert={...e.data},this.selectedAlert.jsonOptions=JSON.parse(this.selectedAlert.jsonOptions?this.selectedAlert.jsonOptions:"{}"),this.selectedAlert.frequency&&(this.selectedAlert.frequency.cron=JSON.parse(this.selectedAlert.frequency.cron?this.selectedAlert.frequency.cron:"{}"),this.selectedAlert.frequency.startDate=(t=this.selectedAlert.frequency.startDate)!=null?t:new Date),this.selectedAlert.jsonOptions&&(this.selectedAlert.jsonOptions.actions=(o=this.selectedAlert.jsonOptions.actions)==null?void 0:o.map(d=>({jsonActionParameters:JSON.parse(d.jsonActionParameters),idAction:d.idAction,thresholdValues:d.thresholdValues})))}).finally(()=>this.expiredCard=this.selectedAlert.jobStatus=="EXPIRED")},async loadListener(){await this.$http.get("/knowage/restful-services/1.0/alert/listListener").then(e=>{this.listeners=e.data})},async loadKpiList(){await this.$http.get("/knowage/restful-services/1.0/kpi/listKpi").then(e=>{this.kpiList=[...e.data]})},async loadActionList(){await this.$http.get("/knowage/restful-services/1.0/alert/listAction").then(e=>{this.actionList=[...e.data]})},updateAlert(e){this.touched=!0,e.fieldName=="singleExecution"?this.selectedAlert.singleExecution=!this.selectedAlert.singleExecution:this.selectedAlert[e.fieldName]=e.value},async handleSubmit(){let e=JSON.parse(JSON.stringify(this.selectedAlert));e.jsonOptions&&(e.jsonOptions.actions=e.jsonOptions.actions.map(o=>({jsonActionParameters:JSON.stringify(o.jsonActionParameters),idAction:o.idAction,thresholdValues:o.thresholdValues}))),e.jsonOptions=JSON.stringify(e.jsonOptions),e.frequency&&(e.frequency.cron=JSON.stringify(e.frequency.cron));let t=e.id?"update":"insert";await this.$http.post("/knowage/restful-services/1.0/alert/save",e).then(o=>{this.touched=!1,this.store.setInfo({title:this.$t(this.alertDescriptor.operation[t].toastTitle),msg:this.$t(this.alertDescriptor.operation.success)}),this.$emit("saved",o.data.id)}).catch(o=>{this.store.setError({title:this.$t("kpi.alert.savingError"),msg:o.message})})},async checkId(){this.id?await this.loadAlert():this.selectedAlert={id:null,singleExecution:!1,frequency:{cron:{type:"minute",parameter:{numRepetition:"1"}},startDate:new Date().valueOf(),endDate:null,startTime:new Date().valueOf(),endTime:""}},this.v$.$reset()},closeTemplateConfirm(){this.touched?this.$confirm.require({message:this.$t("common.toast.unsavedChangesMessage"),header:this.$t("common.toast.unsavedChangesHeader"),icon:"pi pi-exclamation-triangle",accept:()=>{this.touched=!1,this.closeTemplate()}}):this.closeTemplate()},closeTemplate(){this.$emit("close")},updateKpi(e){this.kpi=e},onActionSave(e){this.isActionDialogVisible=!1,this.touched=!0;const t={...e,idAction:+e.idAction,data:this.actionList.find(o=>e.idAction==o.id)};t.thresholdData=t.thresholdValues.map(o=>this.kpi.threshold.thresholdValues.find(d=>d.id==o)),this.actionIndexToEdit===-1?this.selectedAlert.jsonOptions.actions.push(t):this.selectedAlert.jsonOptions.actions[this.actionIndexToEdit]=t},onShowActionDialog(e){this.selectedAction=e&&e.action?{...e.action,idAction:+e.action.idAction,className:e.action.data.className}:{jsonActionParameters:{}},this.actionIndexToEdit=e?e.index:-1,this.isActionDialogVisible=!0},setCronValid(e){this.validCron=e}}}),gt={class:"p-grid p-m-0 p-jc-center",style:{overflow:"auto"}};function yt(e,t,o,d,h,$){var u,w;const b=r("Button"),p=r("Toolbar"),k=r("Message"),n=r("NameCard"),f=r("KnCron"),E=r("EventsCard"),v=r("KpiCard"),L=r("AddActionDialog");return l(),g(j,null,[i(p,{class:"kn-toolbar kn-toolbar--secondary p-m-0"},{start:c(()=>[M(s(e.selectedAlert.name),1)]),end:c(()=>[i(b,{icon:"pi pi-save",class:"p-button-text p-button-rounded p-button-plain",disabled:e.buttonDisabled,onClick:e.handleSubmit},null,8,["disabled","onClick"]),i(b,{icon:"pi pi-times",class:"p-button-text p-button-rounded p-button-plain",onClick:e.closeTemplateConfirm},null,8,["onClick"])]),_:1}),a("div",gt,[e.expiredCard?(l(),y(k,{key:0,class:"p-m-2",severity:"warn",closable:!0,style:A(e.alertDescriptor.styles.message)},{default:c(()=>[M(s(e.$t("kpi.alert.expiredWarning")),1)]),_:1},8,["style"])):D("",!0),i(n,{selectedAlert:e.selectedAlert,listeners:e.listeners,onValueChanged:e.updateAlert,vcomp:e.v$.selectedAlert},null,8,["selectedAlert","listeners","onValueChanged","vcomp"]),(u=e.selectedAlert)!=null&&u.frequency?(l(),y(f,{key:1,class:"p-m-2",frequency:e.selectedAlert.frequency,onTouched:t[0]||(t[0]=m=>e.touched=!0),onCronValid:t[1]||(t[1]=m=>e.setCronValid(m))},null,8,["frequency"])):D("",!0),i(E,{selectedAlert:e.selectedAlert,onValueChanged:e.updateAlert},null,8,["selectedAlert","onValueChanged"]),e.isListenerSelected&&((w=e.actionList)==null?void 0:w.length)>0?(l(),y(v,{key:2,selectedAlert:e.selectedAlert,kpiList:e.kpiList,actionList:e.actionList,onShowDialog:t[2]||(t[2]=m=>e.onShowActionDialog(m)),onKpiLoaded:e.updateKpi,onTouched:t[3]||(t[3]=m=>e.touched=!0)},null,8,["selectedAlert","kpiList","actionList","onKpiLoaded"])):D("",!0)]),i(L,{dialogVisible:e.isActionDialogVisible,kpi:e.kpi,selectedAction:e.selectedAction,actionList:e.actionList,onClose:t[4]||(t[4]=m=>e.isActionDialogVisible=!1),onSave:e.onActionSave},null,8,["dialogVisible","kpi","selectedAction","actionList","onSave"])],64)}var Vt=C(ht,[["render",yt]]);export{Vt as default};
//# sourceMappingURL=AlertDefinitionDetail-d89887b8.js.map
