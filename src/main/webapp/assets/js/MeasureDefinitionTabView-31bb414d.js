import{d as D,a4 as O,_ as $,r as s,o as r,c as v,f as l,w as i,g as C,t as k,a as c,G as I,B as A,l as U,a5 as L,n as P,y as _,h as x,z as Q,A as g,D as T,p as X,b as F,i as S,C as E,ad as q,ah as K,aX as m,v as j,u as Y,s as J}from"./index-1e676509.js";import{s as G}from"./autocomplete.esm-bebdfcbd.js";import{s as H}from"./chip.esm-057ba1f1.js";const Z=["name"],W={style:{width:"60vw"}},aa={style:{width:"60vw","z-index":"9999"},contentStyle:{flex:1}},ea={style:{"max-height":"450px"}},ta=["name"];var R={aliasFilterFields:Z,dialog:W,errorDialog:aa,listBox:ea,placeholderFilterFields:ta};const oa=D({name:"measure-definition-filter-list",components:{Listbox:O},props:{header:{type:String},list:{type:Array},listType:{type:String}},emits:["selected"],data(){return{metadataDefinitionTabViewDescriptor:R,filters:[],sorted:"DESC"}},computed:{iconClass(){return this.sorted==="DESC"?"pi pi-arrow-down":"pi pi-arrow-up"}},watch:{list(){this.loadList()}},created(){this.loadList()},methods:{loadList(){this.filters=this.list},sortArray(){this.sorted==="DESC"?(this.filters=this.filters.sort((a,e)=>a.name>e.name?1:-1),this.sorted="ASC"):(this.filters=this.filters.sort((a,e)=>a.name<e.name?1:-1),this.sorted="DESC")}}}),ra=["data-test"],na={class:"kn-list-item-text"};function ia(a,e,t,b,p,f){const d=s("Toolbar"),h=s("Listbox");return r(),v(A,null,[l(d,{class:"kn-toolbar kn-toolbar--primary"},{start:i(()=>[C(k(a.header),1)]),end:i(()=>[c("i",{class:I(a.iconClass),onClick:e[0]||(e[0]=(...u)=>a.sortArray&&a.sortArray(...u)),"data-test":"sort-icon"},null,2)]),_:1}),l(h,{class:"kn-list kn-flex",options:a.filters,listStyle:a.metadataDefinitionTabViewDescriptor.listBox.style,filter:!0,filterPlaceholder:a.$t("common.search"),optionLabel:"name",filterMatchMode:"contains",filterFields:a.metadataDefinitionTabViewDescriptor.aliasFilterFields,emptyFilterMessage:a.$t("common.info.noDataFound"),onChange:e[1]||(e[1]=u=>a.$emit("selected",{value:u.value.name,type:a.listType}))},{empty:i(()=>[C(k(a.$t("common.info.noDataFound")),1)]),option:i(u=>[c("div",{class:"kn-list-item","data-test":"list-item-"+u.option.id},[c("div",na,[c("span",null,k(u.option.name),1)])],8,ra)]),_:1},8,["options","listStyle","filterPlaceholder","filterFields","emptyFilterMessage"])],64)}var la=$(oa,[["render",ia],["__scopeId","data-v-49c77625"]]);const da={style:{width:"60vw"}},sa={iconColumn:{style:{width:"5%"}}};var ca={dialog:da,table:sa};const ba=D({name:"measure-definition-metadata-card",components:{AutoComplete:G,Column:U,Dropdown:L,DataTable:P},props:{currentRule:{type:Object,required:!0},tipologiesType:{type:Array,required:!0},domainsTemporalLevel:{type:Array},categories:{type:Array,required:!0}},emits:["touched"],data(){return{metadataCardDescriptor:ca,rule:{ruleOutputs:[]},filteredCategories:[],metadataError:null}},async mounted(){this.loadRule()},methods:{loadRule(){this.rule=this.currentRule},searchCategories(a){setTimeout(()=>{a.query.trim().length?this.filteredCategories=this.categories.filter(e=>e.valueCd.toLowerCase().startsWith(a.query.toLowerCase())):this.filteredCategories=[...this.categories]},250)},alisIconTooltip(a){if(a.includes("icon-used"))return this.$t("kpi.measureDefinition.aliasUsed");if(a.includes("icon-missing"))return this.$t("kpi.measureDefinition.aliasMissing")},setRuleCategory(a,e){e.category.valueCd=a.valueCd}}}),V=a=>(X("data-v-64e1e401"),a=a(),F(),a),pa={key:0},ka=V(()=>c("i",{class:"pi pi-pencil edit-icon"},null,-1)),ua={key:0},va={key:1},fa=V(()=>c("i",{class:"pi pi-pencil edit-icon"},null,-1));function ma(a,e,t,b,p,f){const d=s("Column"),h=s("Dropdown"),u=s("AutoComplete"),y=s("DataTable"),M=_("tooltip");return a.metadataError?g("",!0):(r(),x(y,{key:0,class:"p-datatable-sm kn-table",value:a.rule.ruleOutputs,dataKey:"id",responsiveLayout:"stack",breakpoint:"960px","data-test":"metadata-table"},{default:i(()=>[l(d,{style:T(a.metadataCardDescriptor.table.iconColumn.style)},{body:i(n=>[n.data.aliasIcon?Q((r(),v("i",{key:0,class:I(n.data.aliasIcon)},null,2)),[[M,a.alisIconTooltip(n.data.aliasIcon),void 0,{top:!0}]]):g("",!0)]),_:1},8,["style"]),l(d,{class:"kn-truncated",field:"alias",header:a.$t("kpi.measureDefinition.alias")},null,8,["header"]),l(d,{class:"kn-truncated",field:"type",header:a.$t("kpi.measureDefinition.tipology")},{body:i(n=>[l(h,{class:"metaweb-dropdown-field p-mr-2",modelValue:n.data.type,"onUpdate:modelValue":o=>n.data.type=o,options:a.tipologiesType,onChange:e[0]||(e[0]=o=>a.$emit("touched"))},{value:i(o=>[o.value?(r(),v("div",pa,[c("span",null,k(o.value.valueCd),1)])):g("",!0)]),option:i(o=>[c("div",null,[c("span",null,k(o.option.valueCd),1)])]),_:2},1032,["modelValue","onUpdate:modelValue","options"]),ka]),_:1},8,["header"]),l(d,{header:a.$t("common.category")},{body:i(n=>[n.data.category&&n.data.type.valueCd!="TEMPORAL_ATTRIBUTE"?(r(),x(u,{key:0,class:"metaweb-dropdown-field p-mr-2",modelValue:n.data.category.valueCd,"onUpdate:modelValue":o=>n.data.category.valueCd=o,suggestions:a.filteredCategories,field:"valueCd",onComplete:e[1]||(e[1]=o=>a.searchCategories(o)),onInput:e[2]||(e[2]=o=>a.$emit("touched")),onItemSelect:o=>a.setRuleCategory(o.value,n.data)},null,8,["modelValue","onUpdate:modelValue","suggestions","onItemSelect"])):(r(),x(h,{key:1,class:"metaweb-dropdown-field p-mr-2",modelValue:n.data.hierarchy,"onUpdate:modelValue":o=>n.data.hierarchy=o,options:a.domainsTemporalLevel,placeholder:a.$t("kpi.measureDefinition.temporalAttributePlaceholder"),onChange:e[3]||(e[3]=o=>a.$emit("touched"))},{value:i(o=>[o.value?(r(),v("div",ua,[c("span",null,k(o.value.valueCd),1)])):(r(),v("span",va,k(o.placeholder),1))]),option:i(o=>[c("div",null,[c("span",null,k(o.option.valueCd),1)])]),_:2},1032,["modelValue","onUpdate:modelValue","options","placeholder"])),fa]),_:1},8,["header"])]),_:1},8,["value"]))}var ga=$(ba,[["render",ma],["__scopeId","data-v-64e1e401"]]),ha={};const wa={contentStyle:{"min-height":"400px"},style:{width:"80vw"}};var xa={dialog:wa};const ya=D({name:"measure-definition-preview-dialog",components:{Column:U,DataTable:P,Dialog:S},props:{currentRule:{type:Object,required:!0},placeholders:{type:Array,required:!0},columns:{type:Array},propRows:{type:Array}},emits:["close","loadPreview"],watch:{propRows(){this.loadRows()},currentRule(){this.loadRule()}},data(){return{previewDialogDescriptor:xa,rule:{},rows:[]}},async created(){this.loadRule(),this.loadRows()},methods:{loadRule(){this.rule=this.currentRule},loadPreview(){this.$emit("loadPreview")},loadRows(){this.rows=this.propRows},closeTemplate(){this.$emit("close")}}}),Ma={class:"p-d-flex"},Aa={key:0,class:"p-col-3"},Ca={class:"p-field p-m-2"},Ea={class:"p-float-label"},Da={class:"kn-material-input-label"};function $a(a,e,t,b,p,f){const d=s("Column"),h=s("DataTable"),u=s("Button"),y=s("Toolbar"),M=s("InputText"),n=s("Dialog");return r(),x(n,{style:T(a.previewDialogDescriptor.dialog.style),contentStyle:a.previewDialogDescriptor.dialog.contentStyle,visible:!0,modal:!0,class:"p-fluid kn-dialog--toolbar--primary",header:a.$t("kpi.measureDefinition.preview"),closable:!1},{footer:i(()=>[l(u,{class:"kn-button kn-button--secondary",label:a.$t("common.close"),onClick:a.closeTemplate},null,8,["label","onClick"])]),default:i(()=>[c("div",Ma,[l(h,{value:a.rows,class:"p-datatable-sm kn-table",dataKey:"id",responsiveLayout:"stack",breakpoint:"960px"},{empty:i(()=>[C(k(a.$t("common.info.noDataFound")),1)]),default:i(()=>[(r(!0),v(A,null,E(a.columns,o=>(r(),x(d,{class:"kn-truncated",field:o.name,header:o.label,key:o.field,sortable:!0},null,8,["field","header"]))),128))]),_:1},8,["value"]),a.rule.placeholders&&a.rule.placeholders.length>0?(r(),v("div",Aa,[l(y,{class:"kn-toolbar kn-toolbar--primary p-m-0"},{start:i(()=>[C(k(a.$t("kpi.measureDefinition.filters")),1)]),end:i(()=>[l(u,{class:"kn-button p-button-text p-button-rounded",onClick:a.loadPreview},{default:i(()=>[C(k(a.$t("common.run")),1)]),_:1},8,["onClick"])]),_:1}),c("div",null,[(r(!0),v(A,null,E(a.rule.placeholders,o=>(r(),v("div",{key:o.id},[c("div",Ca,[c("span",Ea,[l(M,{class:"kn-material-input",type:"text",modelValue:o.value,"onUpdate:modelValue":z=>o.value=z,modelModifiers:{trim:!0}},null,8,["modelValue","onUpdate:modelValue"]),c("label",Da,k(o.name),1)])])]))),128))])])):g("",!0)])]),_:1},8,["style","contentStyle","header"])}var za=$(ya,[["render",$a]]);const Ta=D({name:"measure-definition-query-card",components:{Card:q,Dropdown:L,VCodeMirror:K,MeasureDefinitionPreviewDialog:za},props:{rule:{type:Object,required:!0},datasourcesList:{type:Array,required:!0},aliases:{type:Array},placeholders:{type:Array},columns:{type:Array},rows:{type:Array},codeInput:{type:String},preview:{type:Boolean},activeTab:{type:Number}},emits:["touched","queryChanged","loadPreview","closePreview"],data(){return{queryCardDescriptor:ha,selectedRule:{},code:"",datasourceStructure:{},codeMirror:null,hintList:[],options:{mode:"text/x-mysql",indentWithTabs:!0,smartIndent:!0,lineWrapping:!0,matchBrackets:!0,autofocus:!0,theme:"eclipse",lineNumbers:!0,extraKeys:{"Ctrl-Space":this.keyAssistFunc},hintOptions:{tables:this.datasourceStructure}},cursorPosition:null}},computed:{previewDisabled(){return!this.code}},watch:{codeInput(){this.cursorPosition=this.codeMirror.getCursor(),this.codeMirror.replaceRange(this.codeInput,this.cursorPosition),this.selectedRule.definition=this.code,this.$emit("queryChanged")},activeTab(a){a===0&&this.codeMirror&&setTimeout(()=>this.codeMirror.refresh(),100)}},async mounted(){this.loadRule(),await this.loadDataSourceStructure()},methods:{loadRule(){var a;this.selectedRule=this.rule,this.code=(a=this.rule.definition)!=null?a:""},async loadDataSourceStructure(){this.selectedRule.dataSource&&await this.$http.get(`/knowage/restful-services/2.0/datasources/structure/${this.selectedRule.dataSource.DATASOURCE_ID}`).then(a=>this.datasourceStructure=a.data),this.$emit("touched"),this.setupCodeMirror(),this.codeMirror&&this.codeMirror.options&&(this.codeMirror.options.hintOptions={tables:this.datasourceStructure})},setupCodeMirror(){const a=setInterval(()=>{!this.$refs.codeMirror||(this.codeMirror=this.$refs.codeMirror.cminstance,setTimeout(()=>{this.codeMirror.refresh()},0),clearInterval(a))},200);m.registerHelper("hint","alias",()=>{const e=this.codeMirror.getCursor(),t=this.codeMirror.getTokenAt(e),b=t.string.trim()==""?t.start+1:t.start,p=t.end,f=[];for(const d in this.aliases)(t.string.trim()==""||this.aliases[d].name.startsWith(t.string))&&f.push(this.aliases[d].name);return{list:f,from:m.Pos(e.line,b),to:m.Pos(e.line,p)}}),m.registerHelper("hint","placeholder",()=>{var h;const e=this.codeMirror.getCursor(),t=this.codeMirror.getTokenAt(e),b=t.start+1,p=t.end,f=t.string.substring(1,t.string.length),d=[];for(const u in this.placeholders)(f==""||this.placeholders[u].name.toUpperCase().startsWith(f.toUpperCase()))&&d.push(this.placeholders[u].name);return((h=this.placeholders)==null?void 0:h.length)==1&&d.push(f),{list:d,from:m.Pos(e.line,b),to:m.Pos(e.line,p)}})},keyAssistFunc(){this.isAlias()?m.showHint(this.codeMirror,m.hint.alias):this.isPlaceholder()?m.showHint(this.codeMirror,m.hint.placeholder):m.showHint(this.codeMirror,m.hint.autocomplete)},isAlias(){const a=this.codeMirror.getCursor();let e=this.codeMirror.getTokenAt(a);if(e.string.trim()!=""){const p=m.Pos(a.line,e.start);p.ch=e.start,e=this.codeMirror.getTokenAt(p)}const t=m.Pos(a.line,e.start);if(t.ch=e.start,this.codeMirror.getTokenAt(t).string.toLowerCase()=="as"){const p=this.codeMirror.getDoc().getRange(m.Pos(0,0),t);return!!new RegExp(/^((.*\)\s*select)|(\s*select)) ((?!FROM).)* AS$/gi).test(p.replace(/\n/g," "))}return!1},isPlaceholder(){const a=this.codeMirror.getCursor();if(this.codeMirror.getTokenAt(a).string.startsWith("@"))return!0},onKeyUp(){const a=this.codeMirror.getCursor();this.codeMirror.getTokenAt(a).string=="@"&&m.showHint(this.codeMirror,m.hint.placeholder),this.selectedRule.definition=this.code,this.$emit("queryChanged")},showPreview(){this.$emit("loadPreview")}}}),Sa={class:"p-m-3"},Ra={class:"p-float-label"},Ia={for:"dataSourceLabel",class:"kn-material-input-label"},Ua={key:0};function La(a,e,t,b,p,f){const d=s("Dropdown"),h=s("Button"),u=s("Toolbar"),y=s("VCodeMirror"),M=s("Card"),n=s("MeasureDefinitionPreviewDialog");return r(),v(A,null,[l(M,null,{content:i(()=>[c("div",Sa,[c("span",Ra,[l(d,{id:"dataSource",class:"kn-material-input",modelValue:a.selectedRule.dataSource,"onUpdate:modelValue":e[0]||(e[0]=o=>a.selectedRule.dataSource=o),options:a.datasourcesList,optionLabel:"DATASOURCE_LABEL",onChange:a.loadDataSourceStructure},null,8,["modelValue","options","onChange"]),c("label",Ia,k(a.$t("kpi.measureDefinition.dataSource")),1)])]),a.selectedRule.dataSource?(r(),v("div",Ua,[l(u,{class:"kn-toolbar kn-toolbar--primary p-m-0"},{end:i(()=>[l(h,{class:"kn-button p-button-text p-button-rounded",onClick:a.showPreview,disabled:a.previewDisabled},{default:i(()=>[C(k(a.$t("kpi.measureDefinition.preview")),1)]),_:1},8,["onClick","disabled"])]),_:1}),l(y,{ref:"codeMirror",value:a.code,"onUpdate:value":e[1]||(e[1]=o=>a.code=o),autoHeight:!0,options:a.options,onKeyup:a.onKeyUp},null,8,["value","options","onKeyup"])])):g("",!0)]),_:1}),a.preview?(r(),x(n,{key:0,currentRule:a.selectedRule,placeholders:a.placeholders,columns:a.columns,propRows:a.rows,onClose:e[2]||(e[2]=o=>a.$emit("closePreview")),onLoadPreview:e[3]||(e[3]=o=>a.$emit("loadPreview"))},null,8,["currentRule","placeholders","columns","propRows"])):g("",!0)],64)}var Pa=$(Ta,[["render",La],["__scopeId","data-v-71981168"]]);const Va=D({name:"measure-definition-submit-dialog",components:{Chip:H,Dialog:S},props:{ruleName:{type:String},newAlias:{type:Array},reusedAlias:{type:Array},newPlaceholder:{type:Array},reusedPlaceholder:{type:Array}},emits:["close"],data(){return{metadataDefinitionTabViewDescriptor:R,name:null}},computed:{saveRuleButtonDisabled(){return!this.name}},watch:{currentRule(){this.loadRuleName()}},async created(){this.loadRuleName()},methods:{loadRuleName(){this.name=this.ruleName}}}),Na={class:"p-field p-m-2"},Ba={class:"p-float-label"},Oa={class:"kn-material-input-label"},_a={key:1},Qa={key:2},Xa={key:4},Fa={key:5};function qa(a,e,t,b,p,f){const d=s("InputText"),h=s("Toolbar"),u=s("Chip"),y=s("Button"),M=s("Dialog");return r(),x(M,{contentStyle:a.metadataDefinitionTabViewDescriptor.dialog.style,header:a.$t("kpi.measureDefinition.saveInProgress"),visible:!0,modal:!0,class:"p-fluid kn-dialog--toolbar--primary",closable:!1},{footer:i(()=>[l(y,{class:"kn-button kn-button--secondary",label:a.$t("common.close"),onClick:e[1]||(e[1]=n=>a.$emit("close"))},null,8,["label"]),l(y,{class:"kn-button kn-button--primary",label:a.$t("common.save"),onClick:e[2]||(e[2]=n=>a.$emit("save",a.name)),disabled:a.saveRuleButtonDisabled},null,8,["label","disabled"])]),default:i(()=>[c("div",Na,[c("span",Ba,[l(d,{class:"kn-material-input",type:"text",modelValue:a.name,"onUpdate:modelValue":e[0]||(e[0]=n=>a.name=n),modelModifiers:{trim:!0}},null,8,["modelValue"]),c("label",Oa,k(a.$t("common.name")),1)])]),a.newAlias.length>0||a.reusedAlias.length>0?(r(),x(h,{key:0,class:"kn-toolbar kn-toolbar--primary"},{start:i(()=>[C(k(a.$t("kpi.measureDefinition.alias")),1)]),_:1})):g("",!0),a.newAlias.length>0?(r(),v("div",_a,[c("h4",null,k(a.$t("common.new")),1),(r(!0),v(A,null,E(a.newAlias,n=>(r(),x(u,{class:"p-m-2",key:n.id,label:n},null,8,["label"]))),128))])):g("",!0),a.reusedAlias.length>0?(r(),v("div",Qa,[c("h4",null,k(a.$t("common.reused")),1),(r(!0),v(A,null,E(a.reusedAlias,n=>(r(),x(u,{class:"p-m-2",key:n.id,label:n},null,8,["label"]))),128))])):g("",!0),a.newPlaceholder.length>0||a.reusedPlaceholder.length>0?(r(),x(h,{key:3,class:"kn-toolbar kn-toolbar--primary"},{start:i(()=>[C(k(a.$t("kpi.measureDefinition.placeholder")),1)]),_:1})):g("",!0),a.newPlaceholder.length>0?(r(),v("div",Xa,[c("h4",null,k(a.$t("common.new")),1),(r(!0),v(A,null,E(a.newPlaceholder,n=>(r(),x(u,{class:"p-m-2",key:n.id,label:n},null,8,["label"]))),128))])):g("",!0),a.reusedPlaceholder.length>0?(r(),v("div",Fa,[c("h4",null,k(a.$t("common.reused")),1),(r(!0),v(A,null,E(a.reusedPlaceholder,n=>(r(),x(u,{class:"p-m-2",key:n.id,label:n},null,8,["label"]))),128))])):g("",!0)]),_:1},8,["contentStyle","header"])}var Ka=$(Va,[["render",qa]]);const ja=D({name:"measure-definition-detail",components:{Dialog:S,MeasureDefinitionFilterList:la,MeasureDefinitionMetadataCard:ga,MeasureDefinitionQueryCard:Pa,MeasureDefinitionSubmitDialog:Ka,TabView:j,TabPanel:Y},props:{id:{type:String},ruleVersion:{type:String},clone:{type:String}},data(){return{metadataDefinitionTabViewDescriptor:R,rule:{definition:`SELECT

FROM

WHERE`,ruleOutputs:[],placeholders:[]},datasourcesList:[],availableAliasList:[],notAvailableAliasList:[],placeholdersList:[],domainsKpiRuleoutput:[],domainsTemporalLevel:[],domainsKpiMeasures:[],newAlias:[],reusedAlias:[],newPlaceholder:[],reusedPlaceholder:[],activeTab:0,columns:[],rows:[],errorMessage:null,errorTitle:null,tabChanged:!1,loading:!1,touched:!1,showSaveDialog:!1,operation:"create",queryChanged:!1,aliasesVisible:!1,placeholderVisible:!1,codeInput:null,preview:!1}},computed:{title(){return this.clone||this.id?this.rule.name:this.$t("kpi.measureDefinition.newMeasure")},metadataDisabled(){var e;let a=!1;return this.rule.dataSource||(a=!0),((e=this.rule.placeholders)==null?void 0:e.length)>0&&this.rule.placeholders.forEach(t=>{t.value||(a=!0)}),a},errorDialogVisible(){return!!this.errorMessage}},setup(){return{store:J()}},async created(){this.loading=!0,this.id&&this.ruleVersion&&await this.loadSelectedRule(),this.clone==="true"&&(this.rule.name=this.$t("common.copyOf")+" "+this.rule.name,delete this.rule.id),await this.loadDataSources();const a=this.datasourcesList.findIndex(e=>this.rule.dataSourceId===e.DATASOURCE_ID);a>-1&&(this.rule.dataSource=this.datasourcesList[a]),await this.loadAliases(),await this.loadPlaceholders(),await this.loadDomainsData(),this.loading=!1},methods:{async loadSelectedRule(){await this.$http.get(`/knowage/restful-services/1.0/kpi/${this.id}/${this.ruleVersion}/loadRule`).then(a=>this.rule=a.data)},async loadDataSources(){await this.$http.get("/knowage/restful-services/datasources/?onlySqlLike=true").then(a=>this.datasourcesList=a.data.root)},async loadAliases(){let a="/knowage/restful-services/1.0/kpi/listAvailableAlias";this.rule.id&&(a+=`?ruleId=${this.id}&ruleVersion=${this.ruleVersion}`),await this.$http.get(a).then(e=>{this.availableAliasList=e.data.available,this.notAvailableAliasList=e.data.notAvailable})},async loadPlaceholders(){await this.$http.get("/knowage/restful-services/1.0/kpi/listPlaceholder").then(a=>this.placeholdersList=a.data)},async loadDomainsData(){await this.loadDomainsByCode("KPI_RULEOUTPUT_TYPE").then(a=>this.domainsKpiRuleoutput=a.data),await this.loadDomainsByCode("TEMPORAL_LEVEL").then(a=>this.domainsTemporalLevel=a.data),await this.loadDomainsByCode("KPI_MEASURE_CATEGORY").then(a=>this.domainsKpiMeasures=a.data)},loadDomainsByCode(a){return this.$http.get(`/knowage/restful-services/2.0/domains/listByCode/${a}`)},async setTabChanged(a){this.activeTab=a,this.activeTab!==0&&await this.previewQuery(!1,!1,!0),this.rule.ruleOutputs.forEach(e=>{this.setAliasIcon(e),e.category||(e.category={valueCd:""})}),this.errorMessage&&(this.activeTab=0)},setNewAliases(){this.newAlias=[],this.reusedAlias=[],this.rule.ruleOutputs.forEach(a=>{this.aliasExists(a.alias)?this.reusedAlias.push(a.alias):this.newAlias.push(a.alias)}),this.newAlias.sort(),this.reusedAlias.sort()},setNewPlaceholders(){this.newPlaceholder=[],this.reusedPlaceholder=[],this.rule.placeholders.forEach(a=>{this.placeholderExists(a.name)?this.reusedPlaceholder.push(a.name):this.newPlaceholder.push(a.name)}),this.newPlaceholder.sort(),this.reusedPlaceholder.sort()},placeholderExists(a){let e=!1;return this.placeholdersList.forEach(t=>{t.name.toUpperCase()===a.toUpperCase()&&(e=!0)}),e},setAliasIcon(a){!this.aliasExists(a.alias)&&!this.aliasUsedByMeasure(a.alias)&&(a.aliasIcon="fa fa-exclamation-triangle icon-missing"),this.aliasUsedByMeasure(a.alias)&&(a.aliasIcon="fa fa-exclamation-triangle icon-used")},aliasExists(a){let e=!1;return this.availableAliasList.forEach(t=>{t.name.toUpperCase()===a.toUpperCase()&&(e=!0)}),e},aliasUsedByMeasure(a){let e=!1;return this.notAvailableAliasList.forEach(t=>{t.name.toUpperCase()===a.toUpperCase()&&(e=!0)}),e},async previewQuery(a,e,t){this.loading=!0,this.activeTab===0&&t&&(this.preview=!0);const b=this.rule.ruleOutputs;this.rule.ruleOutputs.forEach(f=>{var d;delete f.aliasIcon,f.category={valueCd:(d=f.category)==null?void 0:d.valueCd}});const p=this.rule.dataSource;if(this.rule.dataSource&&(this.rule.dataSourceId=this.rule.dataSource.DATASOURCE_ID),delete this.rule.dataSource,this.rule.definition&&this.loadPlaceholder(),this.rule.placeholders&&this.rule.placeholders.length===0||e){const f={rule:this.rule,maxItem:10};await this.$http.post("/knowage/restful-services/1.0/kpi/queryPreview",f,{headers:{"X-Disable-Errors":"true"}}).then(d=>{this.columns=d.data.columns,this.rows=d.data.rows,this.columnToRuleOutputs()}).catch(d=>{this.setPreviewError(d.message)})}this.setNewAliases(),this.setNewPlaceholders(),a&&!this.errorMessage&&await this.preSaveRule(),this.rule.dataSource=p,this.rule.ruleOutputs=b,this.loading=!1},setPreviewError(a){this.errorTitle=this.$t("kpi.measureDefinition.metadataError")+" "+this.$t("kpi.measureDefinition.wrongQuery"),this.errorMessage=a,this.rows=[]},async preSaveRule(){this.loading=!0;const a=this.rule.dataSource,e=this.rule.ruleOutputs;delete this.rule.dataSource,this.rule.ruleOutputs.forEach(t=>{var b;delete t.aliasIcon,t.category={valueCd:(b=t.category)==null?void 0:b.valueCd}}),await this.$http.post("/knowage/restful-services/1.0/kpi/preSaveRule",this.rule,{headers:{"X-Disable-Errors":"true"}}).then(()=>{this.rule.ruleOutputs.length===0&&(this.errorTitle=this.$t("kpi.measureDefinition.presaveErrors.metadataMissing"),this.errorMessage=this.$t("kpi.measureDefinition.presaveErrors.metadataMissingText"));let t=!1;this.rule.ruleOutputs.forEach(b=>{b.type.valueCd==="TEMPORAL_ATTRIBUTE"&&b.hierarchy===null?(this.errorTitle=this.$t("kpi.measureDefinition.presaveErrors.noTemporalattributSet"),this.errorMessage=this.$t("kpi.measureDefinition.presaveErrors.missingTemporalattributText")):b.type.valueCd==="MEASURE"&&(t=!0)}),t||(this.errorTitle=this.$t("kpi.measureDefinition.presaveErrors.noMeasureSet"),this.errorMessage=this.$t("kpi.measureDefinition.presaveErrors.metadataMissingText")),this.errorMessage||(this.showSaveDialog=!0)}).catch(t=>{this.errorTitle=this.$t("kpi.measureDefinition.metadataError")+" "+this.$t("kpi.measureDefinition.wrongQuery"),this.errorMessage=t.message}),this.rule.dataSource=a,this.rule.ruleOutputs=e,this.loading=!1},async saveRule(a){this.loading=!0,this.rule.name=a,this.rule.id&&(this.operation="update"),delete this.rule.dataSource,this.rule.ruleOutputs.forEach(e=>{var t;delete e.aliasIcon,e.category={valueCd:(t=e.category)==null?void 0:t.valueCd}}),delete this.rule.dataSource,await this.$http.post("/knowage/restful-services/1.0/kpi/saveRule",this.rule).then(()=>{this.store.setInfo({title:this.$t("common.toast."+this.operation+"Title"),msg:this.$t("common.toast.success")}),this.$router.replace("/measure-definition")}).catch(e=>{this.store.setError({title:this.$t("common.toast."+this.operation+"Title"),msg:e.message})}),this.loading=!1},columnToRuleOutputs(){const a=[];for(let e in this.columns)if(a.push(this.columns[e].label.toUpperCase()),this.ruleOutputIndexOfColumnName(this.columns[e].label)===-1){let t=this.domainsKpiRuleoutput[1];(this.columns[e].type==="int"||this.columns[e].type=="float")&&(t=this.domainsKpiRuleoutput[0]),this.rule.ruleOutputs.push({alias:this.columns[e].label,type:t})}for(let e=0;e<this.rule.ruleOutputs.length;e++)a.indexOf(this.rule.ruleOutputs[e].alias.toUpperCase())===-1&&(this.rule.ruleOutputs.splice(e,1),e--)},ruleOutputIndexOfColumnName(a){for(let e=0;e<this.rule.ruleOutputs.length;e++)if(this.rule.ruleOutputs[e].alias.toUpperCase()===a.toUpperCase())return e;return-1},loadPlaceholder(){const a=this.rule.definition.match(/@\w*/g);if(a!=null)for(let e=0;e<a.length;e++){const t=a[e].substring(1,a[e].length);let b=this.rule.placeholders.find(p=>p.name.toUpperCase()===t.toUpperCase());if(!b)if(b=this.placeholdersList.find(p=>p.name.toUpperCase()===t.toUpperCase()),b==null){const p={name:t,value:""};this.rule.placeholders.push(p)}else this.rule.placeholders.push(b);for(let p=0;p<this.rule.placeholders.length;p++)a.indexOf("@"+this.rule.placeholders[p].name)==-1&&(this.rule.placeholders.splice(p,1),p--)}else this.rule.placeholders=[]},submitConfirm(){this.queryChanged?this.$confirm.require({message:this.$t("kpi.measureDefinition.metadataChangedMessage"),header:this.$t("kpi.measureDefinition.metadataChangedTitle"),icon:"pi pi-exclamation-triangle",accept:()=>{this.queryChanged=!1,this.previewQuery(!0,!1,!1)}}):this.previewQuery(!0,!1,!1)},closeErrorMessageDialog(){this.errorMessage=null},closeTemplate(){const a="/measure-definition";this.touched?this.$confirm.require({message:this.$t("common.toast.unsavedChangesMessage"),header:this.$t("common.toast.unsavedChangesHeader"),icon:"pi pi-exclamation-triangle",accept:()=>{this.touched=!1,this.$router.push(a)}}):this.$router.push(a)},setCodeInput(a){this.activeTab===0&&(this.codeInput=a.type==="placeholder"?"@"+a.value:a.value)},sortArray(a,e){this[e]==="DESC"?(a=a.sort((t,b)=>t.name>b.name?1:-1),this[e]="ASC"):(a=a.sort((t,b)=>t.name<b.name?1:-1),this[e]="DESC")},setTouched(){this.touched=!0}}}),Ya={class:"kn-page"},Ja={class:"p-d-flex p-flex-row kn-page-content"},Ga={key:0,class:"card kn-flex"},Ha={key:1,class:"listbox p-d-flex p-flex-column"},Za={key:2,class:"listbox p-d-flex p-flex-column"};function Wa(a,e,t,b,p,f){const d=s("Button"),h=s("Toolbar"),u=s("ProgressBar"),y=s("MeasureDefinitionQueryCard"),M=s("TabPanel"),n=s("MeasureDefinitionMetadataCard"),o=s("TabView"),z=s("MeasureDefinitionFilterList"),N=s("MeasureDefinitionSubmitDialog"),B=s("Dialog");return r(),v(A,null,[c("div",Ya,[l(h,{class:"kn-toolbar kn-toolbar--primary p-m-0"},{start:i(()=>[C(k(a.title),1)]),end:i(()=>[l(d,{class:"p-button-text p-button-rounded kn-button",label:a.$t("kpi.measureDefinition.alias"),onClick:e[0]||(e[0]=w=>a.aliasesVisible=!a.aliasesVisible),"data-test":"submit-button"},null,8,["label"]),l(d,{class:"p-button-text p-button-rounded kn-button",label:a.$t("kpi.measureDefinition.placeholder"),onClick:e[1]||(e[1]=w=>a.placeholderVisible=!a.placeholderVisible),"data-test":"submit-button"},null,8,["label"]),l(d,{icon:"pi pi-save",class:"p-button-text p-button-rounded p-button-plain",disabled:a.metadataDisabled,onClick:a.submitConfirm,"data-test":"submit-button"},null,8,["disabled","onClick"]),l(d,{icon:"pi pi-times",class:"p-button-text p-button-rounded p-button-plain",onClick:a.closeTemplate,"data-test":"close-button"},null,8,["onClick"])]),_:1}),a.loading?(r(),x(u,{key:0,mode:"indeterminate",class:"kn-progress-bar"})):g("",!0),c("div",Ja,[a.loading?g("",!0):(r(),v("div",Ga,[l(o,{activeIndex:a.activeTab,"onUpdate:activeIndex":e[5]||(e[5]=w=>a.activeTab=w),onTabChange:e[6]||(e[6]=w=>a.setTabChanged(w.index))},{default:i(()=>[l(M,null,{header:i(()=>[c("span",null,k(a.$t("kpi.measureDefinition.query")),1)]),default:i(()=>[l(y,{rule:a.rule,datasourcesList:a.datasourcesList,aliases:a.availableAliasList,placeholders:a.placeholdersList,columns:a.columns,rows:a.rows,codeInput:a.codeInput,preview:a.preview,activeTab:a.activeTab,onQueryChanged:e[2]||(e[2]=w=>a.queryChanged=!0),onLoadPreview:e[3]||(e[3]=w=>a.previewQuery(!1,!0,!0)),onClosePreview:e[4]||(e[4]=w=>a.preview=!1)},null,8,["rule","datasourcesList","aliases","placeholders","columns","rows","codeInput","preview","activeTab"])]),_:1}),l(M,{disabled:a.metadataDisabled},{header:i(()=>[c("span",null,k(a.$t("kpi.measureDefinition.metadata")),1)]),default:i(()=>[l(n,{currentRule:a.rule,tipologiesType:a.domainsKpiRuleoutput,domainsTemporalLevel:a.domainsTemporalLevel,categories:a.domainsKpiMeasures,onTouched:a.setTouched},null,8,["currentRule","tipologiesType","domainsTemporalLevel","categories","onTouched"])]),_:1},8,["disabled"])]),_:1},8,["activeIndex"])])),a.aliasesVisible?(r(),v("div",Ha,[l(z,{header:a.$t("kpi.measureDefinition.alias"),list:a.availableAliasList,listType:"alias",onSelected:e[7]||(e[7]=w=>a.setCodeInput(w))},null,8,["header","list"])])):g("",!0),a.placeholderVisible?(r(),v("div",Za,[l(z,{header:a.$t("kpi.measureDefinition.placeholder"),list:a.placeholdersList,listType:"placeholder",onSelected:e[8]||(e[8]=w=>a.setCodeInput(w))},null,8,["header","list"])])):g("",!0)])]),a.showSaveDialog?(r(),x(N,{key:0,ruleName:a.rule.name,newAlias:a.newAlias,reusedAlias:a.reusedAlias,newPlaceholder:a.newPlaceholder,reusedPlaceholder:a.reusedPlaceholder,onClose:e[9]||(e[9]=w=>a.showSaveDialog=!1),onSave:e[10]||(e[10]=w=>a.saveRule(w))},null,8,["ruleName","newAlias","reusedAlias","newPlaceholder","reusedPlaceholder"])):g("",!0),l(B,{autoZIndex:!1,style:T(a.metadataDefinitionTabViewDescriptor.errorDialog.style),contentStyle:a.metadataDefinitionTabViewDescriptor.errorDialog.contentStyle,modal:!0,visible:a.errorDialogVisible,header:a.errorTitle,class:"p-fluid kn-dialog--toolbar--primary error-dialog",closable:!1},{footer:i(()=>[l(d,{class:"kn-button kn-button--secondary",label:a.$t("common.close"),onClick:a.closeErrorMessageDialog},null,8,["label","onClick"])]),default:i(()=>[c("p",null,k(a.errorMessage),1)]),_:1},8,["style","contentStyle","visible","header"])],64)}var oe=$(ja,[["render",Wa],["__scopeId","data-v-b45bffa2"]]);export{oe as default};
//# sourceMappingURL=MeasureDefinitionTabView-31bb414d.js.map
