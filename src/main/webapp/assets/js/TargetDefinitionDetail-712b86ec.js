import{K as U,u as E,c as L}from"./KnValidatonMessages-ebe48c72.js";import{d as $,n as N,l as _,i as P,x as D,W as B,_ as C,r as l,o as c,h as b,w as s,f as i,g as k,t as d,a as n,c as v,C as q,B as S,D as F,K as M,G as I,A as O,aE as j,s as H}from"./index-1e676509.js";import{f as y}from"./filterHelper-a723991a.js";import{s as G}from"./autocomplete.esm-bebdfcbd.js";import{s as R}from"./calendar.esm-60a451ba.js";const z=[{dateField:!1,field:"kpiName",header:"kpi.targetDefinition.kpiName"},{dateField:!1,field:"kpiCategory",header:"kpi.targetDefinition.kpiCategory"},{dateField:!0,field:"kpiDate",header:"kpi.targetDefinition.kpiDate"},{dateField:!1,field:"kpiAuthor",header:"kpi.targetDefinition.kpiAuthor"}],W={breakpoints:{"640px":"100vw","960px":"85vw"},contentStyle:{height:"80vh"},scrollHeight:"80vh",style:{width:"70vw"}},Y=["kpiName","kpiCategory","kpiDate","kpiAuthor"],J={insert:{toastTitle:"common.toast.createTitle"},success:"common.toast.success",update:{toastTitle:"common.toast.updateTitle"}},Q={column:{style:{width:"45%","word-break":"break-all"}},iconColumn:{style:{"text-align":"end",width:"5%"}}};var w={columnsAllKPI:z,dialog:W,globalFilterFields:Y,operation:J,table:Q};const X={target:[{fieldName:"name",validators:[{key:"required"},{key:"regex",validator:{type:"extendedAlphanumericRegex"}}]},{fieldName:"startValidity",validators:[{key:"required"}]},{fieldName:"endValidity",validators:[{key:"required"},{key:"is_after_date",validator:{type:"is-after-date"}}]}]};var A={validations:X};const Z=$({name:"add-kpi-dialog",components:{DataTable:N,Column:_,Dialog:P},props:{dialogVisible:{type:Boolean,default:!1},kpi:{type:Array,required:!1},loadingKpi:{type:Boolean,default:!1}},emits:["close","add"],data(){return{selectedKpi:[],targetDefinitionDetailDescriptor:w,filters:{global:[y],kpiName:{operator:D.AND,constraints:[y]},kpiCategory:{operator:D.AND,constraints:[y]},domainCode:{operator:D.AND,constraints:[y]},kpiDate:{operator:D.AND,constraints:[y]},kpiAuthor:{operator:D.AND,constraints:[y]}},formatDate:B}},methods:{addKpi(){this.$emit("add",this.selectedKpi),this.selectedKpi=[]},closeKpiDialog(){this.$emit("close")}}}),x={class:"table-header"},ee={class:"p-input-icon-left"},te=n("i",{class:"pi pi-search"},null,-1),ae={key:0},ie={key:1};function oe(e,t,a,V,K,T){const g=l("Button"),p=l("Toolbar"),u=l("InputText"),m=l("Column"),h=l("DataTable"),o=l("Dialog");return c(),b(o,{header:e.$t("kpi.targetDefinition.addKpiBtn"),breakpoints:e.targetDefinitionDetailDescriptor.dialog.breakpoints,style:F(e.targetDefinitionDetailDescriptor.dialog.style),contentStyle:e.targetDefinitionDetailDescriptor.dialog.contentStyle,visible:e.dialogVisible,modal:!0,closable:!1,class:"p-fluid kn-dialog--toolbar--primary"},{header:s(()=>[i(p,{class:"kn-toolbar kn-toolbar--primary p-p-0 p-m-0 p-col-12"},{start:s(()=>[k(d(e.$t("kpi.targetDefinition.addKpiBtn")),1)]),end:s(()=>[i(g,{icon:"pi pi-save",class:"kn-button p-button-text p-button-rounded",onClick:e.addKpi},null,8,["onClick"]),i(g,{icon:"pi pi-times",class:"kn-button p-button-text p-button-rounded",onClick:e.closeKpiDialog},null,8,["onClick"])]),_:1})]),default:s(()=>[i(h,{paginator:!0,rows:15,rowsPerPageOptions:[10,15,20],selection:e.selectedKpi,"onUpdate:selection":t[1]||(t[1]=r=>e.selectedKpi=r),value:e.kpi,loading:e.loadingKpi,class:"p-datatable-sm kn-table",dataKey:"kpiId",responsiveLayout:"stack",filters:e.filters,"onUpdate:filters":t[2]||(t[2]=r=>e.filters=r),filterDisplay:"menu",scrollable:!0,scrollHeight:e.targetDefinitionDetailDescriptor.dialog.scrollHeight,globalFilterFields:e.targetDefinitionDetailDescriptor.globalFilterFields},{header:s(()=>[n("div",x,[n("span",ee,[te,i(u,{class:"kn-material-input",type:"text",modelValue:e.filters.global.value,"onUpdate:modelValue":t[0]||(t[0]=r=>e.filters.global.value=r),placeholder:e.$t("common.search"),badge:"0","data-test":"search-input"},null,8,["modelValue","placeholder"])])])]),empty:s(()=>[k(d(e.$t("common.info.noDataFound")),1)]),loading:s(()=>[k(d(e.$t("common.info.dataLoading")),1)]),default:s(()=>[i(m,{selectionMode:"multiple",headerStyle:"width: 3rem"}),(c(!0),v(S,null,q(e.targetDefinitionDetailDescriptor.columnsAllKPI,r=>(c(),b(m,{field:r.field,header:e.$t(r.header),key:r.field,sortable:!0,class:"kn-truncated"},{body:s(f=>[r.dateField?(c(),v("span",ie,d(e.formatDate(f.data[f.column.props.field])),1)):(c(),v("span",ae,d(f.data[f.column.props.field]),1))]),_:2},1032,["field","header"]))),128))]),_:1},8,["selection","value","loading","filters","scrollHeight","globalFilterFields"])]),_:1},8,["header","breakpoints","style","contentStyle","visible"])}var le=C(Z,[["render",oe]]);const ne=$({name:"target-definition-form",components:{AutoComplete:G,Calendar:R,KnValidationMessages:U},props:{selectedTarget:{type:Object},categories:{type:Array},vcomp:Object},emits:["touched","valueChanged"],watch:{selectedTarget(){this.target={...this.selectedTarget}},categories(){this.loadCategories()}},data(){return{target:{},filteredCategory:[]}},created(){this.loadCategories()},methods:{loadCategories(){this.filteredCategory=[...this.categories]},valueChanged(e,t){this.$emit("valueChanged",{fieldName:e,value:t})},searchCategory(e){setTimeout(()=>{var t;e.query.trim().length?this.filteredCategory=(t=this.categories)==null?void 0:t.filter(a=>a.valueName&&a.valueName.toLowerCase().startsWith(e.query.toLowerCase())):this.filteredCategory=[...this.categories]},250)}}}),se={key:0,class:"p-fluid p-m-5"},re={class:"p-field"},de={class:"p-float-label"},pe={for:"name",class:"kn-material-input-label"},ge={class:"p-my-4"},ue={class:"p-float-label"},me={for:"category",class:"kn-material-input-label"},ce={class:"kn-flex"},he={class:"p-d-flex p-jc-between"},fe={class:"p-float-label"},ke={for:"startDate",class:"kn-material-input-label"},ye={class:"p-d-flex"},De={class:"p-float-label"},ve={for:"endDate",class:"kn-material-input-label"};function be(e,t,a,V,K,T){const g=l("InputText"),p=l("KnValidationMessages"),u=l("AutoComplete"),m=l("Calendar"),h=l("Card");return c(),b(h,null,{content:s(()=>[e.target?(c(),v("form",se,[n("div",re,[n("span",de,[i(g,M(e.$attrs,{id:"name",class:["kn-material-input",{"p-invalid":e.vcomp.name.$invalid&&e.vcomp.name.$dirty}],type:"text",maxLength:"100",modelValue:e.target.name,"onUpdate:modelValue":t[0]||(t[0]=o=>e.target.name=o),onInput:t[1]||(t[1]=o=>e.valueChanged("name",o.target.value)),onBlur:t[2]||(t[2]=o=>e.vcomp.name.$touch())}),null,16,["modelValue","class"]),n("label",pe,d(e.$t("kpi.targetDefinition.name"))+" * ",1)]),i(p,{vComp:e.vcomp.name,additionalTranslateParams:{fieldName:e.$t("kpi.targetDefinition.name")}},null,8,["vComp","additionalTranslateParams"])]),n("div",ge,[n("span",ue,[i(u,{id:"category",modelValue:e.target.category,"onUpdate:modelValue":t[3]||(t[3]=o=>e.target.category=o),suggestions:e.filteredCategory,onComplete:t[4]||(t[4]=o=>e.searchCategory(o)),field:"valueName",onInput:t[5]||(t[5]=o=>e.valueChanged("category",o.target.value)),onItemSelect:t[6]||(t[6]=o=>e.valueChanged("category",o.value))},null,8,["modelValue","suggestions"]),n("label",me,d(e.$t("kpi.targetDefinition.kpiCategory")),1)])]),n("div",ce,[n("div",he,[n("div",null,[n("span",fe,[i(m,{id:"startDate",class:I(["kn-material-input",{"p-invalid":e.vcomp.startValidity.$invalid&&e.vcomp.startValidity.$dirty}]),modelValue:e.target.startValidity,"onUpdate:modelValue":t[7]||(t[7]=o=>e.target.startValidity=o),onDateSelect:t[8]||(t[8]=o=>e.valueChanged("startValidity",o)),showIcon:!0,manualInput:!1,onBlur:t[9]||(t[9]=o=>e.vcomp.startValidity.$touch())},null,8,["modelValue","class"]),n("label",ke,d(e.$t("kpi.targetDefinition.startDate"))+" * ",1)]),i(p,{vComp:e.vcomp.startValidity,additionalTranslateParams:{fieldName:e.$t("kpi.targetDefinition.startDate")}},null,8,["vComp","additionalTranslateParams"])]),n("div",ye,[n("div",null,[n("span",De,[i(m,{id:"endDate",class:I(["kn-material-input",{"p-invalid":e.vcomp.endValidity.$invalid&&e.vcomp.endValidity.$dirty}]),modelValue:e.target.endValidity,"onUpdate:modelValue":t[10]||(t[10]=o=>e.target.endValidity=o),onDateSelect:t[11]||(t[11]=o=>e.valueChanged("endValidity",o)),showIcon:!0,manualInput:!1,onBlur:t[12]||(t[12]=o=>e.vcomp.endValidity.$touch())},null,8,["modelValue","class"]),n("label",ve,d(e.$t("kpi.targetDefinition.endDate"))+" * ",1)]),i(p,{vComp:e.vcomp.endValidity,additionalTranslateParams:{fieldName:e.$t("kpi.targetDefinition.endDate")},specificTranslateKeys:{is_after_date:"kpi.targetDefinition.endDateBeforeStart"}},null,8,["vComp","additionalTranslateParams","specificTranslateKeys"])])])])])])):O("",!0)]),_:1})}var $e=C(ne,[["render",be]]);const Ce=$({name:"apply-target-card",components:{DataTable:N,Column:_,InputNumber:j},props:{loadingKpi:{type:Boolean,default:!1},kpi:{type:Array,required:!0}},data(){return{selectedKpi:[],targetDefinitionDetailDecriptor:w}},watch:{kpi(){this.selectedKpi=this.kpi}},methods:{addKpiDialog(){this.$emit("showDialog")},deleteKpi(e){const t=this.selectedKpi.findIndex(a=>a.kpiId===e.kpiId);t>=0&&(this.selectedKpi.splice(t,1),this.$emit("kpiChanged",this.selectedKpi))}}}),Ve={class:"p-d-inline-flex"};function Ke(e,t,a,V,K,T){const g=l("Toolbar"),p=l("Button"),u=l("Column"),m=l("InputNumber"),h=l("DataTable"),o=l("Card");return c(),b(o,null,{header:s(()=>[i(g,{class:"kn-toolbar kn-toolbar--secondary"},{start:s(()=>[k(d(e.$t("kpi.targetDefinition.applyTargetonKPI")),1)]),_:1})]),footer:s(()=>[n("div",Ve,[i(p,{class:"kn-button kn-button--secondary",onClick:t[0]||(t[0]=r=>e.addKpiDialog())},{default:s(()=>[k(d(e.$t("kpi.targetDefinition.addKpiBtn")),1)]),_:1})])]),content:s(()=>[i(h,{value:e.selectedKpi,loading:e.loadingKpi,class:"editable-cells-table",dataKey:"id",responsiveLayout:"stack",breakpoint:"960px","data-test":"selected-kpi-table"},{empty:s(()=>[k(d(e.$t("common.info.noElementSelected")),1)]),loading:s(()=>[k(d(e.$t("common.info.dataLoading")),1)]),default:s(()=>[i(u,{field:"kpiName",header:e.$t("kpi.targetDefinition.kpiName"),key:"kpiName",sortable:!0,class:"kn-truncated",headerStyle:e.targetDefinitionDetailDecriptor.table.column.style},null,8,["header","headerStyle"]),i(u,{field:"value",header:e.$t("kpi.targetDefinition.kpiValue"),key:"value",sortable:!0,class:"kn-truncated",headerStyle:e.targetDefinitionDetailDecriptor.table.column.style},{body:s(r=>[i(m,{modelValue:r.data[r.column.props.field],"onUpdate:modelValue":f=>r.data[r.column.props.field]=f,showButtons:"",mode:"decimal",minFractionDigits:2},null,8,["modelValue","onUpdate:modelValue"])]),_:1},8,["header","headerStyle"]),i(u,{headerStyle:"targetDefinitionDetailDecriptor.table.iconColumn.style",style:F(e.targetDefinitionDetailDecriptor.table.iconColumn.style)},{body:s(r=>[i(p,{icon:"pi pi-trash",class:"p-button-link",onClick:f=>e.deleteKpi(r.data)},null,8,["onClick"])]),_:1},8,["style"])]),_:1},8,["value","loading"])]),_:1})}var Te=C(Ce,[["render",Ke],["__scopeId","data-v-27927ad2"]]);const we=$({name:"target-definition-detail",components:{AddKpiDialog:le,TargetDefinitionForm:$e,ApplyTargetCard:Te},props:{id:{type:String},clone:{type:String}},data(){return{target:{},formatDate:B,targetDefinitionDetailDecriptor:w,targetDefinitionValidationDescriptor:A,kpi:[],filteredKpi:[],categories:[],loading:!1,loadingAllKpi:!1,kpiDialogVisible:!1,categoryDialogVisiable:!1,v$:E()}},validations(){const e={"is-after-date":()=>this.target&&this.target.startValidity&&this.target.endValidity&&this.target.startValidity<this.target.endValidity};return{target:L("target",A.validations.target,e)}},computed:{buttonDisabled(){return this.v$.$invalid||this.kpi.length<1}},setup(){return{store:H()}},async created(){this.id&&this.loadTarget(),await this.loadCategory()},watch:{async id(){await this.checkId()},async clone(){await this.checkId()}},methods:{updateTarget(e){this.target[e.fieldName]=e.value,this.setDirty()},updateKpi(e){this.kpi=[...e],this.setDirty()},async loadTarget(){this.loading=!0,await this.$http.get("/knowage/restful-services/1.0/kpiee/"+this.id+"/loadTarget").then(e=>{this.target={id:this.clone=="true"?null:e.data.id,name:this.clone=="true"?"Copy of "+e.data.name:e.data.name,startValidity:new Date(e.data.startValidity),endValidity:new Date(e.data.endValidity),author:e.data.author,category:e.data.category},this.kpi=e.data.values.map(t=>{var a;return{kpiId:t.kpiId,kpiName:t.kpi.name,kpiVersion:t.kpiVersion,kpiCategory:(a=t.kpi.category)==null?void 0:a.valueName,kpiDate:new Date(t.kpi.dateCreation),kpiAuthor:t.kpi.author,value:t.value,targetId:t.targetId}})}).finally(()=>this.loading=!1)},async loadKpi(){this.loadingAllKpi=!0,this.filteredKpi=[],await this.$http.get("/knowage/restful-services/1.0/kpi/listKpi").then(e=>this.filteredKpi=e.data.filter(t=>!this.kpi||this.kpi.findIndex(a=>a.kpiId===t.id)<0).map(t=>{var a;return{kpiId:t.id,kpiName:t.name,kpiVersion:t.version,kpiCategory:(a=t.category)==null?void 0:a.valueName,kpiDate:new Date(t.dateCreation),kpiAuthor:t.author,targetId:this.target.id,value:0}})).finally(()=>this.loadingAllKpi=!1)},async loadCategory(){await this.$http.get("/knowage/restful-services/2.0/domains/listByCode/KPI_TARGET_CATEGORY").then(e=>this.categories=e.data)},async saveTemplate(){this.kpi.length<1?this.store.setError({title:this.$t("kpi.targetDefinition.noKpi"),msg:this.$t("kpi.targetDefinition.noKpiMessage")}):this.v$.$invalid?this.v$.$touch():await this.handleSubmit()},async handleSubmit(){this.categoryDialogVisiable=!1;let e="/knowage/restful-services/1.0/kpiee/saveTarget";if(this.target.values=this.kpi.map(a=>({kpiId:a.kpiId,kpiVersion:a.kpiVersion,value:a.value,targetId:a.targetId})),typeof this.target.category!="object"){const a=this.target.category;this.target.category={valueCd:a}}let t=this.target.id?"update":"insert";await this.$http.post(e,this.target).then(a=>{a.data.errors!=null&&a.data.errors.length>0?(this.categoryDialogVisiable=!1,this.store.setError({title:this.$t("kpi.targetDefinition.savingError"),msg:a.data.errors[0].message})):(this.store.setInfo({title:this.$t(this.targetDefinitionDetailDecriptor.operation[t].toastTitle),msg:this.$t(this.targetDefinitionDetailDecriptor.operation.success)}),this.$emit("saved",a.data.id))})},closeTemplate(){this.$emit("close")},setDirty(){this.$emit("touched")},deleteKpi(e){this.kpi.splice(this.kpi.indexOf(e),1),this.setDirty()},addKpiDialog(){this.loadKpi(),this.kpiDialogVisible=!0},closeKpiDialog(){this.kpiDialogVisible=!1},addKpi(e){this.kpi=[...this.kpi,...e],this.kpiDialogVisible=!1,e.length>0&&(this.store.setInfo({title:this.$t("kpi.targetDefinition.kpiAddedTitile"),msg:this.$t("kpi.targetDefinition.kpiAddedMessage")}),this.setDirty())},async checkId(){this.id?await this.loadTarget():(this.target={},this.kpi=[]),this.v$.$reset()}}}),Ie={class:"p-grid p-m-0 p-fluid p-jc-center"},Ae={class:"p-col-9"};function Ne(e,t,a,V,K,T){const g=l("Button"),p=l("Toolbar"),u=l("target-definition-form"),m=l("apply-target-card"),h=l("add-kpi-dialog");return c(),v(S,null,[i(p,{class:"kn-toolbar kn-toolbar--secondary p-p-0 p-m-0"},{end:s(()=>[i(g,{icon:"pi pi-save",class:"kn-button p-button-text p-button-rounded",disabled:e.buttonDisabled,onClick:e.saveTemplate},null,8,["disabled","onClick"]),i(g,{class:"kn-button p-button-text p-button-rounded",icon:"pi pi-times",onClick:e.closeTemplate},null,8,["onClick"])]),_:1}),n("div",Ie,[n("div",Ae,[i(u,{selectedTarget:e.target,categories:e.categories,onValueChanged:e.updateTarget,vcomp:e.v$.target},null,8,["selectedTarget","categories","onValueChanged","vcomp"]),i(m,{kpi:e.kpi,onKpiChanged:e.updateKpi,onShowDialog:e.addKpiDialog},null,8,["kpi","onKpiChanged","onShowDialog"])])]),i(h,{kpi:e.filteredKpi,dialogVisible:e.kpiDialogVisible,loadingKpi:e.loadingAllKpi,onClose:e.closeKpiDialog,onAdd:e.addKpi},null,8,["kpi","dialogVisible","loadingKpi","onClose","onAdd"])],64)}var Ee=C(we,[["render",Ne]]);export{Ee as default};
//# sourceMappingURL=TargetDefinitionDetail-712b86ec.js.map
